{"ref_code":"R0EH54M","name":"rfvvf","description":"<!doctype html>\n<html lang=\"ar\" dir=\"rtl\">\n<head>\n<meta charset=\"utf-8\" />\n<meta name=\"viewport\" content=\"width=device-width,initial-scale=1\" />\n<title>لوحة الإدارة — Ads (static)</title>\n<link href=\"https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;700&display=swap\" rel=\"stylesheet\">\n<style>\n  *{font-family:\"Tajawal\",sans-serif}\n  body{margin:16px;background:#f4f6fa;color:#222}\n  .wrap{max-width:1200px;margin:0 auto}\n  .top{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:12px}\n  input,select,textarea{padding:10px;border:1px solid #ddd;border-radius:8px}\n  button{padding:10px;border-radius:8px;border:none;background:#0078d7;color:#fff;cursor:pointer}\n  .cols{display:grid;grid-template-columns:1fr 420px;gap:12px}\n  .panel{background:#fff;padding:12px;border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,0.06)}\n  .list{max-height:520px;overflow:auto}\n  .item{display:flex;gap:12px;border-bottom:1px solid #f0f0f0;padding:10px 0;align-items:center}\n  .thumb{width:96px;height:72px;object-fit:cover;border-radius:6px}\n  .meta{flex:1}\n  .actions{display:flex;gap:8px}\n  .muted{color:#666;font-size:13px}\n  .proposal{background:#fff;padding:10px;border-radius:8px;margin-bottom:8px;border:1px solid #eee}\n  pre{background:#f7f8fb;padding:8px;border-radius:6px;overflow:auto}\n  #logout{background:#d33}\n  #status{margin-left:8px;color:#666}\n  .field{margin-top:8px}\n  .detailRow{display:flex;gap:8px;align-items:center;margin-bottom:8px}\n  label.small{font-size:13px;color:#444}\n</style>\n</head>\n<body>\n<div class=\"wrap\">\n  <h2>لوحة الإدارة — الإعلانات (Static GitHub)</h2>\n\n  <div class=\"top\">\n    <input id=\"cfg_repo\" placeholder=\"owner/repo (مثال: user/repo)\" style=\"width:280px\">\n    <input id=\"cfg_branch\" placeholder=\"branch (main)\" style=\"width:100px\" value=\"main\">\n    <input id=\"cfg_pat\" placeholder=\"الصق GitHub PAT هنا (repo scope)\" style=\"width:360px\">\n    <label style=\"display:flex;align-items:center;gap:8px\"><input type=\"checkbox\" id=\"allowPublic\"> سماح للإرسال العام</label>\n    <button id=\"saveCfg\">حفظ</button>\n    <button id=\"logout\">مسح PAT</button>\n    <span id=\"status\" class=\"muted\"></span>\n  </div>\n\n  <div class=\"cols\">\n    <div>\n      <div class=\"panel\">\n        <h3>الإعلانات الحالية</h3>\n        <div id=\"adsList\" class=\"list\"><div class=\"muted\">أدخل repo وPAT ثم اضغط حفظ لبدء العمل</div></div>\n        <div style=\"margin-top:10px\"><button id=\"newBtn\">إضافة إعلان جديد</button></div>\n      </div>\n\n      <div class=\"panel\" style=\"margin-top:12px\">\n        <h3>مقترحات الزوار (proposals)</h3>\n        <div id=\"proposalsList\"><div class=\"muted\">أدخل repo وPAT ثم اضغط حفظ لبدء العمل</div></div>\n      </div>\n    </div>\n\n    <div>\n      <div class=\"panel\">\n        <h3>تفاصيل / معاينة</h3>\n        <div id=\"detail\">حدد عنصراً لعرض التفاصيل</div>\n      </div>\n    </div>\n  </div>\n</div>\n\n<!-- modal -->\n<div id=\"modal\" style=\"display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);align-items:center;justify-content:center\">\n  <div style=\"background:#fff;padding:14px;border-radius:10px;max-width:640px;width:100%\">\n    <h3 id=\"modalTitle\">إضافة / تعديل الإعلان</h3>\n    <div class=\"field\"><input id=\"m_code\" placeholder=\"الرمز (اتركه لتوليد تلقائي)\"></div>\n    <div class=\"field\"><input id=\"m_name\" placeholder=\"العنوان\"></div>\n    <div class=\"field\"><textarea id=\"m_desc\" placeholder=\"الوصف\" rows=\"3\"></textarea></div>\n    <div class=\"field\"><input id=\"m_loc\" placeholder=\"الموقع\"></div>\n    <div class=\"field\"><input id=\"m_contact\" placeholder=\"التواصل\"></div>\n    <div class=\"field\"><input id=\"m_cat\" placeholder=\"التصنيف\"></div>\n    <div class=\"field\"><label>صورة: <input id=\"m_file\" type=\"file\" accept=\"image/*\"></label></div>\n    <div style=\"margin-top:12px;text-align:right\">\n      <button id=\"saveBtn\">حفظ</button>\n      <button id=\"cancelBtn\" style=\"background:#999\">إلغاء</button>\n    </div>\n  </div>\n</div>\n\n<script>\n/* admin.js (fixed fast version) */\nconst CFG_KEY = 'static_ads_cfg_v1';\nfunction readCfg(){ try{ return JSON.parse(localStorage.getItem(CFG_KEY)||'{}') }catch(e){ return {} } }\nfunction saveCfgObj(o){ localStorage.setItem(CFG_KEY, JSON.stringify(o)); updateStatus('تم الحفظ') }\nfunction clearPAT(){ const c=readCfg(); delete c.pat; localStorage.setItem(CFG_KEY, JSON.stringify(c)); updateStatus('PAT محذوف'); setUiFromCfg(); }\nfunction updateStatus(s){ const el=document.getElementById('status'); el.textContent=s; setTimeout(()=>{ if(el.textContent===s) el.textContent=''; },4200) }\n\nfunction setUiFromCfg(){ const c=readCfg(); document.getElementById('cfg_repo').value=c.repo||''; document.getElementById('cfg_branch').value=c.branch||'main'; document.getElementById('cfg_pat').value=c.pat||''; document.getElementById('allowPublic').checked=!!c.allow_public_submissions }\nsetUiFromCfg();\n\nasync function ghRaw(repo,path,branch='main'){ const url=`https://raw.githubusercontent.com/${repo}/${branch}/${path}`; const r=await fetch(url); if(!r.ok) return null; return await r.text() }\nasync function ghApiGetWithPat(pat,repo,path,branch='main'){ const [owner,rname]=repo.split('/'); const url=`https://api.github.com/repos/${owner}/${rname}/contents/${encodeURIComponent(path)}?ref=${encodeURIComponent(branch)}`; return await fetch(url,{headers: pat?{Authorization:'token '+pat}:{}}) }\nasync function ghPut(pat,repo,path,base64content,message,branch='main',alreadyBase64=false){ const [owner,rname]=repo.split('/'); const url=`https://api.github.com/repos/${owner}/${rname}/contents/${encodeURIComponent(path)}`; const headers={Authorization:'token '+pat,Accept:'application/vnd.github.v3+json'}; let sha=null; try{ const meta=await ghApiGetWithPat(pat,repo,path,branch); if(meta.status===200){ const mj=await meta.json(); sha=mj.sha } }catch(e){} const body={message,content: alreadyBase64? base64content : btoa(unescape(encodeURIComponent(base64content))), branch}; if(sha) body.sha=sha; const res=await fetch(url,{method:'PUT',headers,body:JSON.stringify(body)}); const j=await res.json(); if(!res.ok) throw new Error('PUT failed: '+(j && j.message? j.message: JSON.stringify(j))); return j }\nasync function ghDelete(pat,repo,path,message,branch='main'){ const metaRes=await ghApiGetWithPat(pat,repo,path,branch); if(metaRes.status!==200) throw new Error('file not found'); const meta=await metaRes.json(); const [owner,rname]=repo.split('/'); const url=`https://api.github.com/repos/${owner}/${rname}/contents/${encodeURIComponent(path)}`; const res=await fetch(url,{method:'DELETE',headers:{Authorization:'token '+pat,Accept:'application/vnd.github.v3+json'},body:JSON.stringify({message,sha:meta.sha,branch})}); if(!res.ok) throw new Error('Delete failed: '+await res.text()); return await res.json() }\n\n/* validate config */\ndocument.getElementById('saveCfg').addEventListener('click', async ()=>{\n  const repo=document.getElementById('cfg_repo').value.trim(); const branch=document.getElementById('cfg_branch').value.trim()||'main'; const pat=document.getElementById('cfg_pat').value.trim(); const allow=document.getElementById('allowPublic').checked;\n  if(!repo) return alert('أدخل owner/repo'); if(!pat) return alert('الصق PAT');\n  updateStatus('جارٍ التحقق...');\n  try{\n    const res = await ghApiGetWithPat(pat,repo,'static/ads.json',branch);\n    if(res.status===200 || res.status===404){ saveCfgObj({repo,branch,pat,allow_public_submissions:allow}); setUiFromCfg(); loadAll(); }\n    else if(res.status===401||res.status===403){ updateStatus('PAT غير صالح أو لا يوجد إذن'); alert('PAT غير صالح أو لا يوجد إذن'); }\n    else { updateStatus('خطأ: '+res.status); alert('خطأ: '+res.status) }\n  }catch(e){ updateStatus('خطأ في التحقق'); alert('خطأ: '+e.message) }\n});\ndocument.getElementById('logout').addEventListener('click', ()=> { if(confirm('مسح PAT؟')) clearPAT() });\n\n/* load lists */\nconst adsList=document.getElementById('adsList'), proposalsList=document.getElementById('proposalsList'), detail=document.getElementById('detail');\nasync function loadAll(){ const cfg=readCfg(); if(!cfg.repo||!cfg.pat){ adsList.innerHTML='<div class=\"muted\">أدخل repo وPAT ثم اضغط حفظ</div>'; proposalsList.innerHTML='<div class=\"muted\">أدخل repo وPAT ثم اضغط حفظ</div>'; return } await loadAds(); await loadProposals(); }\nasync function loadAds(){ adsList.innerHTML='تحميل...'; const cfg=readCfg(); try{ const raw = await ghRaw(cfg.repo,'static/ads.json',cfg.branch||'main'); const arr = raw? JSON.parse(raw):[]; renderAds(arr) }catch(e){ adsList.innerHTML='<div class=\"muted\">فشل جلب ads.json</div>' } }\nfunction renderAds(items){ adsList.innerHTML=''; if(!items||items.length===0){ adsList.innerHTML='<div class=\"muted\">لا توجد إعلانات</div>'; return } items.forEach((a,idx)=>{ const el=document.createElement('div'); el.className='item'; el.innerHTML=`<img class=\"thumb\" src=\"${escapeAttr(a.thumb||a.image||'')}\" onerror=\"this.style.display='none'\"><div class=\"meta\"><strong>${escapeHtml(a.name||a.code||('ad'+idx))}</strong><div class=\"muted\">${escapeHtml(a.description||'')}</div></div><div class=\"actions\"><button class=\"editBtn\">تعديل</button><button class=\"delBtn\" style=\"background:#d33\">حذف</button></div>`; el.querySelector('.editBtn').onclick=()=> openEdit(a,idx); el.querySelector('.delBtn').onclick=()=> deleteAd(idx); adsList.appendChild(el) }) }\n\n/* proposals */\nasync function loadProposals(){ proposalsList.innerHTML='تحميل...'; const cfg=readCfg(); if(!cfg.repo||!cfg.pat){ proposalsList.innerHTML='<div class=\"muted\">حدد repo وPAT ثم اضغط حفظ</div>'; return } try{ const [owner,repoName]=cfg.repo.split('/'); const url=`https://api.github.com/repos/${owner}/${repoName}/contents/static/proposals?ref=${encodeURIComponent(cfg.branch||'main')}`; const res=await fetch(url,{headers:{Authorization:'token '+cfg.pat}}); if(res.status===404){ proposalsList.innerHTML='<div class=\"muted\">لا توجد مقترحات</div>'; return } if(!res.ok) throw new Error('list error '+res.status); const list=await res.json(); const jsonFiles=list.filter(f=>f.name.endsWith('.json')); proposalsList.innerHTML=''; for(const f of jsonFiles){ const raw=await fetch(f.download_url,{headers:{Authorization:'token '+cfg.pat}}).then(r=>r.json()).catch(()=>null); const item=raw||{}; const el=document.createElement('div'); el.className='proposal'; el.innerHTML=`<div style=\"display:flex;justify-content:space-between\"><div><strong>${escapeHtml(item.ref_code||f.name)}</strong></div><div class=\"muted\">${escapeHtml(item.created_at||'')}</div></div><div class=\"small\">${escapeHtml(item.description||'')}</div><div style=\"margin-top:8px\"><button class=\"viewBtn\">عرض وتحرير</button><button class=\"acceptBtn\" style=\"background:#2a9d8f\">قبول</button><button class=\"rejectBtn\" style=\"background:#d33\">رفض</button></div>`; el.querySelector('.viewBtn').onclick=()=> showProposalDetail(item,f.name); el.querySelector('.acceptBtn').onclick=()=> showAcceptModal(item,f.name); el.querySelector('.rejectBtn').onclick=async ()=>{ if(!confirm('رفض المقترح وحذفه؟')) return; try{ await deleteProposal(cfg,f.name); alert('تم الحذف'); loadAll(); }catch(e){ alert('خطأ: '+e.message) } }; proposalsList.appendChild(el) } if(jsonFiles.length===0) proposalsList.innerHTML='<div class=\"muted\">لا توجد مقترحات</div>'; }catch(e){ proposalsList.innerHTML='<div class=\"muted\">فشل جلب المقترحات</div>' } }\n\n/* show/edit proposal */\nfunction showProposalDetail(item,filename){ const cfg=readCfg(); const repo=cfg.repo; const branch=cfg.branch||'main'; let imgHtml=''; if(item.image){ let imgPath=item.image;if(imgPath.startsWith('/')) imgPath=imgPath.replace(/^\\//,''); if(!imgPath.startsWith('http')) imgHtml=`<div style=\"margin-bottom:8px\"><img src=\"https://raw.githubusercontent.com/${repo}/${branch}/${imgPath}\" style=\"max-width:100%;border-radius:8px\"></div>`; else imgHtml=`<div style=\"margin-bottom:8px\"><img src=\"${item.image}\" style=\"max-width:100%;border-radius:8px\"></div>` } detail.innerHTML=`${imgHtml}<div class=\"detailRow\"><label class=\"small\">الرمز</label><input id=\"p_code\" value=\"${escapeAttr(item.ref_code||item.code||'')}\" style=\"flex:1\"></div><div class=\"detailRow\"><label class=\"small\">العنوان</label><input id=\"p_name\" value=\"${escapeAttr(item.name||'')}\" style=\"flex:1\"></div><div class=\"detailRow\"><label class=\"small\">الوصف</label><textarea id=\"p_desc\" rows=\"3\" style=\"flex:1\">${escapeAttr(item.description||'')}</textarea></div><div class=\"detailRow\"><label class=\"small\">الموقع</label><input id=\"p_loc\" value=\"${escapeAttr(item.location||'')}\" style=\"flex:1\"></div><div class=\"detailRow\"><label class=\"small\">التواصل</label><input id=\"p_contact\" value=\"${escapeAttr(item.contact||'')}\" style=\"flex:1\"></div><div class=\"detailRow\"><label class=\"small\">التصنيف</label><input id=\"p_cat\" value=\"${escapeAttr(item.category||'')}\" style=\"flex:1\"></div><div class=\"detailRow\"><label class=\"small\">تغيير الصورة</label><input id=\"p_file\" type=\"file\" accept=\"image/*\"></div><div style=\"display:flex;gap:8px;margin-top:8px;justify-content:flex-end\"><button id=\"saveProposalBtn\">تعديل وحفظ</button><button id=\"acceptProposalBtn\" style=\"background:#2a9d8f\">قبول وتضمين</button><button id=\"deleteProposalBtn\" style=\"background:#d33\">رفض وحذف</button></div>`; document.getElementById('saveProposalBtn').onclick=async ()=>{ try{ const updated=await buildProposalFromDetail(item); await updateProposalFile(readCfg(),filename,updated); alert('تم تعديل المقترح'); loadAll(); }catch(e){ alert('خطأ: '+e.message) } }; document.getElementById('acceptProposalBtn').onclick=()=> showAcceptModal(item,filename); document.getElementById('deleteProposalBtn').onclick=async ()=>{ if(!confirm('رفض المقترح وحذفه؟')) return; try{ await deleteProposal(readCfg(),filename); alert('تم الحذف'); loadAll(); }catch(e){ alert('خطأ: '+e.message) } } }\n\n/* helpers for proposal edits and upload */\nasync function buildProposalFromDetail(originalItem){ const cfg=readCfg(); const pat=cfg.pat; const repo=cfg.repo; const branch=cfg.branch||'main'; const updated=Object.assign({},originalItem); updated.ref_code=document.getElementById('p_code').value.trim()||updated.ref_code||('p'+Date.now().toString(36)); updated.name=document.getElementById('p_name').value.trim(); updated.description=document.getElementById('p_desc').value.trim(); updated.location=document.getElementById('p_loc').value.trim(); updated.contact=document.getElementById('p_contact').value.trim(); updated.category=document.getElementById('p_cat').value.trim(); updated.created_at=updated.created_at||new Date().toISOString(); const file=document.getElementById('p_file').files[0]; if(file){ if(!pat||!repo) throw new Error('PAT و repo مطلوبان'); const imgName=`${updated.ref_code}-${file.name.replace(/[^a-z0-9.\\-_]/ig,'_')}`; const dataUrl=await toBase64(file); const base64=dataUrl.split(',')[1]; await ghPut(pat,repo,`static/images/${imgName}`,base64,`upload ${imgName}`,branch,true); updated.image=`static/images/${imgName}`; updated.thumb=updated.image } return updated }\nasync function updateProposalFile(cfg,filename,obj){ const pat=cfg.pat; const repo=cfg.repo; const branch=cfg.branch||'main'; const base64=btoa(unescape(encodeURIComponent(JSON.stringify(obj)))); return await ghPut(pat,repo,`static/proposals/${filename}`,base64,`update proposal ${obj.ref_code||filename}`,branch,true) }\n\n/* accept modal + mapping */\nfunction showAcceptModal(item,filename){ const final=prompt('أدخل الرمز النهائي الذي تريد استخدامه (اتركه فارغاً لاستخدام رمز المقترح):', item.ref_code||'') || (item.ref_code||('ad'+Date.now().toString(36))); acceptProposalWithMapping(readCfg(),filename,item,final) }\nasync function acceptProposalWithMapping(cfg,filename,item,final_code){ const pat=cfg.pat; const repo=cfg.repo; const branch=cfg.branch||'main'; if(!pat) throw new Error('PAT مطلوب'); // ensure latest edits saved if detail visible try{ if(document.getElementById('p_name')) item = await buildProposalFromDetail(item) }catch(e){} const raw=await ghRaw(repo,'static/ads.json',branch); const arr= raw? JSON.parse(raw):[]; const ad = { code: final_code, name: item.name||'', description:item.description||'', location:item.location||'', contact:item.contact||'', category:item.category||'', image:item.image||'', thumb:item.thumb||item.image||'', created_at: new Date().toISOString() }; arr.unshift(ad); await ghPut(pat,repo,'static/ads.json', btoa(unescape(encodeURIComponent(JSON.stringify(arr)))), 'accept proposal '+(item.ref_code||filename), branch, true); // add mapping const rawMap=await ghRaw(repo,'static/mappings.json',branch); const maps = rawMap? JSON.parse(rawMap):[]; maps.unshift({proposal_ref: item.ref_code||filename, final_code: final_code, accepted_at: new Date().toISOString()}); await ghPut(pat,repo,'static/mappings.json', btoa(unescape(encodeURIComponent(JSON.stringify(maps)))), 'add mapping '+(item.ref_code||filename), branch, true); // delete proposal await deleteProposal(cfg,filename); alert('تم القبول والتضمين'); loadAll() }\n\n/* delete a proposal */\nasync function deleteProposal(cfg,filename){ const pat=cfg.pat; const repo=cfg.repo; const branch=cfg.branch||'main'; return await ghDelete(pat,repo,'static/proposals/'+filename,'reject proposal '+filename,branch) }\n\n/* add / edit / delete ads (same pattern) */\ndocument.getElementById('newBtn').onclick = ()=> openAddModal();\nfunction openAddModal(){ document.getElementById('modal').style.display='flex'; document.getElementById('modalTitle').innerText='إضافة إعلان جديد'; document.getElementById('m_code').value=''; document.getElementById('m_name').value=''; document.getElementById('m_desc').value=''; document.getElementById('m_loc').value=''; document.getElementById('m_contact').value=''; document.getElementById('m_cat').value=''; document.getElementById('saveBtn').onclick = async ()=>{ const cfg=readCfg(); const pat=cfg.pat; const repo=cfg.repo; const branch=cfg.branch||'main'; if(!pat||!repo) return alert('ضع repo وPAT ثم احفظ الإعدادات'); try{ const raw = await ghRaw(repo,'static/ads.json',branch); const arr = raw? JSON.parse(raw):[]; const file = document.getElementById('m_file').files[0]; let imgPath=''; if(file){ const imgName = 'img' + Date.now() + '-' + file.name.replace(/[^a-z0-9.\\-_]/ig,'_'); const dataUrl = await toBase64(file); const base64 = dataUrl.split(',')[1]; await ghPut(pat,repo,`static/images/${imgName}`,base64,`upload ${imgName}`,branch,true); imgPath=`static/images/${imgName}` } const newObj = { code: document.getElementById('m_code').value.trim() || ('c' + Date.now().toString(36).slice(-6)), name: document.getElementById('m_name').value.trim(), description: document.getElementById('m_desc').value.trim(), location: document.getElementById('m_loc').value.trim(), contact: document.getElementById('m_contact').value.trim(), category: document.getElementById('m_cat').value.trim(), image: imgPath, thumb: imgPath, created_at: new Date().toISOString() }; arr.unshift(newObj); await ghPut(pat,repo,'static/ads.json', btoa(unescape(encodeURIComponent(JSON.stringify(arr)))), 'add ad', branch, true); alert('تم الإضافة'); document.getElementById('modal').style.display='none'; loadAll(); }catch(e){ alert('خطأ: '+e.message) } } }\nfunction openEdit(ad,idx){ document.getElementById('modal').style.display='flex'; document.getElementById('modalTitle').innerText='تعديل الإعلان'; document.getElementById('m_code').value=ad.code||''; document.getElementById('m_name').value=ad.name||''; document.getElementById('m_desc').value=ad.description||''; document.getElementById('m_loc').value=ad.location||''; document.getElementById('m_contact').value=ad.contact||''; document.getElementById('m_cat').value=ad.category||''; document.getElementById('saveBtn').onclick = async ()=>{ const cfg=readCfg(); const pat=cfg.pat; const repo=cfg.repo; const branch=cfg.branch||'main'; if(!pat||!repo) return alert('ضع repo وPAT ثم احفظ الإعدادات'); try{ const raw = await ghRaw(repo,'static/ads.json',branch); const arr = raw? JSON.parse(raw):[]; const file = document.getElementById('m_file').files[0]; if(file){ const imgName = (document.getElementById('m_code').value.trim() || ('img'+Date.now())) + '-' + file.name.replace(/[^a-z0-9.\\-_]/ig,'_'); const dataUrl = await toBase64(file); const base64 = dataUrl.split(',')[1]; await ghPut(pat,repo,`static/images/${imgName}`,base64,`upload ${imgName}`,branch,true); arr[idx].image = `static/images/${imgName}`; arr[idx].thumb = arr[idx].image } arr[idx] = { code: document.getElementById('m_code').value.trim(), name: document.getElementById('m_name').value.trim(), description: document.getElementById('m_desc').value.trim(), location: document.getElementById('m_loc').value.trim(), contact: document.getElementById('m_contact').value.trim(), category: document.getElementById('m_cat').value.trim(), image: arr[idx].image||'', thumb: arr[idx].thumb||'', created_at: arr[idx].created_at||new Date().toISOString() }; await ghPut(pat,repo,'static/ads.json', btoa(unescape(encodeURIComponent(JSON.stringify(arr)))), 'update ad', branch, true); alert('تم الحفظ'); document.getElementById('modal').style.display='none'; loadAll(); }catch(e){ alert('خطأ: '+e.message) } } }\nasync function deleteAd(idx){ if(!confirm('حذف الإعلان؟')) return; const cfg=readCfg(); const pat=cfg.pat; const repo=cfg.repo; const branch=cfg.branch||'main'; if(!pat||!repo) return alert('ضع repo وPAT ثم احفظ الإعدادات'); try{ const raw=await ghRaw(repo,'static/ads.json',branch); const arr= raw? JSON.parse(raw):[]; arr.splice(idx,1); await ghPut(pat,repo,'static/ads.json', btoa(unescape(encodeURIComponent(JSON.stringify(arr)))), 'delete ad', branch, true); alert('تم الحذف'); loadAll(); }catch(e){ alert('خطأ: '+e.message) } }\n\n/* utils */\nfunction escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>\"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;',\"'\":'&#39;'}[c])); }\nfunction escapeAttr(s){ return (s||'').replace(/\"/g,'&quot;').replace(/</g,'&lt;') }\nfunction toBase64(file){ return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file); }) }\n\n/* init */\nasync function loadAllInit(){ setUiFromCfg(); const cfg=readCfg(); if(cfg.repo && cfg.pat){ try{ const check = await ghApiGetWithPat(cfg.pat,cfg.repo,'static/ads.json',cfg.branch||'main'); if(check.status===401||check.status===403){ updateStatus('PAT غير صالح أو لم يُمنح الإذن'); return } loadAll() }catch(e){} } }\nloadAllInit();\n\n/* small helper re-used */\nasync function ghApiGetWithPat(pat,repo,path,branch='main'){ const [owner,rname]=repo.split('/'); const url=`https://api.github.com/repos/${owner}/${rname}/contents/${encodeURIComponent(path)}?ref=${encodeURIComponent(branch)}`; return await fetch(url,{headers: pat?{Authorization:'token '+pat}:{}}) }\n</script>\n</body>\n</htmlsyudsvdt>","location":"nibnibuib","contact":"bby yu yuh","category":"tvu","created_at":"2025-11-15T14:46:46.582Z","image":"static/images/R0EH54M-capture_1763217999018.jpg","thumb":"static/images/R0EH54M-capture_1763217999018.jpg"}