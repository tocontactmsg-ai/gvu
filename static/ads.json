[{"code":"guiguic","name":"hiocehiowehio","description":"<!doctype html>\n<html lang=\"ar\" dir=\"rtl\">\n<head>\n<meta charset=\"utf-8\" />\n<meta name=\"viewport\" content=\"width=device-width,initial-scale=1\" />\n<title>لوحة الإدارة — إعلانات (Static)</title>\n<link href=\"https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;700&display=swap\" rel=\"stylesheet\">\n<style>\n  :root{--bg:#f5f7fb;--card:#fff;--accent:#0b69d6;--danger:#d33;--muted:#59656f}\n  *{box-sizing:border-box;font-family:\"Tajawal\",sans-serif}\n  body{margin:14px;background:var(--bg);color:#07203a}\n  .wrap{max-width:1100px;margin:0 auto}\n  header{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:12px}\n  header h1{margin:0;font-size:20px}\n  .cfg{display:flex;gap:8px;flex-wrap:wrap;align-items:center}\n  input,select,textarea,button{font-size:14px}\n  input,select,textarea{padding:8px;border-radius:8px;border:1px solid #e6eef8}\n  button{padding:8px 10px;border-radius:8px;border:none;background:var(--accent);color:#fff;cursor:pointer}\n  button.alt{background:#6b7280}\n  button.danger{background:var(--danger)}\n  .cols{display:grid;grid-template-columns:1fr 420px;gap:12px}\n  .panel{background:var(--card);padding:12px;border-radius:10px;box-shadow:0 10px 24px rgba(9,30,66,0.06)}\n  .list{max-height:520px;overflow:auto}\n  .item{display:flex;gap:10px;border-bottom:1px solid #f2f4f7;padding:10px 0;align-items:center}\n  .thumb{width:96px;height:72px;object-fit:cover;border-radius:6px;background:#f4f6f9}\n  .meta{flex:1}\n  .muted{color:var(--muted);font-size:13px}\n  .actions{display:flex;gap:8px}\n  .detailRow{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px}\n  label.small{font-size:13px;color:#333;min-width:90px}\n  input[type=file]{padding:4px}\n  pre{background:#fbfdff;padding:8px;border-radius:6px;overflow:auto}\n  .note{font-size:13px;color:var(--muted);margin-top:6px}\n  .hidden{display:none}\n  .acceptModal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.5);z-index:60}\n  .acceptModal .box{background:#fff;padding:12px;border-radius:8px;min-width:320px;max-width:90%}\n</style>\n</head>\n<body>\n<div class=\"wrap\">\n  <header>\n    <h1>لوحة الإدارة — الإعلانات (Static GitHub)</h1>\n    <div class=\"cfg\">\n      <input id=\"cfg_repo\" placeholder=\"owner/repo (مثال: user/repo)\" style=\"width:220px\">\n      <input id=\"cfg_branch\" placeholder=\"branch\" style=\"width:80px\" value=\"main\">\n      <input id=\"cfg_pat\" placeholder=\"الصق GitHub PAT هنا\" style=\"width:300px\">\n      <label style=\"display:flex;align-items:center;gap:6px\"><input type=\"checkbox\" id=\"allowPublic\"> <span class=\"muted\">سماح للإرسال العام</span></label>\n      <button id=\"saveBtn\">حفظ</button>\n      <button id=\"clearBtn\" class=\"alt\">مسح PAT</button>\n    </div>\n  </header>\n\n  <div class=\"cols\">\n    <div>\n      <div class=\"panel\" style=\"margin-bottom:12px\">\n        <h3 style=\"margin:0 0 8px\">الإعلانات الحالية</h3>\n        <div id=\"adsList\" class=\"list\"><div class=\"muted\">لم تُحمّل — ادخل repo وPAT ثم اضغط حفظ</div></div>\n        <div style=\"margin-top:10px\"><button id=\"newAdBtn\">إضافة إعلان جديد</button></div>\n      </div>\n\n      <div class=\"panel\">\n        <h3 style=\"margin:0 0 8px\">مقترحات الزوار (proposals)</h3>\n        <div id=\"proposalsList\" class=\"list\"><div class=\"muted\">لم تُحمّل — ادخل repo وPAT ثم اضغط حفظ</div></div>\n      </div>\n    </div>\n\n    <div>\n      <div class=\"panel\">\n        <h3 style=\"margin:0 0 8px\">تفاصيل / معاينة</h3>\n        <div id=\"detail\">حدد إعلاناً أو مقترحاً لعرض التفاصيل</div>\n      </div>\n    </div>\n  </div>\n</div>\n\n<!-- accept modal -->\n<div id=\"acceptModal\" class=\"acceptModal\">\n  <div class=\"box\">\n    <div style=\"margin-bottom:8px\">أدخل الرمز النهائي الذي تريد استخدامه (اتركه فارغاً لاستخدام رمز المقترح):</div>\n    <input id=\"finalCodeInput\" placeholder=\"رمز نهائي (مثال: AD001)\" style=\"width:100%;padding:8px;border-radius:6px;border:1px solid #e6eef8\">\n    <div style=\"text-align:left;margin-top:10px\">\n      <button id=\"confirmAcceptBtn\">قبول وتضمين</button>\n      <button id=\"cancelAcceptBtn\" class=\"alt\">إلغاء</button>\n    </div>\n  </div>\n</div>\n\n<script>\n/* Minimal, robust admin.js\n   - Validates PAT + repo before loading lists\n   - Lists proposals and ads\n   - Preview images via raw.githubusercontent\n   - Edit/save proposal, accept (add to ads.json + mappings.json), reject (delete)\n   - Add/edit/delete ads\n*/\n\nconst CFG_KEY = 'static_ads_cfg_v1';\n\n// helpers\nfunction readCfg(){ try{ return JSON.parse(localStorage.getItem(CFG_KEY)||'{}') }catch(e){ return {} } }\nfunction saveCfg(cfg){ localStorage.setItem(CFG_KEY, JSON.stringify(cfg)); }\nfunction updateStatus(msg){ console.log('[status]', msg); /* visible feedback via small alerts can be added */ }\nfunction normalizePath(p){ if(!p) return ''; return p.startsWith('/') ? p.slice(1) : p; }\n\nfunction setUiFromCfg(){\n  const c = readCfg();\n  document.getElementById('cfg_repo').value = c.repo || '';\n  document.getElementById('cfg_branch').value = c.branch || 'main';\n  document.getElementById('cfg_pat').value = c.pat || '';\n  document.getElementById('allowPublic').checked = !!c.allow_public_submissions;\n}\nsetUiFromCfg();\n\n// GitHub helpers\nasync function ghApiGetWithPat(pat, repo, path, branch='main'){\n  const [owner, rname] = repo.split('/');\n  const url = `https://api.github.com/repos/${owner}/${rname}/contents/${encodeURIComponent(path)}?ref=${encodeURIComponent(branch)}`;\n  return fetch(url, { headers: pat ? { Authorization: 'token ' + pat } : {} });\n}\nasync function ghRaw(repo, path, branch='main'){\n  const url = `https://raw.githubusercontent.com/${repo}/${branch}/${path}`;\n  const r = await fetch(url);\n  if(!r.ok) return null;\n  return await r.text();\n}\nasync function ghPut(pat, repo, path, base64content, message, branch='main', alreadyBase64=false){\n  const [owner, rname] = repo.split('/');\n  const url = `https://api.github.com/repos/${owner}/${rname}/contents/${encodeURIComponent(path)}`;\n  const headers = { Authorization: 'token ' + pat, Accept: 'application/vnd.github.v3+json' };\n  let sha = null;\n  try{\n    const meta = await ghApiGetWithPat(pat, repo, path, branch);\n    if(meta.status === 200) { const mj = await meta.json(); sha = mj.sha; }\n  }catch(e){}\n  const body = { message, content: alreadyBase64 ? base64content : btoa(unescape(encodeURIComponent(base64content))), branch };\n  if(sha) body.sha = sha;\n  const res = await fetch(url, { method: 'PUT', headers, body: JSON.stringify(body) });\n  const j = await res.json();\n  if(!res.ok) throw new Error('PUT failed: ' + (j && j.message ? j.message : JSON.stringify(j)));\n  return j;\n}\nasync function ghDelete(pat, repo, path, message, branch='main'){\n  const metaRes = await ghApiGetWithPat(pat, repo, path, branch);\n  if(metaRes.status !== 200) throw new Error('file not found or permission denied');\n  const meta = await metaRes.json();\n  const [owner, rname] = repo.split('/');\n  const url = `https://api.github.com/repos/${owner}/${rname}/contents/${encodeURIComponent(path)}`;\n  const res = await fetch(url, { method:'DELETE', headers: { Authorization: 'token ' + pat, Accept: 'application/vnd.github.v3+json' }, body: JSON.stringify({ message, sha: meta.sha, branch }) });\n  if(!res.ok) throw new Error('Delete failed: ' + await res.text());\n  return await res.json();\n}\n\n// UI wiring\ndocument.getElementById('saveBtn').addEventListener('click', validateAndSave);\ndocument.getElementById('clearBtn').addEventListener('click', ()=>{ if(confirm('مسح PAT من المتصفح؟')){ const c = readCfg(); delete c.pat; saveCfg(c); setUiFromCfg(); alert('PAT محذوف من المتصفح'); } });\ndocument.getElementById('newAdBtn').addEventListener('click', ()=> openAdModal('new'));\n\n// validate PAT+repo then load lists\nasync function validateAndSave(){\n  const repo = document.getElementById('cfg_repo').value.trim();\n  const branch = document.getElementById('cfg_branch').value.trim() || 'main';\n  const pat = document.getElementById('cfg_pat').value.trim();\n  const allow = document.getElementById('allowPublic').checked;\n  if(!repo) return alert('أدخل owner/repo');\n  if(!pat) return alert('الصق PAT صالحاً');\n\n  updateStatus('التحقق من PAT ...');\n  try{\n    const res = await ghApiGetWithPat(pat, repo, 'static/ads.json', branch);\n    if(res.status === 200 || res.status === 404){\n      // token valid (200 file exists; 404 file not found but token works)\n      saveCfg({ repo, branch, pat, allow_public_submissions: allow });\n      setUiFromCfg();\n      updateStatus('تم التحقق والحفظ');\n      loadAll();\n    } else if(res.status === 401 || res.status === 403){\n      updateStatus('فشل التحقق: PAT غير صالح أو لا يوجد إذن');\n      alert('فشل التحقق: PAT غير صالح أو لا يوجد إذن (رمز ' + res.status + '). تأكد من الصلاحيات.');\n    } else {\n      const txt = await res.text().catch(()=> '');\n      updateStatus('خطأ أثناء التحقق: ' + res.status);\n      alert('خطأ أثناء التحقق: ' + res.status + ' ' + txt);\n    }\n  }catch(err){\n    updateStatus('خطأ في التحقق');\n    alert('خطأ عند التحقق: ' + err.message);\n  }\n}\n\n// load lists (only after config present)\nconst adsListEl = document.getElementById('adsList');\nconst proposalsListEl = document.getElementById('proposalsList');\nconst detailEl = document.getElementById('detail');\n\nasync function loadAll(){\n  const cfg = readCfg();\n  if(!cfg.repo || !cfg.pat){ adsListEl.innerHTML = '<div class=\"muted\">أدخل repo وPAT ثم اضغط حفظ لرؤية الإعلانات</div>'; proposalsListEl.innerHTML = '<div class=\"muted\">أدخل repo وPAT ثم اضغط حفظ لرؤية المقترحات</div>'; return; }\n  await loadAds();\n  await loadProposals();\n}\n\nasync function loadAds(){\n  adsListEl.innerHTML = 'تحميل...';\n  const cfg = readCfg();\n  try{\n    const raw = await ghRaw(cfg.repo, 'static/ads.json', cfg.branch || 'main');\n    const arr = raw ? JSON.parse(raw) : [];\n    renderAds(arr);\n  }catch(e){\n    console.error(e);\n    adsListEl.innerHTML = '<div class=\"muted\">فشل جلب ads.json</div>';\n  }\n}\n\nfunction renderAds(items){\n  adsListEl.innerHTML = '';\n  if(!items || items.length === 0){ adsListEl.innerHTML = '<div class=\"muted\">لا توجد إعلانات</div>'; return; }\n  items.forEach((a, idx) => {\n    const r = document.createElement('div'); r.className = 'item';\n    const thumb = normalizePath(a.thumb || a.image || '');\n    r.innerHTML = `<img class=\"thumb\" src=\"${thumb}\" onerror=\"this.style.display='none'\"><div class=\"meta\"><strong>${escapeHtml(a.name||a.code||('ad'+idx))}</strong><div class=\"muted\">${escapeHtml(a.description||'')}</div></div>\n      <div class=\"actions\"><button class=\"viewAdBtn\">عرض</button><button class=\"editAdBtn\">تعديل</button><button class=\"delAdBtn danger\">حذف</button></div>`;\n    r.querySelector('.viewAdBtn').onclick = ()=> showAdDetail(a, idx);\n    r.querySelector('.editAdBtn').onclick = ()=> openAdModal('edit', a, idx);\n    r.querySelector('.delAdBtn').onclick = ()=> deleteAd(idx);\n    adsListEl.appendChild(r);\n  });\n}\n\nasync function loadProposals(){\n  proposalsListEl.innerHTML = 'تحميل...';\n  const cfg = readCfg();\n  if(!cfg.repo || !cfg.pat){ proposalsListEl.innerHTML = '<div class=\"muted\">حدد repo وPAT ثم اضغط حفظ</div>'; return; }\n  try{\n    const [owner, repoName] = cfg.repo.split('/');\n    const url = `https://api.github.com/repos/${owner}/${repoName}/contents/static/proposals?ref=${encodeURIComponent(cfg.branch || 'main')}`;\n    const res = await fetch(url, { headers: { Authorization: 'token ' + cfg.pat } });\n    if(res.status === 404){ proposalsListEl.innerHTML = '<div class=\"muted\">لا توجد مقترحات</div>'; return; }\n    if(!res.ok) throw new Error('list error ' + res.status);\n    const list = await res.json();\n    const jsonFiles = list.filter(f => f.name.endsWith('.json'));\n    proposalsListEl.innerHTML = '';\n    for(const f of jsonFiles){\n      const raw = await fetch(f.download_url, { headers: { Authorization: 'token ' + cfg.pat } }).then(r => r.json()).catch(()=>null);\n      const item = raw || {};\n      const el = document.createElement('div'); el.className = 'item proposal';\n      el.innerHTML = `<div style=\"flex:1\">\n        <strong>${escapeHtml(item.ref_code || f.name)}</strong>\n        <div class=\"muted\">${escapeHtml(item.created_at||'')}</div>\n        <div class=\"muted\">${escapeHtml((item.name||'') + ' — ' + (item.location||''))}</div>\n      </div>\n      <div style=\"display:flex;gap:6px\">\n        <button class=\"viewPropBtn\">عرض/تحرير</button>\n        <button class=\"acceptPropBtn\" style=\"background:#2a9d8f\">قبول</button>\n        <button class=\"rejectPropBtn\" style=\"background:var(--danger)\">رفض</button>\n      </div>`;\n      el.querySelector('.viewPropBtn').onclick = ()=> showProposalDetail(item, f.name);\n      el.querySelector('.acceptPropBtn').onclick = ()=> startAcceptFlow(item, f.name);\n      el.querySelector('.rejectPropBtn').onclick = async ()=> { if(!confirm('رفض المقترح وحذفه؟')) return; try{ await deleteProposal(cfg, f.name); alert('تم الحذف'); loadAll(); }catch(e){ alert('خطأ: ' + e.message); } };\n      proposalsListEl.appendChild(el);\n    }\n    if(jsonFiles.length === 0) proposalsListEl.innerHTML = '<div class=\"muted\">لا توجد مقترحات</div>';\n  }catch(e){\n    console.error(e);\n    proposalsListEl.innerHTML = '<div class=\"muted\">فشل جلب المقترحات</div>';\n  }\n}\n\n/* --------- detail / edit proposal --------- */\nfunction showAdDetail(ad, idx){\n  const repo = readCfg().repo; const branch = readCfg().branch || 'main';\n  let imgHtml = '';\n  if(ad.image){\n    const p = normalizePath(ad.image);\n    const url = p.startsWith('http') ? p : `https://raw.githubusercontent.com/${repo}/${branch}/${p}`;\n    imgHtml = `<div style=\"margin-bottom:8px\"><img src=\"${url}\" style=\"max-width:100%;border-radius:6px\"></div>`;\n  }\n  detailEl.innerHTML = `${imgHtml}\n    <div><strong>${escapeHtml(ad.name||'')}</strong></div>\n    <div class=\"muted\">${escapeHtml(ad.description||'')}</div>\n    <div style=\"margin-top:8px\" class=\"muted\">رمز: ${escapeHtml(ad.code||'')}</div>`;\n}\n\nfunction showProposalDetail(item, filename){\n  const cfg = readCfg(); const repo = cfg.repo; const branch = cfg.branch || 'main';\n  let imgHtml = '';\n  if(item.image){\n    const p = normalizePath(item.image);\n    const url = p.startsWith('http') ? p : `https://raw.githubusercontent.com/${repo}/${branch}/${p}`;\n    imgHtml = `<div style=\"margin-bottom:8px\"><img src=\"${url}\" style=\"max-width:100%;border-radius:6px\"></div>`;\n  }\n  detailEl.innerHTML = `\n    ${imgHtml}\n    <div class=\"detailRow\"><label class=\"small\">الرمز</label><input id=\"p_code\" value=\"${escapeAttr(item.ref_code||item.code||'')}\" style=\"flex:1\"></div>\n    <div class=\"detailRow\"><label class=\"small\">العنوان</label><input id=\"p_name\" value=\"${escapeAttr(item.name||'')}\" style=\"flex:1\"></div>\n    <div class=\"detailRow\"><label class=\"small\">الوصف</label><textarea id=\"p_desc\" rows=\"3\" style=\"flex:1\">${escapeAttr(item.description||'')}</textarea></div>\n    <div class=\"detailRow\"><label class=\"small\">الموقع</label><input id=\"p_loc\" value=\"${escapeAttr(item.location||'')}\" style=\"flex:1\"></div>\n    <div class=\"detailRow\"><label class=\"small\">التواصل</label><input id=\"p_contact\" value=\"${escapeAttr(item.contact||'')}\" style=\"flex:1\"></div>\n    <div class=\"detailRow\"><label class=\"small\">التصنيف</label><input id=\"p_cat\" value=\"${escapeAttr(item.category||'')}\" style=\"flex:1\"></div>\n    <div class=\"detailRow\"><label class=\"small\">تغيير الصورة</label><input id=\"p_file\" type=\"file\" accept=\"image/*\"></div>\n    <div style=\"display:flex;gap:8px;justify-content:flex-end;margin-top:8px\">\n      <button id=\"saveProposalBtn\">تعديل وحفظ</button>\n      <button id=\"acceptProposalBtn\" style=\"background:#2a9d8f\">قبول وتضمين</button>\n      <button id=\"deleteProposalBtn\" style=\"background:var(--danger)\">رفض وحذف</button>\n    </div>\n  `;\n  document.getElementById('saveProposalBtn').onclick = async ()=>{\n    try{\n      const updated = await buildProposalFromDetail(item);\n      await updateProposalFile(readCfg(), filename, updated);\n      alert('تم تعديل المقترح');\n      loadAll();\n    }catch(e){ alert('خطأ في حفظ المقترح: ' + e.message); console.error(e); }\n  };\n  document.getElementById('acceptProposalBtn').onclick = ()=> startAcceptFlow(item, filename);\n  document.getElementById('deleteProposalBtn').onclick = async ()=>{ if(!confirm('رفض المقترح وحذفه؟')) return; try{ await deleteProposal(readCfg(), filename); alert('تم الحذف'); loadAll(); }catch(e){ alert('خطأ: ' + e.message); } };\n}\n\nasync function buildProposalFromDetail(originalItem){\n  const cfg = readCfg(); const pat = cfg.pat; const repo = cfg.repo; const branch = cfg.branch || 'main';\n  const updated = Object.assign({}, originalItem);\n  updated.ref_code = document.getElementById('p_code').value.trim() || updated.ref_code || ('p' + Date.now().toString(36));\n  updated.name = document.getElementById('p_name').value.trim();\n  updated.description = document.getElementById('p_desc').value.trim();\n  updated.location = document.getElementById('p_loc').value.trim();\n  updated.contact = document.getElementById('p_contact').value.trim();\n  updated.category = document.getElementById('p_cat').value.trim();\n  updated.created_at = updated.created_at || new Date().toISOString();\n  const file = document.getElementById('p_file').files[0];\n  if(file){\n    if(!pat || !repo) throw new Error('PAT و repo مطلوبان لتحميل الصورة');\n    const imgName = `${updated.ref_code}-${file.name.replace(/[^a-z0-9.\\-_]/ig,'_')}`;\n    const dataUrl = await toBase64(file); const base64 = dataUrl.split(',')[1];\n    await ghPut(pat, repo, `static/images/${imgName}`, base64, `upload ${imgName}`, branch, true);\n    updated.image = `static/images/${imgName}`;\n    updated.thumb = updated.image;\n  }\n  return updated;\n}\n\nasync function updateProposalFile(cfg, filename, obj){\n  const pat = cfg.pat; const repo = cfg.repo; const branch = cfg.branch || 'main';\n  const base64 = btoa(unescape(encodeURIComponent(JSON.stringify(obj))));\n  return await ghPut(pat, repo, `static/proposals/${filename}`, base64, `update proposal ${obj.ref_code||filename}`, branch, true);\n}\n\nasync function deleteProposal(cfg, filename){\n  const pat = cfg.pat; const repo = cfg.repo; const branch = cfg.branch || 'main';\n  return await ghDelete(pat, repo, 'static/proposals/' + filename, 'reject proposal ' + filename, branch);\n}\n\n/* ---------- Accept flow (show modal to get final code) ---------- */\nlet pendingAccept = null; // { item, filename }\nfunction startAcceptFlow(item, filename){\n  pendingAccept = { item, filename };\n  document.getElementById('finalCodeInput').value = item.ref_code || '';\n  document.getElementById('acceptModal').style.display = 'flex';\n}\ndocument.getElementById('cancelAcceptBtn').addEventListener('click', ()=> { document.getElementById('acceptModal').style.display = 'none'; pendingAccept = null; });\ndocument.getElementById('confirmAcceptBtn').addEventListener('click', async ()=>{\n  const final = document.getElementById('finalCodeInput').value.trim() || (pendingAccept.item.ref_code || ('ad' + Date.now().toString(36)));\n  document.getElementById('acceptModal').style.display = 'none';\n  try{\n    // ensure latest edits if detail is open\n    if(document.getElementById('p_name')) pendingAccept.item = await buildProposalFromDetail(pendingAccept.item);\n  }catch(e){ console.warn('could not build from detail', e); }\n  await acceptProposalWithMapping(readCfg(), pendingAccept.filename, pendingAccept.item, final);\n  alert('تم القبول والتضمين (الرمز النهائي: ' + final + ')');\n  pendingAccept = null;\n  loadAll();\n});\n\n/* accept implementation */\nasync function acceptProposalWithMapping(cfg, filename, item, final_code){\n  const pat = cfg.pat; const repo = cfg.repo; const branch = cfg.branch || 'main';\n  if(!pat) throw new Error('PAT مطلوب');\n  // load ads.json\n  const raw = await ghRaw(repo, 'static/ads.json', branch);\n  const arr = raw ? JSON.parse(raw) : [];\n  const ad = {\n    code: final_code,\n    name: item.name || '',\n    description: item.description || '',\n    location: item.location || '',\n    contact: item.contact || '',\n    category: item.category || '',\n    image: item.image || '',\n    thumb: item.thumb || item.image || '',\n    created_at: new Date().toISOString()\n  };\n  arr.unshift(ad);\n  await ghPut(pat, repo, 'static/ads.json', btoa(unescape(encodeURIComponent(JSON.stringify(arr)))), 'accept proposal ' + (item.ref_code || filename), branch, true);\n  // mappings.json\n  const rawMap = await ghRaw(repo, 'static/mappings.json', branch);\n  const maps = rawMap ? JSON.parse(rawMap) : [];\n  maps.unshift({ proposal_ref: item.ref_code || filename, final_code: final_code, accepted_at: new Date().toISOString() });\n  await ghPut(pat, repo, 'static/mappings.json', btoa(unescape(encodeURIComponent(JSON.stringify(maps)))), 'add mapping ' + (item.ref_code || filename), branch, true);\n  // delete proposal file\n  await deleteProposal(cfg, filename);\n}\n\n/* ---------- add / edit / delete ads ---------- */\nfunction openAdModal(mode, ad=null, idx=null){\n  // simple modal built in detail area\n  detailEl.innerHTML = `\n    <div style=\"display:flex;flex-direction:column;gap:8px\">\n      <div class=\"detailRow\"><label class=\"small\">رمز</label><input id=\"a_code\" value=\"${escapeAttr(ad?.code||'')}\" style=\"flex:1\"></div>\n      <div class=\"detailRow\"><label class=\"small\">العنوان</label><input id=\"a_name\" value=\"${escapeAttr(ad?.name||'')}\" style=\"flex:1\"></div>\n      <div class=\"detailRow\"><label class=\"small\">الوصف</label><textarea id=\"a_desc\" rows=\"4\">${escapeAttr(ad?.description||'')}</textarea></div>\n      <div class=\"detailRow\"><label class=\"small\">الموقع</label><input id=\"a_loc\" value=\"${escapeAttr(ad?.location||'')}\" style=\"flex:1\"></div>\n      <div class=\"detailRow\"><label class=\"small\">التواصل</label><input id=\"a_contact\" value=\"${escapeAttr(ad?.contact||'')}\" style=\"flex:1\"></div>\n      <div class=\"detailRow\"><label class=\"small\">التصنيف</label><input id=\"a_cat\" value=\"${escapeAttr(ad?.category||'')}\" style=\"flex:1\"></div>\n      <div class=\"detailRow\"><label class=\"small\">صورة</label><input id=\"a_file\" type=\"file\" accept=\"image/*\"></div>\n      <div style=\"display:flex;gap:8px;justify-content:flex-end\">\n        <button id=\"saveAdBtn\">${mode === 'new' ? 'إضافة' : 'حفظ'}</button>\n        <button id=\"cancelAdBtn\" class=\"alt\">إلغاء</button>\n      </div>\n    </div>`;\n  document.getElementById('cancelAdBtn').onclick = ()=> { detailEl.innerHTML = 'حدد إعلاناً أو مقترحاً لعرض التفاصيل'; };\n  document.getElementById('saveAdBtn').onclick = async ()=>{\n    const cfg = readCfg(); const pat = cfg.pat; const repo = cfg.repo; const branch = cfg.branch || 'main';\n    if(!pat || !repo) return alert('ضع repo وPAT ثم احفظ الإعدادات');\n    try{\n      const raw = await ghRaw(repo, 'static/ads.json', branch);\n      const arr = raw ? JSON.parse(raw) : [];\n      const file = document.getElementById('a_file').files[0];\n      let imgPath = ad?.image || '';\n      if(file){\n        const imgName = (document.getElementById('a_code').value.trim() || ('img' + Date.now())) + '-' + file.name.replace(/[^a-z0-9.\\-_]/ig,'_');\n        const dataUrl = await toBase64(file); const base64 = dataUrl.split(',')[1];\n        await ghPut(pat, repo, `static/images/${imgName}`, base64, `upload ${imgName}`, branch, true);\n        imgPath = `static/images/${imgName}`;\n      }\n      const obj = {\n        code: document.getElementById('a_code').value.trim() || ('c' + Date.now().toString(36).slice(-6)),\n        name: document.getElementById('a_name').value.trim(),\n        description: document.getElementById('a_desc').value.trim(),\n        location: document.getElementById('a_loc').value.trim(),\n        contact: document.getElementById('a_contact').value.trim(),\n        category: document.getElementById('a_cat').value.trim(),\n        image: imgPath,\n        thumb: imgPath,\n        created_at: ad?.created_at || new Date().toISOString()\n      };\n      if(mode === 'new'){ arr.unshift(obj); } else { arr[idx] = obj; }\n      await ghPut(pat, repo, 'static/ads.json', btoa(unescape(encodeURIComponent(JSON.stringify(arr)))), mode === 'new' ? 'add ad' : 'update ad', branch, true);\n      alert('تم الحفظ');\n      loadAll();\n      detailEl.innerHTML = 'حدد إعلاناً أو مقترحاً لعرض التفاصيل';\n    }catch(e){ alert('خطأ: ' + e.message); console.error(e); }\n  };\n}\n\nasync function deleteAd(idx){\n  if(!confirm('حذف الإعلان؟')) return;\n  const cfg = readCfg(); const pat = cfg.pat; const repo = cfg.repo; const branch = cfg.branch || 'main';\n  if(!pat || !repo) return alert('ضع repo وPAT ثم احفظ الإعدادات');\n  try{\n    const raw = await ghRaw(repo, 'static/ads.json', branch);\n    const arr = raw ? JSON.parse(raw) : [];\n    arr.splice(idx, 1);\n    await ghPut(pat, repo, 'static/ads.json', btoa(unescape(encodeURIComponent(JSON.stringify(arr)))), 'delete ad', branch, true);\n    alert('تم الحذف');\n    loadAll();\n  }catch(e){ alert('خطأ: ' + e.message); console.error(e); }\n}\n\n// helpers\nfunction escapeHtml(s){ return String(s||'').replace(/[&<>\"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;',\"'\":'&#39;'}[c])); }\nfunction escapeAttr(s){ return (s||'').replace(/\"/g,'&quot;').replace(/</g,'&lt;'); }\nfunction toBase64(file){ return new Promise((res, rej) => { const r = new FileReader(); r.onload = ()=> res(r.result); r.onerror = rej; r.readAsDataURL(file); }); }\n\n// initial load (if config exists try to load)\n(async function init(){\n  const cfg = readCfg();\n  if(cfg.repo && cfg.pat){\n    try{\n      const check = await ghApiGetWithPat(cfg.pat, cfg.repo, 'static/ads.json', cfg.branch || 'main');\n      if(check.status === 401 || check.status === 403){ updateStatus('PAT غير صالح أو لم يمنح الإذن'); return; }\n      loadAll();\n    }catch(e){ console.warn('init check failed', e); }\n  }\n})();\n</script>\n</body>\n</html>","location":"sdvnsdv","contact":"pniovpjiofv","category":"idviov","image":"static/images/guiguic-6f166434-62e5-4e03-a1c4-f32b517d2e35.png","thumb":"static/images/guiguic-6f166434-62e5-4e03-a1c4-f32b517d2e35.png","created_at":"2025-11-15T13:54:17.408Z"},{"code":"c0ba48d","name":"tjtrjtntn","description":"yjrj6e5je5","location":"eryeeyhe","contact":"eryetheh","category":"5thhtth","image":"/static/images/img1763212635482-sketch1756648926100.png","thumb":"/static/images/img1763212635482-sketch1756648926100.png","created_at":"2025-11-15T13:17:19.981Z"},{"code":"c0b5xv3","name":"","description":"buiuiuibbnb  yuvy8  yuyu  yu","location":"hh   yuyu  yu   yu y vy","contact":"hiyu yy yu yuvyyu","category":"yhhby yby","image":"/static/images/img1763212439945-sketch1756648926100.png","thumb":"/static/images/img1763212439945-sketch1756648926100.png","created_at":"2025-11-15T13:14:05.103Z"},{"code":"c0au6m6","name":"ihi  hi uh h","description":"ihi  i i","location":"hibi byi  i","contact":"hbbuh  y y8uh","category":"jhyuhby","image":"/static/images/img1763211893593-sketch1761977082919.png","thumb":"/static/images/img1763211893593-sketch1761977082919.png","created_at":"2025-11-15T13:04:56.574Z"},{"code":"c0anbuq","name":"","description":"<h3> . الاستخدام المسموح</h3>\n        <ul class=\"list\">\n          <li>يُحظر نشر محتوى غير قانوني أو مخالف للآداب العامة.</li>\n          <li>يُمنع استخدام الموقع لأغراض احتيالية أو مضللة.</li>\n          <li>يحق لإدارة الموقع حذف أي إعلان مخالف دون إشعار.</li>","location":"","contact":"","category":"","image":"/static/images/img1763211573087-sketch1761975620928.png","thumb":"/static/images/img1763211573087-sketch1761975620928.png","created_at":"2025-11-15T12:59:36.770Z"},{"code":"c09afhr","name":"","description":"gsd                  bvydddddtsyyyyytyyyyyyyyyyyyyyyyyyvfcccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc","location":"","contact":"cfgsvysvy","category":"","image":"","thumb":"","created_at":"2025-11-15T12:21:35.343Z"},{"code":"sample1","name":"إعلان تجريبي","description":"أضف صورًا وبياناتك من لوحة الإدارة. vuk oohobuuifui","location":"Khartoum","contact":"+249-XXXXXXXX","category":"خدمات","image":"static/images/sample.webp","thumb":"static/images/sample-thumb.webp","created_at":"2025-01-01T00:00:00Z"}]