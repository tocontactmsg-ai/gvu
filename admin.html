<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>لوحة الإدارة — إعلانات (Static) — محسّن</title>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;700&display=swap" rel="stylesheet">
<style>
  :root{--bg:#f5f7fb;--card:#fff;--accent:#0b69d6;--danger:#d33;--muted:#59656f}
  *{box-sizing:border-box;font-family:"Tajawal",sans-serif}
  body{margin:14px;background:var(--bg);color:#07203a}
  .wrap{max-width:1100px;margin:0 auto}
  header{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:12px}
  header h1{margin:0;font-size:20px}
  .cfg{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  input,select,textarea,button{font-size:14px}
  input,select,textarea{padding:8px;border-radius:8px;border:1px solid #e6eef8}
  button{padding:8px 10px;border-radius:8px;border:none;background:var(--accent);color:#fff;cursor:pointer}
  button.alt{background:#6b7280}
  button.danger{background:var(--danger)}
  .cols{display:grid;grid-template-columns:1fr 420px;gap:12px}
  .panel{background:var(--card);padding:12px;border-radius:10px;box-shadow:0 10px 24px rgba(9,30,66,0.06)}
  .list{max-height:520px;overflow:auto}
  .item{display:flex;gap:10px;border-bottom:1px solid #f2f4f7;padding:10px 0;align-items:center}
  .thumb{width:96px;height:72px;object-fit:cover;border-radius:6px;background:#f4f6f9}
  .meta{flex:1}
  .muted{color:var(--muted);font-size:13px}
  .actions{display:flex;gap:8px}
  .detailRow{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px}
  label.small{font-size:13px;color:#333;min-width:90px}
  pre{background:#fbfdff;padding:8px;border-radius:6px;overflow:auto}
  .search{display:flex;gap:8px}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>لوحة الإدارة — إعلانات (محسّن)</h1>
    <div class="cfg">
      <input id="cfg_repo" placeholder="owner/repo (مثال: user/repo)" style="width:220px">
      <input id="cfg_branch" placeholder="branch" style="width:80px" value="main">
      <!-- PAT is session-only: not saved to localStorage -->
      <input id="session_pat" placeholder="ألصق PAT للجلسة (لا يُحفَظ)" style="width:300px">
      <button id="setPatBtn">تعيين PAT مؤقت</button>
      <button id="clearPatBtn" class="alt">مسح PAT الجلسة</button>
      <label style="display:flex;align-items:center;gap:6px"><input type="checkbox" id="allowPublic"> <span class="muted">سماح للإرسال العام</span></label>
      <button id="saveBtn">حفظ الإعدادات (بدون PAT)</button>
      <div id="patStatus" class="muted" style="margin-left:6px">PAT: غير معرف</div>
    </div>
  </header>

  <div class="cols">
    <div>
      <div class="panel" style="margin-bottom:12px">
        <h3 style="margin:0 0 8px">الإعلانات الحالية</h3>
        <div class="search" style="margin-bottom:8px"><input id="adminSearch" placeholder="ابحث: رمز (ref) أو عنوان" style="flex:1"><div id="searchCount" class="muted" style="min-width:60px;text-align:center">---</div></div>
        <div id="adsList" class="list"><div class="muted">أدخل repo ثم احفظ الإعدادات لبدء العمل</div></div>
        <div style="margin-top:10px"><button id="newAdBtn">إضافة إعلان جديد</button></div>
      </div>

      <div class="panel">
        <h3 style="margin:0 0 8px">مقترحات الزوار (proposals)</h3>
        <div id="proposalsList" class="list"><div class="muted">أدخل repo ثم احفظ الإعدادات لبدء العمل</div></div>
      </div>
    </div>

    <div>
      <div class="panel">
        <h3 style="margin:0 0 8px">تفاصيل / معاينة</h3>
        <div id="detail">حدد إعلاناً أو مقترحاً لعرض التفاصيل</div>
      </div>
    </div>
  </div>
</div>

<!-- edit/accept modal area (reused) -->
<div id="modal" style="display:none;position:fixed;inset:0;align-items:center;justify-content:center;background:rgba(0,0,0,.5);z-index:60">
  <div id="modalInner" style="background:#fff;padding:12px;border-radius:8px;min-width:320px;max-width:90%"></div>
</div>

<script>
/* ---------- Enhanced Admin script ---------- */
const CFG_KEY = 'static_ads_cfg_v1';
const OPT_FULL = { maxWidth:1600, maxHeight:1200, quality:0.78, outputType:'image/webp' };
const OPT_THUMB = { maxWidth:600, maxHeight:400, quality:0.65, outputType:'image/webp' };

// session-only PAT (never write this to localStorage)
let sessionPat = null;
let sessionExpiryTimer = null;
const SESSION_TTL_MS = 15 * 60 * 1000; // 15 minutes default

// in-memory cache for ads & proposals during session
let cache = { ads: null, proposalsList: null };

// helpers: read/save cfg BUT never include pat
function readCfg(){ try{ return JSON.parse(localStorage.getItem(CFG_KEY)||'{}') }catch(e){ return {} } }
function saveCfg(cfg){ // ensure we don't persist pat
  const c = Object.assign({}, cfg); delete c.pat; localStorage.setItem(CFG_KEY, JSON.stringify(c)); }
function setUiFromCfg(){ const c=readCfg(); document.getElementById('cfg_repo').value=c.repo||''; document.getElementById('cfg_branch').value=c.branch||'main'; document.getElementById('allowPublic').checked=!!c.allow_public_submissions; }
setUiFromCfg();

// update PAT UI
function setSessionPat(p){ sessionPat = p||null; resetPatTimer(); document.getElementById('patStatus').textContent = sessionPat ? 'PAT: مُفعّل (جلسة)' : 'PAT: غير معرف'; }
function resetPatTimer(){ if(sessionExpiryTimer) clearTimeout(sessionExpiryTimer); if(sessionPat){ sessionExpiryTimer = setTimeout(()=>{ sessionPat = null; document.getElementById('patStatus').textContent = 'PAT: انتهت الجلسة'; alert('انتهت صلاحية PAT الجلسة'); }, SESSION_TTL_MS); } }
window.addEventListener('beforeunload', ()=>{ sessionPat = null; });

// GitHub helpers use sessionPat (must be set for write operations)
async function ghApiGet(pat, repo, path, branch='main'){ const [owner,r]=repo.split('/'); const url=`https://api.github.com/repos/${owner}/${r}/contents/${encodeURIComponent(path)}?ref=${encodeURIComponent(branch)}`; return fetch(url, { headers: pat ? { Authorization: 'token ' + pat } : {} }); }
async function ghRaw(repo, path, branch='main'){ const url=`https://raw.githubusercontent.com/${repo}/${branch}/${path}`; const r=await fetch(url); if(!r.ok) return null; return await r.text(); }
async function ghPut(pat, repo, path, base64content, message, branch='main'){ if(!pat) throw new Error('PAT الجلسة مطلوب'); const [owner,r]=repo.split('/'); const url=`https://api.github.com/repos/${owner}/${r}/contents/${encodeURIComponent(path)}`; const headers={ Authorization: 'token ' + pat, Accept: 'application/vnd.github.v3+json' }; let sha=null; try{ const meta=await ghApiGet(pat,repo,path,branch); if(meta.status===200){ const mj=await meta.json(); sha=mj.sha } }catch(e){} const body={ message, content: base64content, branch }; if(sha) body.sha=sha; const res = await fetch(url,{ method:'PUT', headers, body: JSON.stringify(body) }); const j = await res.json(); if(!res.ok) throw new Error('PUT failed: ' + (j && j.message? j.message : JSON.stringify(j))); return j; }
async function ghDelete(pat, repo, path, message, branch='main'){ if(!pat) throw new Error('PAT الجلسة مطلوب'); const meta = await ghApiGet(pat,repo,path,branch); if(meta.status !== 200) throw new Error('file not found or permission denied'); const m = await meta.json(); const [owner,r]=repo.split('/'); const url=`https://api.github.com/repos/${owner}/${r}/contents/${encodeURIComponent(path)}`; const res = await fetch(url,{ method:'DELETE', headers:{ Authorization:'token '+pat, Accept:'application/vnd.github.v3+json' }, body: JSON.stringify({ message, sha: m.sha, branch }) }); if(!res.ok) throw new Error('Delete failed: ' + await res.text()); return await res.json(); }

/* image optimizer (keeps working on main thread but yields) */
async function optimizeImageFile(file, conf){
  const { maxWidth, maxHeight, quality, outputType } = conf;
  const dataUrl = await new Promise((res,rej)=>{ const fr=new FileReader(); fr.onload=()=>res(fr.result); fr.onerror=rej; fr.readAsDataURL(file); });
  const img = await new Promise((res,rej)=>{ const i=new Image(); i.onload=()=>res(i); i.onerror=rej; i.src=dataUrl; });
  let w = img.width, h = img.height;
  const scale = Math.min(1, maxWidth / w, maxHeight / h);
  const tw = Math.round(w * scale), th = Math.round(h * scale);
  const canvas = document.createElement('canvas'); canvas.width = tw; canvas.height = th;
  const ctx = canvas.getContext('2d'); ctx.imageSmoothingEnabled=true; ctx.imageSmoothingQuality='high'; ctx.drawImage(img,0,0,tw,th);
  // yield to keep UI responsive
  await new Promise(r => setTimeout(r, 10));
  const blob = await new Promise(res=>canvas.toBlob(res, outputType, quality));
  const base64 = await new Promise(res=>{ const fr=new FileReader(); fr.onload=()=>res(fr.result.split(',')[1]); fr.readAsDataURL(blob); });
  return { blob, base64, size: blob.size };
}

/* delete image helper */
async function maybeDeleteImage(cfg, imagePath){ if(!imagePath) return; const p = imagePath.startsWith('/')? imagePath.slice(1) : imagePath; try{ const meta = await ghApiGet(sessionPat || cfg.pat, cfg.repo, p, cfg.branch || 'main'); if(meta.status === 200){ await ghDelete(sessionPat || cfg.pat, cfg.repo, p, 'delete image ' + p, cfg.branch || 'main'); console.log('deleted', p); } }catch(e){ console.warn('maybeDeleteImage error', e); } }

/* UI wiring */
document.getElementById('setPatBtn').addEventListener('click', ()=>{
  const v = document.getElementById('session_pat').value.trim(); if(!v) return alert('أدخل PAT'); setSessionPat(v); alert('تم تعيين PAT مؤقتاً — ستنتهي صلاحية الجلسة بعد 15 دقيقة أو عند إغلاق التبويب');
});

document.getElementById('clearPatBtn').addEventListener('click', ()=>{ if(!sessionPat) return alert('لا يوجد PAT'); if(confirm('مسح PAT الجلسة الآن؟')){ setSessionPat(null); document.getElementById('session_pat').value=''; alert('تم المسح'); } });

document.getElementById('saveBtn').addEventListener('click', ()=>{
  const repo = document.getElementById('cfg_repo').value.trim();
  const branch = document.getElementById('cfg_branch').value.trim() || 'main';
  const allow = document.getElementById('allowPublic').checked;
  if(!repo) return alert('أدخل owner/repo');
  saveCfg({ repo, branch, allow_public_submissions: allow });
  setUiFromCfg();
  alert('تم حفظ الإعدادات (لا يشمل PAT)');
  loadAll();
});

// search debounce
let searchDebounce;
document.getElementById('adminSearch').addEventListener('input', (e)=>{
  clearTimeout(searchDebounce);
  const q=(e.target.value||'').trim().toLowerCase();
  searchDebounce = setTimeout(()=>{ filterAds(q); }, 250);
});

/* load lists */
const adsEl = document.getElementById('adsList'), propsEl = document.getElementById('proposalsList'), detailEl = document.getElementById('detail');

async function loadAll(){ const cfg = readCfg(); if(!cfg.repo){ adsEl.innerHTML = '<div class="muted">أدخل repo ثم احفظ الإعدادات</div>'; propsEl.innerHTML = '<div class="muted">أدخل repo ثم احفظ الإعدادات</div>'; return; } await Promise.all([loadAds(), loadProposals()]); }

async function loadAds(){ adsEl.innerHTML = 'تحميل...'; const cfg = readCfg(); try{ const raw = await ghRaw(cfg.repo, 'static/ads.json', cfg.branch || 'main'); const arr = raw ? JSON.parse(raw) : []; cache.ads = arr; renderAds(arr); }catch(e){ console.error(e); adsEl.innerHTML = '<div class="muted">فشل جلب ads.json</div>'; } }

function createItemElement(titleText, descriptionText, codeText, thumbUrl){
  const el = document.createElement('div'); el.className='item';
  const img = document.createElement('img'); img.className='thumb'; img.loading='lazy'; if(thumbUrl) img.src = thumbUrl; else img.style.display='none';
  const meta = document.createElement('div'); meta.className='meta';
  const title = document.createElement('strong'); title.textContent = titleText || '';
  const desc = document.createElement('div'); desc.className='muted'; desc.textContent = descriptionText || '';
  const code = document.createElement('div'); code.className='muted'; code.textContent = 'رمز: ' + (codeText||'');
  meta.appendChild(title); meta.appendChild(desc); meta.appendChild(code);
  const actions = document.createElement('div'); actions.className='actions';
  el.appendChild(img); el.appendChild(meta); el.appendChild(actions);
  return { el, actions, img, meta, title, desc, code };
}

function renderAds(items){ adsEl.innerHTML = ''; document.getElementById('searchCount').textContent = items ? items.length : '0'; if(!items || items.length===0){ adsEl.innerHTML = '<div class="muted">لا توجد إعلانات</div>'; return; }
  items.forEach((a, idx)=>{
    const thumb = a.thumb ? `https://raw.githubusercontent.com/${readCfg().repo}/${readCfg().branch||'main'}/${a.thumb.replace(/^\//,'')}` : (a.image? `https://raw.githubusercontent.com/${readCfg().repo}/${readCfg().branch||'main'}/${a.image.replace(/^\//,'')}` : null);
    const parts = createItemElement(a.name||a.code||('ad'+idx), a.description||'', a.ref_code||a.code||'', thumb);
    const viewBtn = document.createElement('button'); viewBtn.textContent='عرض'; viewBtn.onclick = ()=> showAdDetail(a, idx);
    const editBtn = document.createElement('button'); editBtn.textContent='تعديل'; editBtn.onclick = ()=> openAdModal('edit', a, idx);
    const delBtn = document.createElement('button'); delBtn.textContent='حذف'; delBtn.className='danger'; delBtn.onclick = ()=> deleteAd(idx);
    parts.actions.appendChild(viewBtn); parts.actions.appendChild(editBtn); parts.actions.appendChild(delBtn);
    adsEl.appendChild(parts.el);
  });
}

// proposals: fetch directory listing then fetch files in parallel with concurrency
async function loadProposals(){ propsEl.innerHTML = 'تحميل...'; const cfg = readCfg(); try{
  const [owner, repoName] = cfg.repo.split('/');
  const url = `https://api.github.com/repos/${owner}/${repoName}/contents/static/proposals?ref=${encodeURIComponent(cfg.branch || 'main')}`;
  const res = await fetch(url, { headers: sessionPat ? { Authorization: 'token ' + sessionPat } : {} });
  if(res.status === 404){ propsEl.innerHTML = '<div class="muted">لا توجد مقترحات</div>'; return; }
  if(!res.ok) throw new Error('list error ' + res.status);
  const list = await res.json();
  const jsonFiles = list.filter(f => f.name.endsWith('.json'));
  if(jsonFiles.length===0){ propsEl.innerHTML = '<div class="muted">لا توجد مقترحات</div>'; return; }
  // fetch in parallel with limited concurrency
  const files = await mapWithConcurrency(jsonFiles, async f => {
    try{ const r = await fetch(f.download_url, { headers: sessionPat ? { Authorization: 'token ' + sessionPat } : {} }); if(!r.ok) return null; return await r.json(); }catch(e){ return null; }
  }, 6);
  cache.proposalsList = jsonFiles.map((f,i)=> ({ filename: f.name, data: files[i] }));
  renderProposals(cache.proposalsList);
 }catch(e){ console.error(e); propsEl.innerHTML = '<div class="muted">فشل جلب المقترحات</div>'; }
}

function renderProposals(items){ propsEl.innerHTML = ''; items.forEach(it=>{
  const item = it.data || {};
  const el = document.createElement('div'); el.className='item';
  const info = document.createElement('div'); info.style.flex='1';
  const title = document.createElement('strong'); title.textContent = item.ref_code || it.filename;
  const muted = document.createElement('div'); muted.className='muted'; muted.textContent = item.name || '';
  info.appendChild(title); info.appendChild(muted);
  const actions = document.createElement('div'); actions.style.display='flex'; actions.style.gap='6px';
  const viewBtn = document.createElement('button'); viewBtn.textContent='عرض/تحرير'; viewBtn.onclick = ()=> showProposalDetail(item, it.filename);
  const acceptBtn = document.createElement('button'); acceptBtn.textContent='قبول'; acceptBtn.style.background='#2a9d8f'; acceptBtn.onclick = ()=> startAcceptFlow(item, it.filename);
  const rejectBtn = document.createElement('button'); rejectBtn.textContent='رفض'; rejectBtn.style.background='var(--danger)'; rejectBtn.onclick = async ()=>{ if(!confirm('رفض المقترح وحذفه؟')) return; try{ await deleteProposalWithImage(readCfg(), it.filename); alert('تم الحذف'); loadAll(); }catch(e){ alert('خطأ: '+e.message); } };
  actions.appendChild(viewBtn); actions.appendChild(acceptBtn); actions.appendChild(rejectBtn);
  el.appendChild(info); el.appendChild(actions); propsEl.appendChild(el);
}); }

// concurrency helper
async function mapWithConcurrency(items, fn, concurrency = 6) {
  const results = new Array(items.length);
  let idx = 0;
  const workers = Array.from({length: Math.min(concurrency, items.length)}, async () => {
    while(true){ const i = idx++; if(i >= items.length) break; try{ results[i] = await fn(items[i]); }catch(e){ results[i]=null; } }
  });
  await Promise.all(workers);
  return results;
}

/* show & edit */
function showAdDetail(ad, idx){ const cfg = readCfg(); const repo = cfg.repo; const branch = cfg.branch||'main'; detailEl.innerHTML='';
  if(ad.image){ const p = (ad.image||'').replace(/^\//,''); const img = document.createElement('img'); img.style.maxWidth='100%'; img.style.borderRadius='8px'; img.src = `https://raw.githubusercontent.com/${repo}/${branch}/${p}`; detailEl.appendChild(img); }
  const name = document.createElement('div'); name.innerHTML = `<strong>${escapeHtml(ad.name||'')}</strong>`; detailEl.appendChild(name);
  const desc = document.createElement('div'); desc.className='muted'; desc.textContent = ad.description||''; detailEl.appendChild(desc);
  const code = document.createElement('div'); code.style.marginTop='6px'; code.className='muted'; code.textContent = 'رمز: ' + (ad.ref_code||ad.code||''); detailEl.appendChild(code);
}

function showProposalDetail(item, filename){ detailEl.innerHTML=''; const cfg = readCfg(); const repo = cfg.repo; const branch = cfg.branch||'main';
  if(item.image){ const p=(item.image||'').replace(/^\//,''); const img = document.createElement('img'); img.style.maxWidth='100%'; img.style.borderRadius='8px'; img.src = `https://raw.githubusercontent.com/${repo}/${branch}/${p}`; detailEl.appendChild(img); }
  // build editable form
  const container = document.createElement('div'); container.style.display='flex'; container.style.flexDirection='column'; container.style.gap='8px';
  container.appendChild(buildDetailRow('الرمز', 'p_code', item.ref_code||''));
  container.appendChild(buildDetailRow('العنوان', 'p_name', item.name||''));
  container.appendChild(buildDetailRow('الوصف', 'p_desc', item.description||'', true));
  container.appendChild(buildDetailRow('الموقع', 'p_loc', item.location||''));
  container.appendChild(buildDetailRow('التواصل', 'p_contact', item.contact||''));
  container.appendChild(buildDetailRow('التصنيف', 'p_cat', item.category||''));
  // image input
  const fileRow = document.createElement('div'); fileRow.className='detailRow'; const lbl = document.createElement('label'); lbl.className='small'; lbl.textContent='تغيير الصورة'; fileRow.appendChild(lbl); const fileInput = document.createElement('input'); fileInput.type='file'; fileInput.accept='image/*'; fileInput.id='p_file'; fileRow.appendChild(fileInput); container.appendChild(fileRow);
  // actions
  const actions = document.createElement('div'); actions.style.display='flex'; actions.style.gap='8px'; actions.style.justifyContent='flex-end';
  const saveBtn = document.createElement('button'); saveBtn.textContent='تعديل وحفظ'; saveBtn.onclick = async ()=>{ try{ const updated = await buildProposalFromDetail(item); await updateProposalFile(readCfg(), filename, updated); alert('تم تعديل المقترح'); loadAll(); }catch(e){ alert('خطأ: '+e.message); console.error(e); } };
  const acceptBtn = document.createElement('button'); acceptBtn.textContent='قبول وتضمين'; acceptBtn.style.background='#2a9d8f'; acceptBtn.onclick = ()=> startAcceptFlow(item, filename);
  const deleteBtn = document.createElement('button'); deleteBtn.textContent='رفض وحذف'; deleteBtn.style.background='var(--danger)'; deleteBtn.onclick = async ()=>{ if(!confirm('رفض المقترح وحذفه؟')) return; try{ await deleteProposalWithImage(readCfg(), filename); alert('تم الحذف'); loadAll(); }catch(e){ alert('خطأ: ' + e.message); } };
  actions.appendChild(saveBtn); actions.appendChild(acceptBtn); actions.appendChild(deleteBtn);
  container.appendChild(actions);
  detailEl.appendChild(container);
}

function buildDetailRow(labelText, id, value, isTextarea){ const row = document.createElement('div'); row.className='detailRow'; const lbl = document.createElement('label'); lbl.className='small'; lbl.textContent=labelText; row.appendChild(lbl); if(isTextarea){ const ta = document.createElement('textarea'); ta.id=id; ta.rows=3; ta.style.flex='1'; ta.value = value; row.appendChild(ta); } else { const inp = document.createElement('input'); inp.id=id; inp.style.flex='1'; inp.value = value; row.appendChild(inp); } return row; }

async function buildProposalFromDetail(originalItem){ const cfg = readCfg(); const pat = sessionPat; const repo = cfg.repo; const branch = cfg.branch||'main'; const updated = Object.assign({}, originalItem);
  updated.ref_code = document.getElementById('p_code').value.trim() || updated.ref_code || ('p' + Date.now().toString(36));
  updated.name = document.getElementById('p_name').value.trim();
  updated.description = document.getElementById('p_desc').value.trim();
  updated.location = document.getElementById('p_loc').value.trim();
  updated.contact = document.getElementById('p_contact').value.trim();
  updated.category = document.getElementById('p_cat').value.trim();
  updated.created_at = updated.created_at || new Date().toISOString();
  const file = document.getElementById('p_file').files[0];
  if(file){ if(!pat) throw new Error('PAT الجلسة مطلوب لتحميل الصور'); const safe = sanitizeFilename(file.name); const fullName = `${updated.ref_code}-${safe}`; const thumbName = `${updated.ref_code}-thumb-${safe}`; const optFull = await optimizeImageFile(file, OPT_FULL); await ghPut(pat, repo, `static/images/${fullName}`, optFull.base64, `upload ${fullName}`, branch); const optThumb = await optimizeImageFile(file, OPT_THUMB); await ghPut(pat, repo, `static/images/thumbs/${thumbName}`, optThumb.base64, `upload ${thumbName}`, branch); if(originalItem.image && originalItem.image !== `static/images/${fullName}`){ await maybeDeleteImage(cfg, originalItem.image); if(originalItem.thumb) await maybeDeleteImage(cfg, originalItem.thumb); } updated.image = `static/images/${fullName}`; updated.thumb = `static/images/thumbs/${thumbName}`; }
  return updated;
}

async function updateProposalFile(cfg, filename, obj){ const pat = sessionPat; const repo = cfg.repo; const branch = cfg.branch || 'main'; if(!pat) throw new Error('PAT الجلسة مطلوب'); const base64 = btoa(unescape(encodeURIComponent(JSON.stringify(obj)))); return await ghPut(pat, repo, `static/proposals/${filename}`, base64, `update proposal ${obj.ref_code||filename}`, branch); }

async function deleteProposalWithImage(cfg, filename){ try{ const pUrl = `https://raw.githubusercontent.com/${cfg.repo}/${cfg.branch||'main'}/static/proposals/${filename}`; const r = await fetch(pUrl); if(r.ok){ const item = await r.json().catch(()=>null); if(item && item.image) await maybeDeleteImage(cfg, item.image); if(item && item.thumb) await maybeDeleteImage(cfg, item.thumb); } }catch(e){ console.warn('prefetch failed', e); } return await ghDelete(sessionPat, cfg.repo, `static/proposals/${filename}`, 'reject proposal ' + filename, cfg.branch || 'main'); }

/* accept flow */
let pending = null;
function startAcceptFlow(item, filename){ pending = { item, filename }; openAcceptModal(); }
function openAcceptModal(){ showModal(`<div style="margin-bottom:8px">أدخل الرمز النهائي (اتركه فارغاً لاستخدام رمز المقترح):</div><input id="finalCodeInput" placeholder="رمز نهائي" style="width:100%;padding:8px;border-radius:6px;border:1px solid #e6eef8"><div style="text-align:left;margin-top:10px"><button id="confirmAcceptBtn">قبول وتضمين</button><button id="cancelAcceptBtn" class="alt">إلغاء</button></div>`, ()=>{
  document.getElementById('confirmAcceptBtn').onclick = async ()=>{
    const final = document.getElementById('finalCodeInput').value.trim() || (pending.item.ref_code || ('ad' + Date.now().toString(36)));
    closeModal();
    try{ if(document.getElementById('p_name')) pending.item = await buildProposalFromDetail(pending.item); }catch(e){ console.warn('build from detail failed', e); }
    try{ await acceptProposalWithMapping(readCfg(), pending.filename, pending.item, final); alert('تم القبول'); }catch(e){ alert('خطأ: ' + e.message); console.error(e); }
    pending = null; loadAll();
  };
  document.getElementById('cancelAcceptBtn').addEventListener('click', ()=>{ closeModal(); pending=null; });
}); }

async function acceptProposalWithMapping(cfg, filename, item, final_code){ const pat = sessionPat; const repo = cfg.repo; const branch = cfg.branch||'main'; if(!pat) throw new Error('PAT الجلسة مطلوب'); const raw = await ghRaw(repo, 'static/ads.json', branch); const arr = raw ? JSON.parse(raw) : []; const ad = { ref_code: final_code, code: final_code, name: item.name||'', description: item.description||'', location: item.location||'', contact: item.contact||'', category: item.category||'', image: item.image||'', thumb: item.thumb||item.image||'', created_at: new Date().toISOString() }; arr.unshift(ad); await ghPut(pat, repo, 'static/ads.json', btoa(unescape(encodeURIComponent(JSON.stringify(arr)))), 'accept proposal ' + (item.ref_code||filename), branch); const rawMap = await ghRaw(repo, 'static/mappings.json', branch); const maps = rawMap ? JSON.parse(rawMap) : []; maps.unshift({ proposal_ref: item.ref_code||filename, final_code: final_code, accepted_at: new Date().toISOString() }); await ghPut(pat, repo, 'static/mappings.json', btoa(unescape(encodeURIComponent(JSON.stringify(maps)))), 'add mapping ' + (item.ref_code||filename), branch); await ghDelete(pat, repo, `static/proposals/${filename}`, 'accept proposal ' + filename, branch); }

/* add/edit/delete ads */
document.getElementById('newAdBtn').addEventListener('click', ()=> openAdModal('new'));

function openAdModal(mode, ad=null, idx=null){ detailEl.innerHTML = '';
  const container = document.createElement('div'); container.style.display='flex'; container.style.flexDirection='column'; container.style.gap='8px';
  container.appendChild(buildDetailRow('الرمز','a_code', ad?.ref_code||ad?.code||''));
  container.appendChild(buildDetailRow('العنوان','a_name', ad?.name||''));
  container.appendChild(buildDetailRow('الوصف','a_desc', ad?.description||'', true));
  container.appendChild(buildDetailRow('الموقع','a_loc', ad?.location||''));
  container.appendChild(buildDetailRow('التواصل','a_contact', ad?.contact||''));
  container.appendChild(buildDetailRow('التصنيف','a_cat', ad?.category||''));
  const fileRow = document.createElement('div'); fileRow.className='detailRow'; const lbl = document.createElement('label'); lbl.className='small'; lbl.textContent='صورة'; fileRow.appendChild(lbl); const fileInput = document.createElement('input'); fileInput.type='file'; fileInput.accept='image/*'; fileInput.id='a_file'; fileRow.appendChild(fileInput); container.appendChild(fileRow);
  const actions = document.createElement('div'); actions.style.display='flex'; actions.style.gap='8px'; actions.style.justifyContent='flex-end';
  const saveBtn = document.createElement('button'); saveBtn.textContent = mode==='new' ? 'إضافة' : 'حفظ'; saveBtn.onclick = async ()=>{
    const cfg = readCfg(); const pat = sessionPat; const repo = cfg.repo; const branch = cfg.branch||'main'; if(!pat||!repo) return alert('ضع repo وPAT الجلسة ثم احفظ الإعدادات');
    try{
      const raw = await ghRaw(repo, 'static/ads.json', branch); const arr = raw ? JSON.parse(raw) : [];
      const file = document.getElementById('a_file').files[0];
      let imgPath = ad?.image || ''; let thumbPath = ad?.thumb || '';
      if(file){ const safe = sanitizeFilename(file.name); const fullName = `${(document.getElementById('a_code').value.trim() || 'img' + Date.now())}-${safe}`; const thumbName = `${(document.getElementById('a_code').value.trim() || 'img' + Date.now())}-thumb-${safe}`; const optFull = await optimizeImageFile(file, OPT_FULL); await ghPut(pat, repo, `static/images/${fullName}`, optFull.base64, `upload ${fullName}`, branch); const optThumb = await optimizeImageFile(file, OPT_THUMB); await ghPut(pat, repo, `static/images/thumbs/${thumbName}`, optThumb.base64, `upload ${thumbName}`, branch); if(mode!=='new' && ad && ad.image && ad.image !== `static/images/${fullName}`){ await maybeDeleteImage(readCfg(), ad.image); if(ad.thumb) await maybeDeleteImage(readCfg(), ad.thumb); } imgPath = `static/images/${fullName}`; thumbPath = `static/images/thumbs/${thumbName}`; }
      const obj = { ref_code: document.getElementById('a_code').value.trim() || ('c' + Date.now().toString(36).slice(-6)), code: document.getElementById('a_code').value.trim() || ('c' + Date.now().toString(36).slice(-6)), name: document.getElementById('a_name').value.trim(), description: document.getElementById('a_desc').value.trim(), location: document.getElementById('a_loc').value.trim(), contact: document.getElementById('a_contact').value.trim(), category: document.getElementById('a_cat').value.trim(), image: imgPath, thumb: thumbPath, created_at: ad?.created_at || new Date().toISOString() };
      if(mode==='new') arr.unshift(obj); else arr[idx] = obj;
      await ghPut(pat, repo, 'static/ads.json', btoa(unescape(encodeURIComponent(JSON.stringify(arr)))), mode==='new'?'add ad':'update ad', branch);
      alert('تم الحفظ'); loadAll(); detailEl.innerHTML='حدد إعلاناً أو مقترحاً لعرض التفاصيل';
    }catch(e){ alert('خطأ: ' + e.message); console.error(e); }
  };
  const cancelBtn = document.createElement('button'); cancelBtn.textContent='إلغاء'; cancelBtn.className='alt'; cancelBtn.onclick = ()=> { detailEl.innerHTML = 'حدد إعلاناً أو مقترحاً لعرض التفاصيل'; };
  actions.appendChild(saveBtn); actions.appendChild(cancelBtn); container.appendChild(actions); detailEl.appendChild(container);
}

async function deleteAd(idx){ if(!confirm('حذف الإعلان؟')) return; const cfg = readCfg(); const pat = sessionPat; const repo = cfg.repo; const branch = cfg.branch||'main'; if(!pat||!repo) return alert('ضع repo وPAT الجلسة ثم احفظ الإعدادات'); try{ const raw = await ghRaw(repo, 'static/ads.json', branch); const arr = raw ? JSON.parse(raw) : []; const img = arr[idx]?.image || ''; const thumb = arr[idx]?.thumb || ''; if(img) await maybeDeleteImage(readCfg(), img); if(thumb) await maybeDeleteImage(readCfg(), thumb); arr.splice(idx,1); await ghPut(pat, repo, 'static/ads.json', btoa(unescape(encodeURIComponent(JSON.stringify(arr)))), 'delete ad', branch); alert('تم الحذف'); loadAll(); }catch(e){ alert('خطأ: ' + e.message); console.error(e); } }

/* search/filter */
function filterAds(q){ q = (q||'').trim().toLowerCase(); (async ()=>{ try{ const arr = cache.ads || (await (async ()=>{ const raw = await ghRaw(readCfg().repo, 'static/ads.json', readCfg().branch||'main'); const a = raw? JSON.parse(raw):[]; cache.ads = a; return a; })()); if(!q) return renderAds(arr); const filtered = arr.filter(a => (a.ref_code||a.code||'').toLowerCase().includes(q) || (a.name||'').toLowerCase().includes(q) || (a.location||'').toLowerCase().includes(q)); renderAds(filtered); }catch(e){ console.warn(e); } })(); }

/* utilities */
function escapeHtml(s){ return String(s||'').replace(/[&<>"]+/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]||c)); }
function sanitizeFilename(s){ return (s||'').replace(/[^a-z0-9.\-\_]/ig,'_').slice(0,120); }

// modal helpers
function showModal(htmlContent, onReady){ const m=document.getElementById('modal'); const inner=document.getElementById('modalInner'); inner.innerHTML = htmlContent; m.style.display='flex'; if(typeof onReady==='function') onReady(); }
function closeModal(){ document.getElementById('modal').style.display='none'; document.getElementById('modalInner').innerHTML=''; }

/* init */
(async function init(){ setUiFromCfg(); const cfg = readCfg(); if(cfg.repo){ loadAll(); } })();

</script>
</body>
</html>
