<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>لوحة الإدارة — Ads (static)</title>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;700&display=swap" rel="stylesheet">
<style>
  *{font-family:"Tajawal",sans-serif}
  body{margin:16px;background:#f4f6fa;color:#222}
  .wrap{max-width:1200px;margin:0 auto}
  .top{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:12px}
  input,select,textarea{padding:10px;border:1px solid #ddd;border-radius:8px}
  button{padding:10px;border-radius:8px;border:none;background:#0078d7;color:#fff;cursor:pointer}
  .cols{display:grid;grid-template-columns:1fr 420px;gap:12px}
  .panel{background:#fff;padding:12px;border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,0.06)}
  .list{max-height:520px;overflow:auto}
  .item{display:flex;gap:12px;border-bottom:1px solid #f0f0f0;padding:10px 0;align-items:center}
  .thumb{width:96px;height:72px;object-fit:cover;border-radius:6px}
  .meta{flex:1}
  .actions{display:flex;gap:8px}
  .muted{color:#666;font-size:13px}
  .proposal{background:#fff;padding:10px;border-radius:8px;margin-bottom:8px;border:1px solid #eee}
  pre{background:#f7f8fb;padding:8px;border-radius:6px;overflow:auto}
  #logout{background:#d33}
  #status{margin-left:8px;color:#666}
  .field{margin-top:8px}
  .detailRow{display:flex;gap:8px;align-items:center;margin-bottom:8px}
  label.small{font-size:13px;color:#444}
</style>
</head>
<body>
<div class="wrap">
  <h2>لوحة الإدارة — الإعلانات (Static GitHub)</h2>

  <div class="top">
    <input id="cfg_repo" placeholder="owner/repo (مثال: user/repo)" style="width:280px">
    <input id="cfg_branch" placeholder="branch (main)" style="width:100px" value="main">
    <input id="cfg_pat" placeholder="الصق GitHub PAT هنا (repo scope)" style="width:360px">
    <label style="display:flex;align-items:center;gap:8px"><input type="checkbox" id="allowPublic"> سماح للإرسال العام</label>
    <button id="saveCfg">حفظ</button>
    <button id="logout">مسح PAT</button>
    <span id="status" class="muted"></span>
  </div>

  <div class="cols">
    <div>
      <div class="panel">
        <h3>الإعلانات الحالية</h3>
        <div id="adsList" class="list"><div class="muted">لم تُحمّل حتى يتم التحقق من PAT و repo</div></div>
        <div style="margin-top:10px"><button id="newBtn">إضافة إعلان جديد</button></div>
      </div>

      <div class="panel" style="margin-top:12px">
        <h3>مقترحات الزوار (proposals)</h3>
        <div id="proposalsList"><div class="muted">لم تُحمّل حتى يتم التحقق من PAT و repo</div></div>
      </div>
    </div>

    <div>
      <div class="panel">
        <h3>تفاصيل / معاينة</h3>
        <div id="detail">حدد مقترح أو إعلان لعرض التفاصيل</div>
      </div>
    </div>
  </div>
</div>

<!-- modal for add/edit ad -->
<div id="modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);align-items:center;justify-content:center">
  <div style="background:#fff;padding:14px;border-radius:10px;max-width:640px;width:100%">
    <h3 id="modalTitle">إضافة / تعديل الإعلان</h3>
    <div class="field"><input id="m_code" placeholder="الرمز (اتركه لتوليد تلقائي)"></div>
    <div class="field"><input id="m_name" placeholder="العنوان"></div>
    <div class="field"><textarea id="m_desc" placeholder="الوصف" rows="3"></textarea></div>
    <div class="field"><input id="m_loc" placeholder="الموقع"></div>
    <div class="field"><input id="m_contact" placeholder="التواصل"></div>
    <div class="field"><input id="m_cat" placeholder="التصنيف"></div>
    <div class="field"><label>صورة: <input id="m_file" type="file" accept="image/*"></label></div>
    <div style="margin-top:12px;text-align:right">
      <button id="saveBtn">حفظ</button>
      <button id="cancelBtn" style="background:#999">إلغاء</button>
    </div>
  </div>
</div>

<script>
/* ---------- Utilities & config ---------- */
const CFG_KEY = 'static_ads_cfg_v1';
function readCfg(){ try{ return JSON.parse(localStorage.getItem(CFG_KEY)||'{}'); }catch(e){ return {}; } }
function saveCfgObj(o){ localStorage.setItem(CFG_KEY, JSON.stringify(o)); }
function clearPAT(){ const c = readCfg(); delete c.pat; localStorage.setItem(CFG_KEY, JSON.stringify(c)); updateStatus('PAT محذوف'); setUiFromCfg(); }
function updateStatus(s){ const el = document.getElementById('status'); el.textContent = s; setTimeout(()=>{ if(el.textContent===s) el.textContent=''; }, 4200); }

function setUiFromCfg(){
  const c = readCfg();
  document.getElementById('cfg_repo').value = c.repo || '';
  document.getElementById('cfg_branch').value = c.branch || 'main';
  document.getElementById('cfg_pat').value = c.pat || '';
  document.getElementById('allowPublic').checked = !!c.allow_public_submissions;
}
setUiFromCfg();

/* ---------- GitHub helpers ---------- */
async function ghApiGetWithPat(pat, repo, path, branch='main'){
  const [owner, rname] = repo.split('/');
  const url = `https://api.github.com/repos/${owner}/${rname}/contents/${encodeURIComponent(path)}?ref=${encodeURIComponent(branch)}`;
  const res = await fetch(url, { headers: pat ? { Authorization: 'token ' + pat } : {} });
  return res;
}
async function ghRaw(repo, path, branch='main'){
  const url = `https://raw.githubusercontent.com/${repo}/${branch}/${path}`;
  const r = await fetch(url);
  if(!r.ok) return null;
  return await r.text();
}
async function ghPut(pat, repo, path, base64content, message, branch='main', alreadyBase64=false){
  const [owner, rname] = repo.split('/');
  const url = `https://api.github.com/repos/${owner}/${rname}/contents/${encodeURIComponent(path)}`;
  const headers = { Authorization: 'token ' + pat, Accept: 'application/vnd.github.v3+json' };
  // get sha if exists
  let sha = null;
  try{
    const meta = await ghApiGetWithPat(pat, repo, path, branch);
    if(meta.status === 200) {
      const mj = await meta.json();
      sha = mj.sha;
    }
  }catch(e){}
  const body = { message, content: alreadyBase64 ? base64content : btoa(unescape(encodeURIComponent(base64content))), branch };
  if(sha) body.sha = sha;
  const res = await fetch(url, { method:'PUT', headers, body: JSON.stringify(body) });
  const j = await res.json();
  if(!res.ok) throw new Error('PUT failed: ' + (j && j.message ? j.message : JSON.stringify(j)));
  return j;
}
async function ghDelete(pat, repo, path, message, branch='main'){
  const metaRes = await ghApiGetWithPat(pat, repo, path, branch);
  if(metaRes.status !== 200) throw new Error('file not found or permission denied');
  const meta = await metaRes.json();
  const [owner, rname] = repo.split('/');
  const url = `https://api.github.com/repos/${owner}/${rname}/contents/${encodeURIComponent(path)}`;
  const res = await fetch(url, { method:'DELETE', headers: { Authorization: 'token ' + pat, Accept: 'application/vnd.github.v3+json' }, body: JSON.stringify({ message, sha: meta.sha, branch }) });
  if(!res.ok) throw new Error('Delete failed: ' + await res.text());
  return await res.json();
}

/* ---------- Validate config (PAT + repo) ---------- */
async function validateAndSave(){
  const repo = document.getElementById('cfg_repo').value.trim();
  const branch = document.getElementById('cfg_branch').value.trim() || 'main';
  const pat = document.getElementById('cfg_pat').value.trim();
  const allow = document.getElementById('allowPublic').checked;
  if(!repo) return alert('أدخل owner/repo (مثال: user/repo)');
  if(!pat) return alert('الصق PAT صالحاً');
  updateStatus('جارٍ التحقق من PAT ...');
  try{
    // check access to static/ads.json using PAT (permissions)
    const res = await ghApiGetWithPat(pat, repo, 'static/ads.json', branch);
    if(res.status === 200 || res.status === 404){
      // 200 -> file exists; 404 -> file missing but token is valid for checking; need to ensure auth succeeded (GitHub returns 404 for not found even with auth)
      // but 401/403 are failures.
      if(res.status === 200){
        // allowed & found
        saveCfgObj({ repo, branch, pat, allow_public_submissions: allow });
        updateStatus('تم التحقق والحفظ');
        setUiFromCfg();
        loadAll();
      } else if(res.status === 404){
        // The token worked but file not found: still ok (we can create ads.json). But confirm token scope by hitting repo endpoint
        saveCfgObj({ repo, branch, pat, allow_public_submissions: allow });
        updateStatus('تم التحقق (ads.json غير موجود) - سيتم إنشاؤه عند الحاجة');
        loadAll();
      } else {
        saveCfgObj({ repo, branch, pat, allow_public_submissions: allow });
        loadAll();
      }
    } else if(res.status === 401 || res.status === 403){
      const txt = await res.text().catch(()=>'');

      updateStatus('فشل التحقق: PAT غير صالح أو لا يوجد إذن');
      alert('فشل التحقق: PAT غير صالح أو لا يوجد إذن (رمز ' + res.status + '). تأكد من الصلاحيات.');
    } else {
      const txt = await res.text().catch(()=>'');
      updateStatus('خطأ أثناء التحقق');
      alert('خطأ أثناء التحقق: ' + res.status + ' ' + txt);
    }
  }catch(err){
    updateStatus('خطأ في التحقق');
    alert('خطأ عند التحقق: ' + err.message);
  }
}

/* ---------- UI wiring ---------- */
document.getElementById('saveCfg').addEventListener('click', validateAndSave);
document.getElementById('logout').addEventListener('click', ()=> { if(confirm('مسح PAT من المتصفح؟')) { clearPAT(); } });

/* ---------- Load lists (only after valid config saved) ---------- */
const adsList = document.getElementById('adsList');
const proposalsList = document.getElementById('proposalsList');
const detail = document.getElementById('detail');

async function loadAll(){
  // read stored config and only proceed if PAT+repo exist
  const cfg = readCfg();
  const repo = cfg.repo; const pat = cfg.pat; const branch = cfg.branch || 'main';
  if(!repo || !pat){ adsList.innerHTML = '<div class="muted">أدخل repo وPAT ثم اضغط حفظ لرؤية الإعلانات</div>'; proposalsList.innerHTML = '<div class="muted">أدخل repo وPAT ثم اضغط حفظ لرؤية المقترحات</div>'; return; }
  // token exists; attempt to fetch ads.json and proposals
  await loadAds();
  await loadProposals();
}

async function loadAds(){
  adsList.innerHTML = 'تحميل...';
  const cfg = readCfg(); const repo = cfg.repo; const branch = cfg.branch || 'main';
  if(!repo) { adsList.innerHTML = '<div class="muted">حدد repo وPAT ثم اضغط حفظ</div>'; return; }
  try{
    const raw = await ghRaw(repo, 'static/ads.json', branch);
    const arr = raw ? JSON.parse(raw) : [];
    renderAds(arr);
  }catch(e){
    adsList.innerHTML = '<div class="muted">فشل جلب ads.json — تحقق من الإعدادات</div>';
  }
}

function renderAds(items){
  adsList.innerHTML = '';
  if(!items || items.length===0){ adsList.innerHTML = '<div class="muted">لا توجد إعلانات</div>'; return; }
  items.forEach((a, idx)=>{
    const el = document.createElement('div'); el.className='item';
    el.innerHTML = `<img class="thumb" src="${a.thumb||a.image||''}">
      <div class="meta"><strong>${escapeHtml(a.name||a.code||('ad'+idx))}</strong><div class="muted">${escapeHtml(a.description||'')}</div></div>
      <div class="actions"><button class="editBtn">تعديل</button><button class="delBtn" style="background:#d33">حذف</button></div>`;
    el.querySelector('.editBtn').onclick = ()=> openEdit(a, idx);
    el.querySelector('.delBtn').onclick = ()=> deleteAd(idx);
    adsList.appendChild(el);
  });
}

/* ---------- Proposals ---------- */
async function loadProposals(){
  proposalsList.innerHTML = 'تحميل...';
  const cfg = readCfg(); const repo = cfg.repo; const branch = cfg.branch || 'main'; const pat = cfg.pat;
  if(!repo || !pat) { proposalsList.innerHTML = '<div class="muted">حدد repo وPAT ثم اضغط حفظ</div>'; return; }
  try{
    const [owner, repoName] = repo.split('/');
    const url = `https://api.github.com/repos/${owner}/${repoName}/contents/static/proposals?ref=${encodeURIComponent(branch)}`;
    const res = await fetch(url, { headers: { Authorization: 'token ' + pat } });
    if(res.status === 404){ proposalsList.innerHTML = '<div class="muted">لا توجد مقترحات</div>'; return; }
    if(!res.ok) throw new Error('list error ' + res.status);
    const list = await res.json();
    const jsonFiles = list.filter(f => f.name.endsWith('.json'));
    proposalsList.innerHTML = '';
    for(const f of jsonFiles){
      const raw = await fetch(f.download_url, { headers: { Authorization: 'token ' + pat } }).then(r=>r.json()).catch(()=>null);
      const item = raw || {};
      const el = document.createElement('div'); el.className='proposal';
      el.innerHTML = `<div style="display:flex;justify-content:space-between"><div><strong>${escapeHtml(item.ref_code||f.name)}</strong></div><div class="muted">${escapeHtml(item.created_at||'')}</div></div>
        <div class="small">${escapeHtml(item.description||'')}</div>
        <div style="margin-top:8px"><button class="viewBtn">عرض وتحرير</button><button class="acceptBtn" style="background:#2a9d8f">قبول وتضمين</button><button class="rejectBtn" style="background:#d33">رفض</button></div>`;
      el.querySelector('.viewBtn').onclick = ()=> showProposalDetail(item, f.name);
      el.querySelector('.acceptBtn').onclick = async ()=>{
        if(!confirm('قبول المقترح ونقله إلى ads.json؟')) return;
        try{ await acceptProposal(readCfg(), f.name, item); alert('تم القبول'); loadAll(); } catch(e){ alert('خطأ: ' + e.message); }
      };
      el.querySelector('.rejectBtn').onclick = async ()=>{
        if(!confirm('رفض المقترح وحذفه؟')) return;
        try{ await deleteProposal(readCfg(), f.name); alert('تم الحذف'); loadAll(); } catch(e){ alert('خطأ: ' + e.message); }
      };
      proposalsList.appendChild(el);
    }
    if(jsonFiles.length===0) proposalsList.innerHTML = '<div class="muted">لا توجد مقترحات</div>';
  }catch(e){
    proposalsList.innerHTML = '<div class="muted">فشل جلب المقترحات</div>';
  }
}

/* ---------- Show + Edit proposal detail ---------- */
function showProposalDetail(item, filename){
  // build editable UI in detail pane
  const repo = readCfg().repo;
  const branch = readCfg().branch || 'main';
  let imgHtml = '';
  if(item.image){
    // if image path starts with /static or static/ build raw.githubusercontent url
    let imgPath = item.image;
    if(imgPath.startsWith('/')) imgPath = imgPath.replace(/^\//,'');
    if(!imgPath.startsWith('http')) {
      imgHtml = `<div style="margin-bottom:8px"><img src="https://raw.githubusercontent.com/${repo}/${branch}/${imgPath}" style="max-width:100%;border-radius:8px"></div>`;
    } else {
      imgHtml = `<div style="margin-bottom:8px"><img src="${item.image}" style="max-width:100%;border-radius:8px"></div>`;
    }
  }
  detail.innerHTML = `
    ${imgHtml}
    <div class="detailRow"><label class="small">الرمز</label><input id="p_code" value="${escapeAttr(item.ref_code||item.code||'')}" style="flex:1"></div>
    <div class="detailRow"><label class="small">العنوان</label><input id="p_name" value="${escapeAttr(item.name||'')}" style="flex:1"></div>
    <div class="detailRow"><label class="small">الوصف</label><textarea id="p_desc" rows="3" style="flex:1">${escapeAttr(item.description||'')}</textarea></div>
    <div class="detailRow"><label class="small">الموقع</label><input id="p_loc" value="${escapeAttr(item.location||'')}" style="flex:1"></div>
    <div class="detailRow"><label class="small">التواصل</label><input id="p_contact" value="${escapeAttr(item.contact||'')}" style="flex:1"></div>
    <div class="detailRow"><label class="small">التصنيف</label><input id="p_cat" value="${escapeAttr(item.category||'')}" style="flex:1"></div>
    <div class="detailRow"><label class="small">تغيير الصورة</label><input id="p_file" type="file" accept="image/*"></div>
    <div style="display:flex;gap:8px;margin-top:8px;justify-content:flex-end">
      <button id="saveProposalBtn">تعديل وحفظ</button>
      <button id="acceptProposalBtn" style="background:#2a9d8f">قبول وتضمين</button>
      <button id="deleteProposalBtn" style="background:#d33">رفض وحذف</button>
    </div>
  `;
  // wire buttons
  document.getElementById('saveProposalBtn').onclick = async ()=>{
    try{
      const updated = await buildProposalFromDetail(item);
      await updateProposalFile(readCfg(), filename, updated);
      alert('تم تعديل المقترح');
      loadAll();
    }catch(e){ alert('خطأ في حفظ المقترح: ' + e.message); }
  };
  document.getElementById('acceptProposalBtn').onclick = async ()=>{
    if(!confirm('قبول وتضمين المقترح؟')) return;
    try{
      const updated = await buildProposalFromDetail(item);
      await acceptProposal(readCfg(), filename, updated);
      alert('تم القبول والتضمين');
      loadAll();
    }catch(e){ alert('خطأ في القبول: ' + e.message); }
  };
  document.getElementById('deleteProposalBtn').onclick = async ()=>{
    if(!confirm('رفض المقترح وحذفه؟')) return;
    try{ await deleteProposal(readCfg(), filename); alert('تم الحذف'); loadAll(); }catch(e){ alert('خطأ: ' + e.message); }
  };
}

// helper to assemble proposal object from detail inputs (and possibly upload image)
async function buildProposalFromDetail(originalItem){
  const cfg = readCfg(); const pat = cfg.pat; const repo = cfg.repo; const branch = cfg.branch || 'main';
  const updated = Object.assign({}, originalItem);
  updated.ref_code = document.getElementById('p_code').value.trim() || updated.ref_code || ('p'+Date.now().toString(36));
  updated.name = document.getElementById('p_name').value.trim();
  updated.description = document.getElementById('p_desc').value.trim();
  updated.location = document.getElementById('p_loc').value.trim();
  updated.contact = document.getElementById('p_contact').value.trim();
  updated.category = document.getElementById('p_cat').value.trim();
  updated.created_at = updated.created_at || new Date().toISOString();
  const file = document.getElementById('p_file').files[0];
  if(file){
    if(!pat || !repo) throw new Error('PAT و repo مطلوبان لتحميل الصورة');
    const imgName = `${updated.ref_code}-${file.name.replace(/[^a-z0-9.\-_]/ig,'_')}`;
    const dataUrl = await toBase64(file); const base64 = dataUrl.split(',')[1];
    await ghPut(pat, repo, `static/images/${imgName}`, base64, `upload ${imgName}`, branch, true);
    updated.image = `/static/images/${imgName}`;
    updated.thumb = updated.image;
  }
  return updated;
}

// update proposal JSON file contents
async function updateProposalFile(cfg, filename, obj){
  const pat = cfg.pat; const repo = cfg.repo; const branch = cfg.branch || 'main';
  const base64 = btoa(unescape(encodeURIComponent(JSON.stringify(obj))));
  return await ghPut(pat, repo, `static/proposals/${filename}`, base64, `update proposal ${obj.ref_code||filename}`, branch, true);
}

/* ---------- accept / delete ---------- */
async function acceptProposal(cfg, filename, item){
  const pat = cfg.pat; const repo = cfg.repo; const branch = cfg.branch || 'main';
  if(!pat) throw new Error('PAT مطلوب');
  // load ads.json, insert item (sanitizing fields)
  const raw = await ghRaw(repo, 'static/ads.json', branch);
  const arr = raw ? JSON.parse(raw) : [];
  const ad = {
    code: item.ref_code || ('p'+Date.now().toString(36)),
    name: item.name || '',
    description: item.description || '',
    location: item.location || '',
    contact: item.contact || '',
    category: item.category || '',
    image: item.image || '',
    thumb: item.thumb || item.image || '',
    created_at: new Date().toISOString()
  };
  arr.unshift(ad);
  await ghPut(pat, repo, 'static/ads.json', btoa(unescape(encodeURIComponent(JSON.stringify(arr)))), 'accept proposal ' + (item.ref_code||filename), branch, true);
  // delete proposal file
  await deleteProposal(cfg, filename);
}

async function deleteProposal(cfg, filename){
  const pat = cfg.pat; const repo = cfg.repo; const branch = cfg.branch || 'main';
  return await ghDelete(pat, repo, 'static/proposals/' + filename, 'reject proposal ' + filename, branch);
}

/* ---------- Add / edit / delete ads ---------- */

document.getElementById('newBtn').onclick = ()=> openAddModal();

function openAddModal(){
  document.getElementById('modal').style.display = 'flex';
  document.getElementById('modalTitle').innerText = 'إضافة إعلان جديد';
  document.getElementById('m_code').value=''; document.getElementById('m_name').value=''; document.getElementById('m_desc').value='';
  document.getElementById('m_loc').value=''; document.getElementById('m_contact').value=''; document.getElementById('m_cat').value='';
  document.getElementById('saveBtn').onclick = async ()=>{
    const cfg = readCfg(); const pat = cfg.pat; const repo = cfg.repo; const branch = cfg.branch || 'main';
    if(!pat || !repo) return alert('ضع repo وPAT ثم احفظ الإعدادات');
    try{
      const raw = await ghRaw(repo, 'static/ads.json', branch);
      const arr = raw ? JSON.parse(raw) : [];
      const file = document.getElementById('m_file').files[0];
      let imgPath = '';
      if(file){
        const imgName = 'img' + Date.now() + '-' + file.name.replace(/[^a-z0-9.\-_]/ig,'_');
        const dataUrl = await toBase64(file); const base64 = dataUrl.split(',')[1];
        await ghPut(pat, repo, `static/images/${imgName}`, base64, `upload ${imgName}`, branch, true);
        imgPath = `/static/images/${imgName}`;
      }
      const newObj = {
        code: document.getElementById('m_code').value.trim() || ('c' + Date.now().toString(36).slice(-6)),
        name: document.getElementById('m_name').value.trim(),
        description: document.getElementById('m_desc').value.trim(),
        location: document.getElementById('m_loc').value.trim(),
        contact: document.getElementById('m_contact').value.trim(),
        category: document.getElementById('m_cat').value.trim(),
        image: imgPath,
        thumb: imgPath,
        created_at: new Date().toISOString()
      };
      arr.unshift(newObj);
      await ghPut(pat, repo, 'static/ads.json', btoa(unescape(encodeURIComponent(JSON.stringify(arr)))), 'add ad', branch, true);
      alert('تم الإضافة');
      document.getElementById('modal').style.display='none';
      loadAll();
    }catch(e){ alert('خطأ: ' + e.message); }
  };
}

function openEdit(ad, idx){
  document.getElementById('modal').style.display = 'flex';
  document.getElementById('modalTitle').innerText = 'تعديل الإعلان';
  document.getElementById('m_code').value = ad.code || '';
  document.getElementById('m_name').value = ad.name || '';
  document.getElementById('m_desc').value = ad.description || '';
  document.getElementById('m_loc').value = ad.location || '';
  document.getElementById('m_contact').value = ad.contact || '';
  document.getElementById('m_cat').value = ad.category || '';

  document.getElementById('saveBtn').onclick = async ()=>{
    const cfg = readCfg(); const pat = cfg.pat; const repo = cfg.repo; const branch = cfg.branch || 'main';
    if(!pat || !repo) return alert('ضع repo وPAT ثم احفظ الإعدادات');
    try{
      const raw = await ghRaw(repo, 'static/ads.json', branch);
      const arr = raw ? JSON.parse(raw) : [];
      const file = document.getElementById('m_file').files[0];
      if(file){
        const imgName = (document.getElementById('m_code').value.trim() || ('img'+Date.now())) + '-' + file.name.replace(/[^a-z0-9.\-_]/ig,'_');
        const dataUrl = await toBase64(file); const base64 = dataUrl.split(',')[1];
        await ghPut(pat, repo, `static/images/${imgName}`, base64, `upload ${imgName}`, branch, true);
        arr[idx].image = `/static/images/${imgName}`; arr[idx].thumb = arr[idx].image;
      }
      arr[idx] = {
        code: document.getElementById('m_code').value.trim(),
        name: document.getElementById('m_name').value.trim(),
        description: document.getElementById('m_desc').value.trim(),
        location: document.getElementById('m_loc').value.trim(),
        contact: document.getElementById('m_contact').value.trim(),
        category: document.getElementById('m_cat').value.trim(),
        image: arr[idx].image || '',
        thumb: arr[idx].thumb || '',
        created_at: arr[idx].created_at || new Date().toISOString()
      };
      await ghPut(pat, repo, 'static/ads.json', btoa(unescape(encodeURIComponent(JSON.stringify(arr)))), 'update ad', branch, true);
      alert('تم الحفظ');
      document.getElementById('modal').style.display='none';
      loadAll();
    }catch(e){ alert('خطأ: ' + e.message); }
  };
}

async function deleteAd(idx){
  if(!confirm('حذف الإعلان؟')) return;
  const cfg = readCfg(); const pat = cfg.pat; const repo = cfg.repo; const branch = cfg.branch || 'main';
  if(!pat || !repo) return alert('ضع repo وPAT ثم احفظ الإعدادات');
  try{
    const raw = await ghRaw(repo, 'static/ads.json', branch);
    const arr = raw ? JSON.parse(raw) : [];
    arr.splice(idx,1);
    await ghPut(pat, repo, 'static/ads.json', btoa(unescape(encodeURIComponent(JSON.stringify(arr)))), 'delete ad', branch, true);
    alert('تم الحذف');
    loadAll();
  }catch(e){ alert('خطأ: ' + e.message); }
}

/* ---------- small helpers ---------- */
function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
function escapeAttr(s){ return (s||'').replace(/"/g,'&quot;').replace(/</g,'&lt;'); }
function toBase64(file){ return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file); }); }

/* ---------- initial load ---------- */
async function loadAllInit(){
  // if a config with PAT exists, try using it to load lists
  setUiFromCfg();
  const cfg = readCfg();
  if(cfg.repo && cfg.pat) {
    // attempt a quick validation call (silent)
    try{
      const check = await ghApiGetWithPat(cfg.pat, cfg.repo, 'static/ads.json', cfg.branch||'main');
      if(check.status === 401 || check.status === 403) {
        updateStatus('PAT غير صالح أو لم يُمنح الإذن');
        return;
      }
      // OK load
      loadAll();
    }catch(e){}
  }
}
loadAllInit();

</script>
</body>
</html>
