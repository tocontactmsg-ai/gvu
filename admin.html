<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>لوحة الإدارة — إعلانات (Static)</title>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;700&display=swap" rel="stylesheet">
<style>
  :root{--bg:#f5f7fb;--card:#fff;--accent:#0b69d6;--danger:#d33;--muted:#59656f}
  *{box-sizing:border-box;font-family:"Tajawal",sans-serif}
  body{margin:14px;background:var(--bg);color:#07203a}
  .wrap{max-width:1100px;margin:0 auto}
  header{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:12px}
  header h1{margin:0;font-size:20px}
  .cfg{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  input,select,textarea,button{font-size:14px}
  input,select,textarea{padding:8px;border-radius:8px;border:1px solid #e6eef8}
  button{padding:8px 10px;border-radius:8px;border:none;background:var(--accent);color:#fff;cursor:pointer}
  button.alt{background:#6b7280}
  button.danger{background:var(--danger)}
  .cols{display:grid;grid-template-columns:1fr 420px;gap:12px}
  .panel{background:var(--card);padding:12px;border-radius:10px;box-shadow:0 10px 24px rgba(9,30,66,0.06)}
  .list{max-height:520px;overflow:auto}
  .item{display:flex;gap:10px;border-bottom:1px solid #f2f4f7;padding:10px 0;align-items:center}
  .thumb{width:96px;height:72px;object-fit:cover;border-radius:6px;background:#f4f6f9}
  .meta{flex:1}
  .muted{color:var(--muted);font-size:13px}
  .actions{display:flex;gap:8px}
  .detailRow{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px}
  label.small{font-size:13px;color:#333;min-width:90px}
  input[type=file]{padding:4px}
  pre{background:#fbfdff;padding:8px;border-radius:6px;overflow:auto}
  .note{font-size:13px;color:var(--muted);margin-top:6px}
  .hidden{display:none}
  .acceptModal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.5);z-index:60}
  .acceptModal .box{background:#fff;padding:12px;border-radius:8px;min-width:320px;max-width:90%}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>لوحة الإدارة — الإعلانات (Static GitHub)</h1>
    <div class="cfg">
      <input id="cfg_repo" placeholder="owner/repo (مثال: user/repo)" style="width:220px">
      <input id="cfg_branch" placeholder="branch" style="width:80px" value="main">
      <input id="cfg_pat" placeholder="الصق GitHub PAT هنا" style="width:300px">
      <label style="display:flex;align-items:center;gap:6px"><input type="checkbox" id="allowPublic"> <span class="muted">سماح للإرسال العام</span></label>
      <button id="saveBtn">حفظ</button>
      <button id="clearBtn" class="alt">مسح PAT</button>
    </div>
  </header>

  <div class="cols">
    <div>
      <div class="panel" style="margin-bottom:12px">
        <h3 style="margin:0 0 8px">الإعلانات الحالية</h3>
        <div id="adsList" class="list"><div class="muted">لم تُحمّل — ادخل repo وPAT ثم اضغط حفظ</div></div>
        <div style="margin-top:10px"><button id="newAdBtn">إضافة إعلان جديد</button></div>
      </div>

      <div class="panel">
        <h3 style="margin:0 0 8px">مقترحات الزوار (proposals)</h3>
        <div id="proposalsList" class="list"><div class="muted">لم تُحمّل — ادخل repo وPAT ثم اضغط حفظ</div></div>
      </div>
    </div>

    <div>
      <div class="panel">
        <h3 style="margin:0 0 8px">تفاصيل / معاينة</h3>
        <div id="detail">حدد إعلاناً أو مقترحاً لعرض التفاصيل</div>
      </div>
    </div>
  </div>
</div>

<div id="acceptModal" class="acceptModal">
  <div class="box">
    <div style="margin-bottom:8px">أدخل الرمز النهائي الذي تريد استخدامه (اتركه فارغاً لاستخدام رمز المقترح):</div>
    <input id="finalCodeInput" placeholder="رمز نهائي (مثال: AD001)" style="width:100%;padding:8px;border-radius:6px;border:1px solid #e6eef8">
    <div style="text-align:left;margin-top:10px">
      <button id="confirmAcceptBtn">قبول وتضمين</button>
      <button id="cancelAcceptBtn" class="alt">إلغاء</button>
    </div>
  </div>
</div>

<script>
/* ---------- Admin script with optimizer & delete-image ---------- */
const CFG_KEY = 'static_ads_cfg_v1';
const OPT_DEFAULTS = { maxWidth: 1600, maxHeight: 1200, quality: 0.78, outputType: 'image/webp' };

function readCfg(){ try{ return JSON.parse(localStorage.getItem(CFG_KEY)||'{}') }catch(e){ return {} } }
function saveCfg(cfg){ localStorage.setItem(CFG_KEY, JSON.stringify(cfg)); }
function updateStatus(msg){ console.log('[status]', msg); }
function normalizePath(p){ if(!p) return ''; return p.startsWith('/') ? p.slice(1) : p; }

function setUiFromCfg(){ const c = readCfg(); document.getElementById('cfg_repo').value = c.repo || ''; document.getElementById('cfg_branch').value = c.branch || 'main'; document.getElementById('cfg_pat').value = c.pat || ''; document.getElementById('allowPublic').checked = !!c.allow_public_submissions; }
setUiFromCfg();

/* ---------- GitHub helpers ---------- */
async function ghApiGetWithPat(pat, repo, path, branch='main'){ const [owner,rname]=repo.split('/'); const url=`https://api.github.com/repos/${owner}/${rname}/contents/${encodeURIComponent(path)}?ref=${encodeURIComponent(branch)}`; return fetch(url,{headers: pat?{Authorization:'token '+pat}:{}}); }
async function ghRaw(repo, path, branch='main'){ const url=`https://raw.githubusercontent.com/${repo}/${branch}/${path}`; const r=await fetch(url); if(!r.ok) return null; return await r.text(); }
async function ghPut(pat, repo, path, base64content, message, branch='main', alreadyBase64=false){ const [owner,rname]=repo.split('/'); const url=`https://api.github.com/repos/${owner}/${rname}/contents/${encodeURIComponent(path)}`; const headers={Authorization:'token '+pat,Accept:'application/vnd.github.v3+json'}; let sha=null; try{ const meta=await ghApiGetWithPat(pat,repo,path,branch); if(meta.status===200){ const mj=await meta.json(); sha=mj.sha } }catch(e){} const body={message,content: alreadyBase64? base64content : btoa(unescape(encodeURIComponent(base64content))), branch}; if(sha) body.sha=sha; const res=await fetch(url,{method:'PUT',headers,body:JSON.stringify(body)}); const j=await res.json(); if(!res.ok) throw new Error('PUT failed: ' + (j && j.message? j.message: JSON.stringify(j))); return j; }
async function ghDelete(pat, repo, path, message, branch='main'){ const metaRes = await ghApiGetWithPat(pat,repo,path,branch); if(metaRes.status !== 200) throw new Error('file not found or permission denied'); const meta = await metaRes.json(); const [owner,rname]=repo.split('/'); const url=`https://api.github.com/repos/${owner}/${rname}/contents/${encodeURIComponent(path)}`; const res = await fetch(url, { method:'DELETE', headers: { Authorization: 'token ' + pat, Accept: 'application/vnd.github.v3+json' }, body: JSON.stringify({ message, sha: meta.sha, branch }) }); if(!res.ok) throw new Error('Delete failed: ' + await res.text()); return await res.json(); }

/* ---------- Image optimizer (same as index) ---------- */
async function optimizeImageFile(file, options = {}) {
  const { maxWidth = OPT_DEFAULTS.maxWidth, maxHeight = OPT_DEFAULTS.maxHeight, quality = OPT_DEFAULTS.quality, outputType = OPT_DEFAULTS.outputType } = options;
  const dataUrl = await new Promise((res, rej) => { const r = new FileReader(); r.onload = () => res(r.result); r.onerror = rej; r.readAsDataURL(file); });
  const img = await new Promise((res, rej) => { const i = new Image(); i.onload = () => res(i); i.onerror = rej; i.src = dataUrl; });
  let { width, height } = img;
  const scale = Math.min(1, maxWidth / width, maxHeight / height);
  const targetW = Math.round(width * scale);
  const targetH = Math.round(height * scale);
  const canvas = document.createElement('canvas'); canvas.width = targetW; canvas.height = targetH;
  const ctx = canvas.getContext('2d'); ctx.imageSmoothingEnabled = true; ctx.imageSmoothingQuality = 'high'; ctx.drawImage(img,0,0,targetW,targetH);
  const blob = await new Promise((res) => canvas.toBlob(res, outputType, quality));
  const base64 = await new Promise((res) => { const fr = new FileReader(); fr.onload = () => res(fr.result.split(',')[1]); fr.readAsDataURL(blob); });
  return { blob, base64, size: blob.size, width: targetW, height: targetH };
}

/* ---------- Delete image helper ---------- */
async function maybeDeleteImage(cfg, imagePath){
  if(!imagePath) return;
  const p = normalizePath(imagePath);
  if(!p) return;
  try{
    const metaRes = await ghApiGetWithPat(cfg.pat, cfg.repo, p, cfg.branch || 'main');
    if(metaRes.status === 200){
      await ghDelete(cfg.pat, cfg.repo, p, 'delete image ' + p, cfg.branch || 'main');
      console.log('deleted image', p);
    } else {
      console.log('image not found or no permission to delete', p, metaRes.status);
    }
  }catch(e){ console.warn('maybeDeleteImage failed', e); }
}

/* ---------- UI wiring ---------- */
document.getElementById('saveBtn').addEventListener('click', validateAndSave);
document.getElementById('clearBtn').addEventListener('click', ()=>{ if(confirm('مسح PAT من المتصفح؟')){ const c = readCfg(); delete c.pat; saveCfg(c); setUiFromCfg(); alert('PAT محذوف'); } });
document.getElementById('newAdBtn').addEventListener('click', ()=> openAdModal('new'));

/* ---------- Validate & load lists ---------- */
async function validateAndSave(){
  const repo = document.getElementById('cfg_repo').value.trim();
  const branch = document.getElementById('cfg_branch').value.trim() || 'main';
  const pat = document.getElementById('cfg_pat').value.trim();
  const allow = document.getElementById('allowPublic').checked;
  if(!repo) return alert('أدخل owner/repo');
  if(!pat) return alert('الصق PAT صالحاً');
  updateStatus('جارٍ التحقق...');
  try{
    const res = await ghApiGetWithPat(pat, repo, 'static/ads.json', branch);
    if(res.status === 200 || res.status === 404){
      saveCfg({ repo, branch, pat, allow_public_submissions: allow });
      setUiFromCfg();
      updateStatus('تم التحقق والحفظ');
      loadAll();
    } else if(res.status === 401 || res.status === 403){
      updateStatus('فشل التحقق: PAT غير صالح أو لا يوجد إذن'); alert('فشل التحقق: PAT غير صالح أو لا يوجد إذن');
    } else { const txt = await res.text().catch(()=>''); updateStatus('خطأ: ' + res.status); alert('خطأ: ' + res.status + ' ' + txt); }
  }catch(err){ updateStatus('خطأ في التحقق'); alert('خطأ عند التحقق: ' + err.message); }
}

const adsListEl = document.getElementById('adsList'), proposalsListEl = document.getElementById('proposalsList'), detailEl = document.getElementById('detail');

async function loadAll(){
  const cfg = readCfg(); if(!cfg.repo || !cfg.pat){ adsListEl.innerHTML = '<div class="muted">أدخل repo وPAT ثم اضغط حفظ</div>'; proposalsListEl.innerHTML = '<div class="muted">أدخل repo وPAT ثم اضغط حفظ</div>'; return; }
  await loadAds(); await loadProposals();
}

async function loadAds(){
  adsListEl.innerHTML = 'تحميل...';
  const cfg = readCfg();
  try{
    const raw = await ghRaw(cfg.repo, 'static/ads.json', cfg.branch || 'main');
    const arr = raw ? JSON.parse(raw) : [];
    renderAds(arr);
  }catch(e){ console.error(e); adsListEl.innerHTML = '<div class="muted">فشل جلب ads.json</div>'; }
}

function renderAds(items){
  adsListEl.innerHTML = '';
  if(!items || items.length === 0){ adsListEl.innerHTML = '<div class="muted">لا توجد إعلانات</div>'; return; }
  items.forEach((a, idx) => {
    const el = document.createElement('div'); el.className='item';
    const thumb = normalizePath(a.thumb || a.image || '');
    el.innerHTML = `<img class="thumb" src="${thumb}" onerror="this.style.display='none'"><div class="meta"><strong>${escapeHtml(a.name||a.code||('ad'+idx))}</strong><div class="muted">${escapeHtml(a.description||'')}</div></div>
      <div class="actions"><button class="viewAdBtn">عرض</button><button class="editAdBtn">تعديل</button><button class="delAdBtn danger">حذف</button></div>`;
    el.querySelector('.viewAdBtn').onclick = ()=> showAdDetail(a, idx);
    el.querySelector('.editAdBtn').onclick = ()=> openAdModal('edit', a, idx);
    el.querySelector('.delAdBtn').onclick = ()=> deleteAd(idx);
    adsListEl.appendChild(el);
  });
}

async function loadProposals(){
  proposalsListEl.innerHTML = 'تحميل...';
  const cfg = readCfg();
  if(!cfg.repo || !cfg.pat){ proposalsListEl.innerHTML = '<div class="muted">حدد repo وPAT ثم اضغط حفظ</div>'; return; }
  try{
    const [owner, repoName] = cfg.repo.split('/');
    const url = `https://api.github.com/repos/${owner}/${repoName}/contents/static/proposals?ref=${encodeURIComponent(cfg.branch || 'main')}`;
    const res = await fetch(url, { headers: { Authorization: 'token ' + cfg.pat } });
    if(res.status === 404){ proposalsListEl.innerHTML = '<div class="muted">لا توجد مقترحات</div>'; return; }
    if(!res.ok) throw new Error('list error ' + res.status);
    const list = await res.json();
    const jsonFiles = list.filter(f => f.name.endsWith('.json'));
    proposalsListEl.innerHTML = '';
    for(const f of jsonFiles){
      const raw = await fetch(f.download_url, { headers: { Authorization: 'token ' + cfg.pat } }).then(r => r.json()).catch(()=>null);
      const item = raw || {};
      const el = document.createElement('div'); el.className='item proposal';
      el.innerHTML = `<div style="flex:1">
        <strong>${escapeHtml(item.ref_code || f.name)}</strong>
        <div class="muted">${escapeHtml(item.created_at||'')}</div>
        <div class="muted">${escapeHtml((item.name||'') + ' — ' + (item.location||''))}</div>
      </div>
      <div style="display:flex;gap:6px">
        <button class="viewPropBtn">عرض/تحرير</button>
        <button class="acceptPropBtn" style="background:#2a9d8f">قبول</button>
        <button class="rejectPropBtn" style="background:var(--danger)">رفض</button>
      </div>`;
      el.querySelector('.viewPropBtn').onclick = ()=> showProposalDetail(item, f.name);
      el.querySelector('.acceptPropBtn').onclick = ()=> startAcceptFlow(item, f.name);
      el.querySelector('.rejectPropBtn').onclick = async ()=> { if(!confirm('رفض المقترح وحذفه؟')) return; try{ await deleteProposal(cfg, f.name); alert('تم الحذف'); loadAll(); }catch(e){ alert('خطأ: ' + e.message) } };
      proposalsListEl.appendChild(el);
    }
    if(jsonFiles.length === 0) proposalsListEl.innerHTML = '<div class="muted">لا توجد مقترحات</div>';
  }catch(e){ console.error(e); proposalsListEl.innerHTML = '<div class="muted">فشل جلب المقترحات</div>'; }
}

/* ---------- Proposal detail (view/edit) ---------- */
function showAdDetail(ad, idx){
  const repo = readCfg().repo; const branch = readCfg().branch || 'main';
  let imgHtml = '';
  if(ad.image){
    const p = normalizePath(ad.image);
    const url = p.startsWith('http') ? p : `https://raw.githubusercontent.com/${repo}/${branch}/${p}`;
    imgHtml = `<div style="margin-bottom:8px"><img src="${url}" style="max-width:100%;border-radius:6px"></div>`;
  }
  detailEl.innerHTML = `${imgHtml}
    <div><strong>${escapeHtml(ad.name||'')}</strong></div>
    <div class="muted">${escapeHtml(ad.description||'')}</div>
    <div style="margin-top:8px" class="muted">رمز: ${escapeHtml(ad.code||'')}</div>`;
}

function showProposalDetail(item, filename){
  const cfg = readCfg(); const repo = cfg.repo; const branch = cfg.branch || 'main';
  let imgHtml = '';
  if(item.image){
    const p = normalizePath(item.image);
    const url = p.startsWith('http') ? p : `https://raw.githubusercontent.com/${repo}/${branch}/${p}`;
    imgHtml = `<div style="margin-bottom:8px"><img src="${url}" style="max-width:100%;border-radius:6px"></div>`;
  }
  detailEl.innerHTML = `
    ${imgHtml}
    <div class="detailRow"><label class="small">الرمز</label><input id="p_code" value="${escapeAttr(item.ref_code||item.code||'')}" style="flex:1"></div>
    <div class="detailRow"><label class="small">العنوان</label><input id="p_name" value="${escapeAttr(item.name||'')}" style="flex:1"></div>
    <div class="detailRow"><label class="small">الوصف</label><textarea id="p_desc" rows="3" style="flex:1">${escapeAttr(item.description||'')}</textarea></div>
    <div class="detailRow"><label class="small">الموقع</label><input id="p_loc" value="${escapeAttr(item.location||'')}" style="flex:1"></div>
    <div class="detailRow"><label class="small">التواصل</label><input id="p_contact" value="${escapeAttr(item.contact||'')}" style="flex:1"></div>
    <div class="detailRow"><label class="small">التصنيف</label><input id="p_cat" value="${escapeAttr(item.category||'')}" style="flex:1"></div>
    <div class="detailRow"><label class="small">تغيير الصورة</label><input id="p_file" type="file" accept="image/*"></div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
      <button id="saveProposalBtn">تعديل وحفظ</button>
      <button id="acceptProposalBtn" style="background:#2a9d8f">قبول وتضمين</button>
      <button id="deleteProposalBtn" style="background:var(--danger)">رفض وحذف</button>
    </div>
  `;
  document.getElementById('saveProposalBtn').onclick = async ()=> {
    try{
      const updated = await buildProposalFromDetail(item);
      await updateProposalFile(readCfg(), filename, updated);
      alert('تم تعديل المقترح');
      loadAll();
    }catch(e){ alert('خطأ في حفظ المقترح: ' + e.message); console.error(e); }
  };
  document.getElementById('acceptProposalBtn').onclick = ()=> startAcceptFlow(item, filename);
  document.getElementById('deleteProposalBtn').onclick = async ()=> { if(!confirm('رفض المقترح وحذفه؟')) return; try{ await deleteProposalWithImage(readCfg(), filename); alert('تم الحذف'); loadAll(); }catch(e){ alert('خطأ: ' + e.message); } };
}

/* build proposal from detail and optionally upload new image (optimized) */
async function buildProposalFromDetail(originalItem){
  const cfg = readCfg(); const pat = cfg.pat; const repo = cfg.repo; const branch = cfg.branch || 'main';
  const updated = Object.assign({}, originalItem);
  updated.ref_code = document.getElementById('p_code').value.trim() || updated.ref_code || ('p' + Date.now().toString(36));
  updated.name = document.getElementById('p_name').value.trim();
  updated.description = document.getElementById('p_desc').value.trim();
  updated.location = document.getElementById('p_loc').value.trim();
  updated.contact = document.getElementById('p_contact').value.trim();
  updated.category = document.getElementById('p_cat').value.trim();
  updated.created_at = updated.created_at || new Date().toISOString();
  const file = document.getElementById('p_file').files[0];
  if(file){
    if(!pat || !repo) throw new Error('PAT و repo مطلوبان لتحميل الصورة');
    const imgName = `${updated.ref_code}-${file.name.replace(/[^a-z0-9.\-_]/ig,'_')}`;
    const opt = await optimizeImageFile(file, OPT_DEFAULTS);
    await ghPut(pat, repo, `static/images/${imgName}`, opt.base64, `upload ${imgName}`, branch, true);
    updated.image = `static/images/${imgName}`;
    updated.thumb = updated.image;
  }
  return updated;
}

async function updateProposalFile(cfg, filename, obj){
  const pat = cfg.pat; const repo = cfg.repo; const branch = cfg.branch || 'main';
  const base64 = btoa(unescape(encodeURIComponent(JSON.stringify(obj))));
  return await ghPut(pat, repo, `static/proposals/${filename}`, base64, `update proposal ${obj.ref_code||filename}`, branch, true);
}

/* delete proposal and its image (if any) */
async function deleteProposalWithImage(cfg, filename){
  // fetch proposal content via raw first (to know image)
  try{
    const proposalUrl = `https://raw.githubusercontent.com/${cfg.repo}/${cfg.branch||'main'}/static/proposals/${filename}`;
    const pRes = await fetch(proposalUrl);
    if(pRes.ok){
      const item = await pRes.json().catch(()=>null);
      if(item && item.image){ await maybeDeleteImage(cfg, item.image); }
    }
  }catch(e){ console.warn('could not prefetch proposal to delete image', e); }
  return await ghDelete(cfg.pat, cfg.repo, 'static/proposals/' + filename, 'reject proposal ' + filename, cfg.branch || 'main');
}

/* ---------- Accept flow ---------- */
let pendingAccept = null;
function startAcceptFlow(item, filename){ pendingAccept = { item, filename }; document.getElementById('finalCodeInput').value = item.ref_code || ''; document.getElementById('acceptModal').style.display = 'flex'; }
document.getElementById('cancelAcceptBtn').addEventListener('click', ()=> { document.getElementById('acceptModal').style.display = 'none'; pendingAccept = null; });
document.getElementById('confirmAcceptBtn').addEventListener('click', async ()=>{
  const final = document.getElementById('finalCodeInput').value.trim() || (pendingAccept.item.ref_code || ('ad' + Date.now().toString(36)));
  document.getElementById('acceptModal').style.display = 'none';
  try{
    if(document.getElementById('p_name')) pendingAccept.item = await buildProposalFromDetail(pendingAccept.item);
  }catch(e){ console.warn('could not build from detail', e); }
  try{
    await acceptProposalWithMapping(readCfg(), pendingAccept.filename, pendingAccept.item, final);
    alert('تم القبول والتضمين (الرمز النهائي: ' + final + ')');
  }catch(e){ alert('خطأ أثناء القبول: ' + e.message); console.error(e); }
  pendingAccept = null;
  loadAll();
});

/* accept implementation: add to ads.json, add mapping, delete proposal + maybe image handled already */
async function acceptProposalWithMapping(cfg, filename, item, final_code){
  const pat = cfg.pat; const repo = cfg.repo; const branch = cfg.branch || 'main';
  if(!pat) throw new Error('PAT مطلوب');
  const raw = await ghRaw(repo, 'static/ads.json', branch);
  const arr = raw ? JSON.parse(raw) : [];
  const ad = {
    code: final_code,
    name: item.name || '',
    description: item.description || '',
    location: item.location || '',
    contact: item.contact || '',
    category: item.category || '',
    image: item.image || '',
    thumb: item.thumb || item.image || '',
    created_at: new Date().toISOString()
  };
  arr.unshift(ad);
  await ghPut(pat, repo, 'static/ads.json', btoa(unescape(encodeURIComponent(JSON.stringify(arr)))), 'accept proposal ' + (item.ref_code || filename), branch, true);
  const rawMap = await ghRaw(repo, 'static/mappings.json', branch);
  const maps = rawMap ? JSON.parse(rawMap) : [];
  maps.unshift({ proposal_ref: item.ref_code || filename, final_code: final_code, accepted_at: new Date().toISOString() });
  await ghPut(pat, repo, 'static/mappings.json', btoa(unescape(encodeURIComponent(JSON.stringify(maps)))), 'add mapping ' + (item.ref_code || filename), branch, true);
  // Delete proposal JSON and its image if present
  try{
    // fetch to get image path
    const proposalUrl = `https://raw.githubusercontent.com/${repo}/${branch}/static/proposals/${filename}`;
    const pRes = await fetch(proposalUrl);
    if(pRes.ok){
      const itemJson = await pRes.json().catch(()=>null);
      if(itemJson && itemJson.image){ await maybeDeleteImage(cfg, itemJson.image); }
    }
  }catch(e){ console.warn('could not fetch proposal before delete', e); }
  await ghDelete(pat, repo, 'static/proposals/' + filename, 'accept proposal ' + filename, branch);
}

/* ---------- Add / Edit / Delete ads ---------- */
function openAdModal(mode, ad=null, idx=null){
  detailEl.innerHTML = `
    <div style="display:flex;flex-direction:column;gap:8px">
      <div class="detailRow"><label class="small">رمز</label><input id="a_code" value="${escapeAttr(ad?.code||'')}" style="flex:1"></div>
      <div class="detailRow"><label class="small">العنوان</label><input id="a_name" value="${escapeAttr(ad?.name||'')}" style="flex:1"></div>
      <div class="detailRow"><label class="small">الوصف</label><textarea id="a_desc" rows="4">${escapeAttr(ad?.description||'')}</textarea></div>
      <div class="detailRow"><label class="small">الموقع</label><input id="a_loc" value="${escapeAttr(ad?.location||'')}" style="flex:1"></div>
      <div class="detailRow"><label class="small">التواصل</label><input id="a_contact" value="${escapeAttr(ad?.contact||'')}" style="flex:1"></div>
      <div class="detailRow"><label class="small">التصنيف</label><input id="a_cat" value="${escapeAttr(ad?.category||'')}" style="flex:1"></div>
      <div class="detailRow"><label class="small">صورة</label><input id="a_file" type="file" accept="image/*"></div>
      <div style="display:flex;gap:8px;justify-content:flex-end">
        <button id="saveAdBtn">${mode === 'new' ? 'إضافة' : 'حفظ'}</button>
        <button id="cancelAdBtn" class="alt">إلغاء</button>
      </div>
    </div>`;
  document.getElementById('cancelAdBtn').onclick = ()=> { detailEl.innerHTML = 'حدد إعلاناً أو مقترحاً لعرض التفاصيل'; };
  document.getElementById('saveAdBtn').onclick = async ()=>{
    const cfg = readCfg(); const pat = cfg.pat; const repo = cfg.repo; const branch = cfg.branch || 'main';
    if(!pat || !repo) return alert('ضع repo وPAT ثم احفظ الإعدادات');
    try{
      const raw = await ghRaw(repo, 'static/ads.json', branch);
      const arr = raw ? JSON.parse(raw) : [];
      const file = document.getElementById('a_file').files[0];
      let imgPath = ad?.image || '';
      if(file){
        const imgName = (document.getElementById('a_code').value.trim() || ('img' + Date.now())) + '-' + file.name.replace(/[^a-z0-9.\-_]/ig,'_');
        const opt = await optimizeImageFile(file, OPT_DEFAULTS);
        await ghPut(pat, repo, `static/images/${imgName}`, opt.base64, `upload ${imgName}`, branch, true);
        imgPath = `static/images/${imgName}`;
        // if editing and old image exists, delete old image to save space
        if(mode !== 'new' && ad && ad.image && ad.image !== imgPath){ await maybeDeleteImage(cfg, ad.image); }
      }
      const obj = {
        code: document.getElementById('a_code').value.trim() || ('c' + Date.now().toString(36).slice(-6)),
        name: document.getElementById('a_name').value.trim(),
        description: document.getElementById('a_desc').value.trim(),
        location: document.getElementById('a_loc').value.trim(),
        contact: document.getElementById('a_contact').value.trim(),
        category: document.getElementById('a_cat').value.trim(),
        image: imgPath,
        thumb: imgPath,
        created_at: ad?.created_at || new Date().toISOString()
      };
      if(mode === 'new'){ arr.unshift(obj); } else { arr[idx] = obj; }
      await ghPut(pat, repo, 'static/ads.json', btoa(unescape(encodeURIComponent(JSON.stringify(arr)))), mode === 'new' ? 'add ad' : 'update ad', branch, true);
      alert('تم الحفظ');
      loadAll();
      detailEl.innerHTML = 'حدد إعلاناً أو مقترحاً لعرض التفاصيل';
    }catch(e){ alert('خطأ: ' + e.message); console.error(e); }
  };
}

async function deleteAd(idx){
  if(!confirm('حذف الإعلان؟')) return;
  const cfg = readCfg(); const pat = cfg.pat; const repo = cfg.repo; const branch = cfg.branch || 'main';
  if(!pat || !repo) return alert('ضع repo وPAT ثم احفظ الإعدادات');
  try{
    const raw = await ghRaw(repo, 'static/ads.json', branch);
    const arr = raw ? JSON.parse(raw) : [];
    const img = arr[idx]?.image || arr[idx]?.thumb || '';
    if(img) await maybeDeleteImage(cfg, img);
    arr.splice(idx,1);
    await ghPut(pat, repo, 'static/ads.json', btoa(unescape(encodeURIComponent(JSON.stringify(arr)))), 'delete ad', branch, true);
    alert('تم الحذف');
    loadAll();
  }catch(e){ alert('خطأ: ' + e.message); console.error(e); }
}

/* ---------- utilities ---------- */
function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
function escapeAttr(s){ return (s||'').replace(/"/g,'&quot;').replace(/</g,'&lt;'); }
function toBase64(file){ return new Promise((res,rej)=>{ const r=new FileReader(); r.onload = ()=>res(r.result); r.onerror = rej; r.readAsDataURL(file); }); }

/* ---------- init ---------- */
(async function init(){
  setUiFromCfg();
  const cfg = readCfg();
  if(cfg.repo && cfg.pat){
    try{
      const check = await ghApiGetWithPat(cfg.pat, cfg.repo, 'static/ads.json', cfg.branch || 'main');
      if(check.status === 401 || check.status === 403){ updateStatus('PAT غير صالح أو لم يُمنح الإذن'); return; }
      loadAll();
    }catch(e){ console.warn('init check failed', e); }
  }
})();

</script>
</body>
</html>
