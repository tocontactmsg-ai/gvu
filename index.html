<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Ø³ÙˆÙ‚ Ù…Ø¨ÙˆØ¨ â€” Ø¥Ø¹Ù„Ø§Ù†Ø§Øª</title>
<style>
  *{box-sizing:border-box;font-family:Tahoma, Arial, sans-serif}
  body{margin:0;background:#f3f6fb;color:#0b1320;padding:18px}
  .wrap{max-width:1100px;margin:0 auto}
  header{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap}
  .controls{display:flex;gap:8px;flex:1;min-width:220px;margin:12px 0}
  input{padding:10px;border-radius:8px;border:1px solid #e1e7ee;flex:1}
  .grid{display:grid;grid-template-columns:repeat(1,1fr);gap:12px}
  @media(min-width:640px){.grid{grid-template-columns:repeat(2,1fr)}}
  @media(min-width:980px){.grid{grid-template-columns:repeat(3,1fr)}}
  .card{background:#fff;border-radius:10px;padding:10px;box-shadow:0 6px 18px rgba(11,19,32,0.06);overflow:hidden}
  .media{height:160px;background:#efefef;display:flex;align-items:center;justify-content:center;border-radius:8px;overflow:hidden}
  .media img{width:100%;height:100%;object-fit:cover;display:block}
  .body{padding:10px}
  .title{font-weight:700;margin-bottom:6px}
  .desc{color:#334;line-height:1.3;margin-bottom:8px}
  .meta{font-size:13px;color:#666}
  .code{display:inline-block;background:#e9f6ff;color:#0078d7;padding:6px;border-radius:6px;margin-top:10px;direction:ltr}
  .small{font-size:13px;color:#666}
  .noitems{text-align:center;padding:20px;color:#666}
  img.lazy {opacity:0;transition:opacity .2s ease-in}
  img.lazy.loaded {opacity:1}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div>
      <h2 style="margin:0">Ø³ÙˆÙ‚ Ù…Ø¨ÙˆØ¨</h2>
      <div class="small">Ø¥Ø¹Ù„Ø§Ù†Ø§Øª â€” Ø«Ø§Ø¨ØªØ© (GitHub Pages)</div>
    </div>
    <nav>
      <a href="admin.html" style="color:#0078d7;text-decoration:none">Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© (ÙŠØ¯ÙˆÙŠ)</a>
    </nav>
  </header>

  <div class="controls">
    <input id="q" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø¹Ù†ÙˆØ§Ù†ØŒ Ø§Ù„ÙˆØµÙ Ø£Ùˆ Ø§Ù„Ø±Ù…Ø²" aria-label="search">
    <button id="refresh">ØªØ­Ø¯ÙŠØ«</button>
  </div>

  <div id="grid" class="grid" aria-live="polite"></div>
  <div id="noitems" class="noitems" style="display:none">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø¹Ù„Ø§Ù†Ø§Øª</div>
</div>

<script>
const ADS_URL = 'ads.json'; // keep in same folder
const grid = document.getElementById('grid');
const qEl = document.getElementById('q');
const noitems = document.getElementById('noitems');

function escapeHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

async function loadAds(q=''){
  try {
    const res = await fetch(ADS_URL, {cache:'no-cache'});
    if (!res.ok) throw new Error('Failed to load ads.json');
    let ads = await res.json();
    ads = ads.map(a => Object.assign({}, a, { created_at: new Date(a.created_at || Date.now()).toISOString() }));
    // newest first
    ads.sort((a,b) => new Date(b.created_at) - new Date(a.created_at));
    if (q) {
      const qq = q.toLowerCase();
      ads = ads.filter(a => (a.title||'').toLowerCase().includes(qq) || (a.desc||'').toLowerCase().includes(qq) || (a.loc||'').toLowerCase().includes(qq) || (a.code||'').toLowerCase().includes(qq));
    }
    render(ads);
  } catch (e) {
    grid.innerHTML = '<div class="noitems">Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª.</div>';
    console.error(e);
  }
}

function render(ads){
  grid.innerHTML = '';
  if (!ads || ads.length === 0) { noitems.style.display='block'; return; }
  noitems.style.display='none';
  ads.forEach(a => {
    const el = document.createElement('article');
    el.className = 'card';
    el.innerHTML = `
      <div class="media">${a.img ? `<img data-src="${escapeHtml(a.img)}" alt="${escapeHtml(a.title||'')}" class="lazy">` : 'Ù„Ø§ ØµÙˆØ±Ø©'}</div>
      <div class="body">
        <div class="title">${escapeHtml(a.title||a.code||'Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†')}</div>
        <div class="desc">${escapeHtml(a.desc||'')}</div>
        <div class="meta">ğŸ“ ${escapeHtml(a.loc||'')} â€¢ ${escapeHtml(a.contact||'')}</div>
        <div class="code">#${escapeHtml(a.code||'')}</div>
      </div>
    `;
    grid.appendChild(el);
  });
  lazyLoadImages();
}

function lazyLoadImages(){
  const lazyImgs = Array.from(document.querySelectorAll('img.lazy'));
  if ('IntersectionObserver' in window) {
    const io = new IntersectionObserver((entries, obs) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          const img = entry.target;
          img.src = img.dataset.src;
          img.onload = () => img.classList.add('loaded');
          obs.unobserve(img);
        }
      });
    }, { rootMargin: '200px' });
    lazyImgs.forEach(i => io.observe(i));
  } else {
    // fallback: load all
    lazyImgs.forEach(img => { img.src = img.dataset.src; img.onload = ()=>img.classList.add('loaded'); });
  }
}

// events
document.getElementById('refresh').addEventListener('click', ()=> loadAds(qEl.value.trim()));
qEl.addEventListener('input', debounce(()=> loadAds(qEl.value.trim()), 300));

function debounce(fn, t=300){ let timer; return (...a)=>{ clearTimeout(timer); timer=setTimeout(()=>fn(...a), t); }; }

// initial
loadAds();
</script>
</body>
</html>
