<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ø§Ù„Ø¯Ù„Ø§Ù„Ø© â€” Ø¥Ø¹Ù„Ø§Ù†Ø§Øª</title>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;700&display=swap" rel="stylesheet">
<style>
  *{box-sizing:border-box;font-family:"Tajawal",sans-serif}
  body{margin:0;background:#f3f6fb;color:#0b1320}
  .container{max-width:1100px;margin:16px auto;padding:12px}
  header{background:#0078d7;color:#fff;padding:12px;border-radius:10px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap}
  nav button{background:#fff;color:#0078d7;border:none;padding:8px 12px;border-radius:8px;cursor:pointer}
  .controls{display:flex;gap:10px;flex-wrap:wrap;margin:12px 0}
  input,select,textarea{padding:12px;border-radius:8px;border:1px solid #e6eef8;width:100%;font-size:16px}
  .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:14px}
  @media(min-width:900px){.grid{grid-template-columns:repeat(3,1fr)}}
  @media(max-width:640px){.grid{grid-template-columns:1fr}}
  .card{background:#fff;border-radius:12px;overflow:hidden;box-shadow:0 6px 18px rgba(11,19,32,0.06);display:flex;flex-direction:column;height:100%}
  .media{height:200px;background:#efefef;display:flex;align-items:center;justify-content:center;cursor:zoom-in}
  .media img{width:100%;height:100%;object-fit:cover}
  .body{padding:16px;display:flex;flex-direction:column;gap:8px}
  .title{font-weight:800;font-size:18px}
  .desc{color:#334155;font-size:15px}
  .meta{display:flex;gap:10px;align-items:center;margin-top:8px}
  .tag{background:#e9f6ff;color:#0078d7;padding:6px;border-radius:8px;direction:ltr;display:inline-block}
  .code{background:#e9f6ff;color:#0078d7;padding:6px;border-radius:8px;direction:ltr;display:inline-block;margin-top:8px}
  .wa-btn{background:#25D366;color:#fff;padding:10px;border-radius:10px;border:none;cursor:pointer;text-decoration:none}
  .panel{background:#fff;padding:14px;border-radius:10px}
  .small{font-size:13px;color:#666}
  .lightbox{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.85);z-index:999}
  .lightbox.open{display:flex}
  .lightbox img{max-width:96%;max-height:96%}
  pre{white-space:pre-wrap;background:#fafafa;padding:8px;border-radius:6px}
  .refBox{display:flex;gap:8px;align-items:center;margin-top:10px}
  .refCode{background:#f0f9ff;padding:8px 12px;border-radius:10px;color:#0078d7;font-weight:800}
  .mutedSmall{font-size:13px;color:#666}
</style>
</head>
<body>
<div class="container">
  <header>
    <div>
      <div style="font-size:22px;font-weight:900">Ø§Ù„Ø¯Ù„Ø§Ù„Ø©</div>
      <div class="small">Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ù…Ø¨Ø³Ø·Ø© (static)</div>
    </div>
    <nav>
      <button data-target="home" class="nav-btn" aria-current="true">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
      <button data-target="send" class="nav-btn">Ø£Ø±Ø³Ù„ Ø¥Ø¹Ù„Ø§Ù†Ùƒ</button>
      <button data-target="policy" class="nav-btn">Ø§Ù„Ø´Ø±ÙˆØ·</button>
    </nav>
  </header>

  <div class="controls">
    <input id="q" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø£Ùˆ Ø§Ù„Ø±Ù…Ø² Ø£Ùˆ Ø§Ù„Ù…ÙˆÙ‚Ø¹" style="flex:1">
    <select id="catFilter" style="width:220px"><option value="">ÙƒÙ„ Ø§Ù„ÙØ¦Ø§Øª</option></select>
    <button id="refresh" class="small">âŸ³ ØªØ­Ø¯ÙŠØ«</button>
  </div>

  <main>
    <section id="home" class="active">
      <div id="grid" class="grid" aria-live="polite"></div>
      <div id="noitems" style="display:none;text-align:center;margin-top:12px">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø¹Ù„Ø§Ù†Ø§Øª</div>
    </section>

    <section id="send" style="display:none">
      <div class="panel">
        <h3 style="margin:0 0 8px">Ø£Ø±Ø³Ù„ Ø¥Ø¹Ù„Ø§Ù†Ùƒ</h3>
        <div style="display:grid;gap:8px">
          <input id="f_name" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†">
          <textarea id="f_desc" placeholder="ÙˆØµÙ"></textarea>
          <input id="f_loc" placeholder="Ø§Ù„Ù…ÙˆÙ‚Ø¹">
          <input id="f_contact" placeholder="ÙˆØ³ÙŠÙ„Ø© Ø§Ù„ØªÙˆØ§ØµÙ„">
          <input id="f_cat" placeholder="Ø§Ù„ØªØµÙ†ÙŠÙ">
          <input id="f_file" type="file" accept="image/*" capture="environment">
          <div style="display:flex;gap:8px;align-items:center">
            <button id="submitBtn" class="wa-btn">Ø¥Ø±Ø³Ø§Ù„</button>
            <div id="submitStatus" class="small"></div>
          </div>

          <div id="afterSubmit" style="display:none;margin-top:8px">
            <div>Ø±Ù…Ø² Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ:</div>
            <div class="refBox">
              <div id="refCode" class="refCode"></div>
              <button id="copyRef" class="small">Ù†Ø³Ø®</button>
              <a id="openWa" class="small" target="_blank" style="margin-left:8px;color:#0078d7"></a>
            </div>
          </div>

          <div id="fallbackJson" style="display:none;margin-top:8px">
            <div class="small">Ø¥Ø°Ø§ Ù„Ù… ÙŠÙØ³Ù…Ø­ Ø¨Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØŒ Ø§Ù†Ø³Ø® Ù‡Ø°Ù‡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ£Ø±Ø³Ù„Ù‡Ø§ Ù„Ù„Ù…Ø¯ÙŠØ±:</div>
            <pre id="fallbackArea"></pre>
          </div>
        </div>
      </div>
    </section>

    <section id="policy" style="display:none">
      <div class="panel">
        <h3>Ø³ÙŠØ§Ø³Ø© Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…</h3>
        <p class="small">Ø£Ø¯Ø®Ù„ Ø¨ÙŠØ§Ù†Ø§Øª ØµØ­ÙŠØ­Ø©. Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ø±ÙÙˆØ¶ Ø£Ùˆ Ø§Ù„Ù…Ø®Ø§Ù„Ù Ø³ÙŠØªÙ… Ø­Ø°ÙÙ‡.</p>
      </div>
    </section>
  </main>
</div>

<div id="lightbox" class="lightbox" onclick="this.classList.remove('open')"><img id="lbImg" alt=""></div>

<script>
/* navigation (keeps your layout) */
const navBtns = document.querySelectorAll('.nav-btn');
const sections = { home: document.getElementById('home'), send: document.getElementById('send'), policy: document.getElementById('policy') };
navBtns.forEach(b=>b.addEventListener('click', ()=>{ for(const k in sections) sections[k].style.display='none'; sections[b.dataset.target].style.display='block'; navBtns.forEach(n=>n.removeAttribute('aria-current')); b.setAttribute('aria-current','true'); }));

/* load/render + improvements: bigger text, lightbox, faster */
let ads = [];
const grid = document.getElementById('grid');
const qEl = document.getElementById('q');
const catFilter = document.getElementById('catFilter');

async function loadAds(){
  try{
    // small cache to speed reloads (30s)
    const cacheKey = 'static_ads_cache_v2';
    const cached = JSON.parse(localStorage.getItem(cacheKey) || 'null');
    if(cached && Date.now() - cached.t < 30_000 && Array.isArray(cached.data)){
      ads = cached.data;
      renderGrid(ads);
      buildCategories();
      return;
    }

    const paths = ['./static/ads.json','./ads.json','/static/ads.json'];
    let items = null;
    for(const p of paths){
      try{
        const res = await fetch(p, {cache:'no-cache'});
        if(!res.ok) continue;
        items = await res.json();
        break;
      }catch(e){ continue; }
    }
    if(!items) throw new Error('ads.json not found');
    ads = Array.isArray(items) ? items : [];
    // sort newest first
    ads.sort((a,b)=> (new Date(b.created_at||0)) - (new Date(a.created_at||0)));
    localStorage.setItem(cacheKey, JSON.stringify({t: Date.now(), data: ads}));
    renderGrid(ads);
    buildCategories();
  }catch(e){
    grid.innerHTML = '<div style="padding:16px">ØªØ¹Ø°Ù‘Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª.</div>';
  }
}

function renderGrid(items){
  grid.innerHTML = '';
  if(!items || items.length===0){ document.getElementById('noitems').style.display='block'; return; }
  document.getElementById('noitems').style.display='none';
  items.forEach(a=>{
    const el = document.createElement('div'); el.className='card';
    // normalize image path (remove leading slash if present)
    const imgPath = (a.thumb || a.image || '').replace(/^\//, '');
    const mediaHtml = imgPath ? `<img src="${escapeHtml(imgPath)}" loading="lazy" alt="${escapeHtml(a.name||'')}">` : `<div class="placeholder">Ù„Ø§ ØµÙˆØ±Ø©</div>`;
    el.innerHTML = `<div class="media">${mediaHtml}</div>
      <div class="body"><div class="title">${escapeHtml(a.name||'')}</div>
      <div class="desc">${escapeHtml(a.description||'')}</div>
      <div class="meta"><div class="tag">${escapeHtml(a.category||'Ø¹Ø§Ù…')}</div><div class="small">ğŸ“ ${escapeHtml(a.location||'')}</div></div></div>`;
    grid.appendChild(el);

    const img = el.querySelector('img');
    if(img){
      img.addEventListener('click', ()=> { document.getElementById('lbImg').src = img.src; document.getElementById('lightbox').classList.add('open'); });
      // fallback if remote image 404: show placeholder text
      img.addEventListener('error', ()=> { img.style.display = 'none'; });
    }
  });
}

function buildCategories(){
  const s = new Set(); ads.forEach(a=> a.category && s.add(a.category));
  catFilter.innerHTML = '<option value="">ÙƒÙ„ Ø§Ù„ÙØ¦Ø§Øª</option>';
  Array.from(s).sort().forEach(c=> { const o = document.createElement('option'); o.value=c; o.innerText=c; catFilter.appendChild(o); });
}

function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
function debounce(fn,t){ let timer; return (...a)=>{ clearTimeout(timer); timer=setTimeout(()=>fn(...a),t); }; }
document.getElementById('refresh').addEventListener('click', ()=> { localStorage.removeItem('static_ads_cache_v2'); loadAds(); });
qEl.addEventListener('input', debounce(()=> filterList(), 250));
catFilter.addEventListener('change', ()=> filterList());

function filterList(){
  const q = qEl.value.trim().toLowerCase();
  const cat = catFilter.value;
  let filtered = ads.filter(a=> {
    if(cat && a.category !== cat) return false;
    if(!q) return true;
    return (a.name||'').toLowerCase().includes(q) || (a.code||'').toLowerCase().includes(q) || (a.location||'').toLowerCase().includes(q);
  });
  renderGrid(filtered);
}

/* ---------- Submission (proposal) + WhatsApp open fix ---------- */
const submitBtn = document.getElementById('submitBtn');
const submitStatus = document.getElementById('submitStatus');
const afterSubmit = document.getElementById('afterSubmit');
const refCodeEl = document.getElementById('refCode');
const fallbackArea = document.getElementById('fallbackArea');
const fallbackBox = document.getElementById('fallbackJson');
const openWa = document.getElementById('openWa');

function genRef(){ return 'R' + Date.now().toString(36).slice(-6).toUpperCase(); } // always generate immediately

submitBtn.addEventListener('click', async ()=>{
  submitBtn.disabled = true; submitStatus.textContent = 'Ø¬Ø§Ø±Ù Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯...';
  const data = {
    ref_code: genRef(),
    name: document.getElementById('f_name').value.trim(),
    description: document.getElementById('f_desc').value.trim(),
    location: document.getElementById('f_loc').value.trim(),
    contact: document.getElementById('f_contact').value.trim(),
    category: document.getElementById('f_cat').value.trim(),
    created_at: new Date().toISOString()
  };
  // set ref immediately in UI so user sees it
  refCodeEl.textContent = data.ref_code;
  afterSubmit.style.display = 'block';

  const file = document.getElementById('f_file').files[0];
  // read admin config (if admin enabled public submissions)
  let cfg = {};
  try { cfg = JSON.parse(localStorage.getItem('static_ads_cfg_v1')||'{}'); } catch(e){ cfg = {}; }
  const pat = cfg.pat || '';
  const repo = cfg.repo || '';
  const branch = cfg.branch || 'main';
  let uploadedOk = false;

  if(pat && repo && cfg.allow_public_submissions){
    submitStatus.textContent = 'Ø¥Ø±Ø³Ø§Ù„ Ø¥Ù„Ù‰ Ø§Ù„Ø±ÙŠØ¨Ùˆ...';
    try {
      if(file){
        const imgName = `${data.ref_code}-${file.name.replace(/[^a-z0-9.\-_]/ig,'_')}`;
        const dataUrl = await toBase64(file);
        const base64 = dataUrl.split(',')[1];
        // upload image path WITHOUT leading slash (so GitHub Pages raw URL resolves)
        await putFileToRepo(pat, repo, `static/images/${imgName}`, base64, `upload ${imgName}`, branch, true);
        data.image = `static/images/${imgName}`;
        data.thumb = data.image;
      }
      // create proposal file (no leading slash in path)
      const contentBase64 = btoa(unescape(encodeURIComponent(JSON.stringify(data))));
      await putFileToRepo(pat, repo, `static/proposals/${data.ref_code}.json`, contentBase64, `proposal ${data.ref_code}`, branch, true);
      uploadedOk = true;
      submitStatus.textContent = 'ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„';
      fallbackBox.style.display = 'none';
    } catch(err){
      console.error('upload failed', err);
      submitStatus.textContent = 'ÙØ´Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ';
      fallbackBox.style.display = 'block';
      fallbackArea.textContent = JSON.stringify(data, null, 2);
    }
  } else {
    submitStatus.textContent = 'Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ ØºÙŠØ± Ù…ÙØ¹Ù‘Ù„';
    fallbackBox.style.display = 'block';
    fallbackArea.textContent = JSON.stringify(data, null, 2);
  }

  // open WhatsApp (use wa.me and encode message). ADMIN PHONE: update here if needed
  try {
    const adminNumber = '249964147954'; // without +
    const message = `Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ ÙˆØµÙ„Ù†ÙŠ Ø¥Ø¹Ù„Ø§Ù† Ø¬Ø¯ÙŠØ¯ Ø¨Ø±Ù…Ø² Ø§Ù„ØªØªØ¨Ø¹: ${data.ref_code}\nØ§Ù„Ø¹Ù†ÙˆØ§Ù†: ${data.name || '-'}\nØ§Ù„Ù…ÙˆÙ‚Ø¹: ${data.location || '-'}`;
    const waUrl = `https://wa.me/${adminNumber}?text=${encodeURIComponent(message)}`;
    openWa.href = waUrl;
    openWa.textContent = 'ÙØªØ­ WhatsApp Ù„Ø¥Ø±Ø³Ø§Ù„ Ø±Ù…Ø² Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©';
    // open in new tab/window â€” user will confirm in WhatsApp
    window.open(waUrl, '_blank');
  } catch(e){
    console.warn('WhatsApp open failed', e);
  }

  submitBtn.disabled = false;
});

/* ---------- small helpers (file->dataURL and GitHub PUT) ---------- */
function toBase64(file){
  return new Promise((res,rej)=>{
    const r = new FileReader();
    r.onload = ()=> res(r.result);
    r.onerror = rej;
    r.readAsDataURL(file);
  });
}

async function putFileToRepo(pat, repo, path, base64content, message, branch='main', alreadyBase64=false){
  const [owner, repoName] = repo.split('/');
  if(!owner || !repoName) throw new Error('invalid repo name');
  const url = `https://api.github.com/repos/${owner}/${repoName}/contents/${encodeURIComponent(path)}`;
  const headers = { Authorization: 'token ' + pat, Accept: 'application/vnd.github.v3+json' };

  // get existing file to obtain sha if present
  const meta = await fetch(url + `?ref=${encodeURIComponent(branch)}`, { headers });
  let sha = null;
  if(meta.status === 200){
    const mjson = await meta.json();
    sha = mjson.sha;
  }

  const body = {
    message,
    content: alreadyBase64 ? base64content : btoa(unescape(encodeURIComponent(base64content))),
    branch
  };
  if(sha) body.sha = sha;
  const res = await fetch(url, { method:'PUT', headers, body: JSON.stringify(body) });
  if(!res.ok) {
    const txt = await res.text();
    throw new Error('GitHub API error: ' + res.status + ' ' + txt);
  }
  return await res.json();
}

/* ---------- init ---------- */
loadAds();
</script>
</body>
</html>
