<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>الدلالة</title>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;700&display=swap" rel="stylesheet">
<style>
  *{box-sizing:border-box;font-family:"Tajawal",sans-serif}
  body{margin:0;background:#f3f6fb;color:#0b1320}
  .container{max-width:1100px;margin:16px auto;padding:12px}
  header{background:#0078d7;color:#fff;padding:12px;border-radius:10px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap}
  nav button{background:#fff;color:#0078d7;border:none;padding:8px 12px;border-radius:8px;cursor:pointer}
  .controls{display:flex;gap:10px;flex-wrap:wrap;margin:12px 0}
  input,select,textarea{padding:10px;border-radius:8px;border:1px solid #e6eef8;width:100%}
  .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:14px}
  @media(min-width:900px){.grid{grid-template-columns:repeat(3,1fr)}}
  .card{background:#fff;border-radius:12px;overflow:hidden;box-shadow:0 6px 18px rgba(11,19,32,0.06)}
  .media{height:160px;background:#efefef;display:flex;align-items:center;justify-content:center}
  .media img{width:100%;height:100%;object-fit:cover}
  .body{padding:12px}
  .title{font-weight:700}
  .code{background:#e9f6ff;color:#0078d7;padding:6px;border-radius:8px;direction:ltr;display:inline-block;margin-top:8px}
  .wa-btn{background:#25D366;color:#fff;padding:10px;border-radius:10px;border:none;cursor:pointer;text-decoration:none}
  .panel{background:#fff;padding:12px;border-radius:10px}
  .small{font-size:13px;color:#666}
  .lightbox{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.75);z-index:999}
  .lightbox.open{display:flex}
  .lightbox img{max-width:90%;max-height:90%}
</style>
</head>
<body>
<div class="container">
  <header>
    <div>
      <div style="font-size:22px;font-weight:900">الدلالة</div>
      <div class="small"> </div>
    </div>
    <nav>
      <button data-target="home" class="nav-btn" aria-current="true">الرئيسية</button>
      <button data-target="send" class="nav-btn">أرسل إعلانك</button>
      <button data-target="policy" class="nav-btn">الشروط</button>
    </nav>
  </header>

  <div class="controls">
    <input id="q" placeholder="ابحث بالعنوان أو الرمز أو الموقع" style="flex:1">
    <select id="catFilter" style="width:220px"><option value="">كل الفئات</option></select>
    <button id="refresh" class="small">⟳ تحديث</button>
  </div>

  <main>
    <section id="home" class="active">
      <div id="grid" class="grid"></div>
      <div id="noitems" style="display:none;text-align:center;margin-top:12px">لا توجد إعلانات</div>
      <div style="text-align:center;margin-top:10px"><button id="loadMore" style="display:none;padding:10px 14px;border-radius:8px;background:#0078d7;color:#fff;border:none">تحميل المزيد</button></div>
    </section>

    <section id="send" style="display:none">
      <div class="panel">
        <h3>أرسل إعلانك</h3>
        <div style="display:grid;gap:8px">
          <input id="f_name" placeholder="عنوان الإعلان">
          <textarea id="f_desc" placeholder="وصف"></textarea>
          <input id="f_loc" placeholder="الموقع">
          <input id="f_contact" placeholder="وسيلة التواصل">
          <input id="f_cat" placeholder="التصنيف">
          <input id="f_file" type="file" accept="image/*" capture="environment">
          <div style="display:flex;gap:8px;align-items:center">
            <button id="submitBtn" class="wa-btn">إرسال</button>
            <div id="submitStatus" class="small"></div>
          </div>
          <div id="afterSubmit" style="display:none;margin-top:8px">
            <div>رمز الإرسال الخاص بك:</div>
            <div style="display:flex;gap:8px;align-items:center">
              <div id="refCode" class="code"></div>
              <button id="copyRef" class="small">نسخ</button>
              <a id="waRef" class="wa-btn" target="_blank">إرسال عبر واتساب</a>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section id="policy" style="display:none">
      <div class="panel">
        <h3>سياسة الاستخدام</h3>
        <p class="small">
باستخدامك لموقع الدلالة فأنت توافق على هذه الشروط. إذا لم توافق يرجى التوقف عن استخدام الموقع.
يقدّم الموقع خدمة عرض الإعلانات والمحتوى التسويقي وروابط الأطراف الثالثة دون تقديم أي ضمانات حول دقتها أو مصداقيتها أو جودة المنتجات أو الخدمات المعروضة. 
جميع التعاملات مع المعلنين تتم على مسؤوليتك الشخصية، والموقع ليس طرفًا فيها ولا يتحمل أي مسؤولية عن نتائجها.
يجب عليك استخدام الموقع بطريقة قانونية، وعدم نشر أو إرسال أي محتوى مخالف أو مضلل أو منتهك لحقوق الآخرين، وعدم محاولة اختراق أو تعطيل الموقع أو استخدامه لجمع بيانات بشكل غير مشروع , أي استخدام غير مناسب قد يؤدي إلى حظر الدخول دون إشعار.
جميع حقوق الملكية الفكرية المتعلقة بالموقع، بما في ذلك التصميم، الشعار، المحتوى، والأكواد، هي ملك للدلالة  يمنع نسخ أي جزء من الموقع أو استخدام علامته التجارية دون إذن مسبق.
قد يحتوي الموقع على روابط خارجية والموقع غير مسؤول عن محتواها أو سلامتها. 
قد يقوم الموقع بتعديل أو إزالة أي إعلان أو محتوى متى شاء دون الحاجة لذكر الأسباب.
قد يتم جمع بعض البيانات الأساسية لتحسين تجربة الاستخدام مثل ملفات الارتباط وسجلات الاستخدام، ويمكن مشاركة هذه البيانات فقط للامتثال للقانون أو لحماية الخدمة من الهجمات.
قد يتم تحديث هذه الشروط من وقت لآخر، ويعتبر استمرارك في استخدام الموقع موافقة على النسخة المحدثة.

للاتصال أو الإبلاغ عن مخالفة:
</p>
        <p>tocontactmsg@gmail.com </p>
      </div>
    </section>
  </main>
</div>

<div id="lightbox" class="lightbox" onclick="this.classList.remove('open')"><img id="lbImg"></div>

<!-- WA fallback modal -->
<div id="waModal" style="display:none;position:fixed;inset:0;align-items:center;justify-content:center;background:rgba(0,0,0,.6);z-index:2000">
  <div style="background:#fff;padding:18px;border-radius:10px;max-width:360px;margin:auto;text-align:center">
    <h4>فتح واتساب</h4>
    <p>اضغط الزر لفتح الواتساب يدوياً</p>
    <a id="waModalLink" class="wa-btn" target="_blank">فتح واتساب</a>
    <div style="margin-top:8px"><button id="waModalClose" class="small" style="background:#ccc;color:#000;border:none;padding:8px;border-radius:8px">إغلاق</button></div>
  </div>
</div>

<script>
// NAV
const navBtns = document.querySelectorAll('.nav-btn');
const sections = { home: document.getElementById('home'), send: document.getElementById('send'), policy: document.getElementById('policy') };
navBtns.forEach(b=>b.addEventListener('click', ()=>{
  for(const k in sections) sections[k].style.display='none';
  sections[b.dataset.target].style.display = 'block';
  navBtns.forEach(n=>n.removeAttribute('aria-current'));
  b.setAttribute('aria-current','true');
}));

// ADS
let ads = [], pageSize = 9, currentPage = 0;
const grid = document.getElementById('grid');
const loadMoreBtn = document.getElementById('loadMore');
const qEl = document.getElementById('q');
const catFilter = document.getElementById('catFilter');

async function loadAdsFromServer(q=''){
  const params = new URLSearchParams({ page: 0, size: 200 });
  if(q) params.set('q', q);
  if(catFilter.value) params.set('cat', catFilter.value);
  const r = await fetch('/api/ads?' + params.toString());
  if(!r.ok) throw new Error('failed');
  const j = await r.json();
  return j.items || [];
}

async function loadAds(q=''){
  try{
    const items = await loadAdsFromServer(q);
    ads = items;
    ads.sort((a,b)=> Date.parse(b.created_at) - Date.parse(a.created_at)); // newest first
    grid.innerHTML = '';
    currentPage = 0;
    renderPage();
    buildCategories();
  }catch(e){
    grid.innerHTML = '<div style="padding:16px">تعذّر التحميل.</div>';
  }
}
function renderPage(){
  const start = currentPage * pageSize;
  const slice = ads.slice(start, start + pageSize);
  slice.forEach(a=>{
    const el = document.createElement('div'); el.className='card';
    el.innerHTML = `
      <div class="media">${a.img? `<img src="${a.thumb||a.img}">` : 'لا صورة'}</div>
      <div class="body">
        <div class="title">${escapeHtml(a.name||'')}</div>
        <div class="code">${escapeHtml(a.code||'')}</div>
        <div class="small">${escapeHtml(a.desc||'')}</div>
        <div style="margin-top:8px" class="small">📍 ${escapeHtml(a.loc||'')}</div>
      </div>
    `;
    grid.appendChild(el);
    if(a.img){
      el.querySelector('img').addEventListener('click', ()=> {
        document.getElementById('lbImg').src = a.img || a.thumb || '';
        document.getElementById('lightbox').classList.add('open');
      });
    }
  });
  currentPage++;
  loadMoreBtn.style.display = currentPage * pageSize < ads.length ? 'inline-block' : 'none';
  document.getElementById('noitems').style.display = ads.length === 0 ? 'block' : 'none';
}

function escapeHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

loadMoreBtn.addEventListener('click', renderPage);
document.getElementById('refresh').addEventListener('click', ()=> loadAds(qEl.value.trim()));
qEl.addEventListener('input', debounce(()=> loadAds(qEl.value.trim()), 350));

function debounce(fn, t){ let timer; return (...a)=>{ clearTimeout(timer); timer=setTimeout(()=>fn(...a), t); }; }

// categories
function buildCategories(){
  const cats = new Set();
  ads.forEach(a=>{ if(a.cat) cats.add(a.cat); });
  catFilter.innerHTML = '<option value="">كل الفئات</option>';
  Array.from(cats).sort().forEach(c => {
    const o = document.createElement('option'); o.value=c; o.textContent=c; catFilter.appendChild(o);
  });
}
catFilter.addEventListener('change', ()=> loadAds(qEl.value.trim()));

// SUBMIT
const submitBtn = document.getElementById('submitBtn');
const afterSubmit = document.getElementById('afterSubmit');
const refCodeEl = document.getElementById('refCode');
const waModal = document.getElementById('waModal');
const waModalLink = document.getElementById('waModalLink');
const waModalClose = document.getElementById('waModalClose');
const adminWaLink = document.getElementById('adminWaLink');

waModalClose.addEventListener('click', ()=> waModal.style.display='none');

submitBtn.addEventListener('click', async ()=>{
  submitBtn.disabled = true; submitBtn.textContent = 'جارٍ الإرسال...';
  const fd = new FormData();
  fd.append('table','ads');
  fd.append('data', JSON.stringify({
    name: f_name.value, desc: f_desc.value,
    loc: f_loc.value, contact: f_contact.value, cat: f_cat.value
  }));
  fd.append('submitter', f_name.value || 'anonymous');
  if(f_file.files[0]) fd.append('file', f_file.files[0]);
  try{
    const res = await fetch('/api/append', { method: 'POST', body: fd });
    const j = await res.json();
    if(!res.ok){ alert('فشل: ' + (j.error||res.status)); submitBtn.disabled=false; submitBtn.textContent='إرسال'; return; }
    // show ref code exactly as server returned
    refCodeEl.textContent = j.ref_code || '(لا)';
    // build WA url referencing admin number & ref_code
    const adminNumber = (j.message && (j.message.match(/WhatsApp\s+([+\d-]+)/)||[])[1]) || adminWaLink.textContent || '+249964147954';
    const waUrl = 'https://wa.me/' + adminNumber.replace(/\D/g,'') + '?text=' + encodeURIComponent('رمز الإرسال: ' + j.ref_code);
    document.getElementById('waRef').href = waUrl;
    let ok = true;
    try { const w = window.open(waUrl, '_blank'); if(!w) ok=false; } catch(e){ ok=false; }
    if(!ok){ waModal.style.display='flex'; waModalLink.href = waUrl; }
    afterSubmit.style.display='block';
  }catch(e){
    alert('خطأ أثناء الإرسال');
  } finally {
    submitBtn.disabled=false; submitBtn.textContent='إرسال';
  }
});

// copy ref
document.getElementById('copyRef').addEventListener('click', async ()=> {
  try{ await navigator.clipboard.writeText(refCodeEl.textContent); alert('تم النسخ'); }catch(e){ alert('فشل النسخ'); }
});

// fetch config for WA number
(async function(){
  try{
    const r = await fetch('/api/config');
    if(r.ok){ const j = await r.json(); if(j.whatsapp){ adminWaLink.href = 'https://wa.me/' + j.whatsapp.replace(/\D/g,''); adminWaLink.textContent = j.whatsapp; } }
  }catch(e){}
})();

// init
loadAds();
</script>
</body>
</html>
