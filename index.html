<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>الدلالة — إعلانات</title>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;700;900&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#f7fbff; --card:#fff; --accent:#0078d7; --muted:#6b7280; --radius:12px;
    --maxW:1100px;
  }
  *{box-sizing:border-box;font-family:"Tajawal",system-ui,-apple-system,Segoe UI,Roboto,Noto Sans,Arial}
  body{margin:0;background:var(--bg);color:#052035;line-height:1.5}
  .wrap{max-width:var(--maxW);margin:20px auto;padding:16px}
  /* header */
  .topbar{display:flex;align-items:center;justify-content:space-between;background:linear-gradient(90deg,#0078d7,#005bb5);color:#fff;padding:14px;border-radius:14px;gap:12px;flex-wrap:wrap}
  .brand{display:flex;gap:10px;align-items:center}
  .brand .title{font-size:20px;font-weight:900}
  .brand .sub{font-size:13px;opacity:.95}
  .top-actions{display:flex;gap:8px;align-items:center}
  .top-actions .mutedSmall{font-size:13px;color:rgba(255,255,255,.95)}
  /* controls */
  .controls{display:flex;gap:12px;margin-top:14px;flex-wrap:wrap;align-items:center}
  .controls input[type="search"], .controls select{padding:12px;border-radius:10px;border:1px solid #e6f0fb;font-size:15px;background:#fff}
  .controls button{background:#fff;color:var(--accent);border:0;padding:10px 12px;border-radius:10px;cursor:pointer;font-weight:700}
  /* layout */
  main{margin-top:18px;display:grid;grid-template-columns:1fr 380px;gap:18px}
  @media(max-width:1100px){ main{grid-template-columns:1fr} }
  /* cards */
  .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:14px}
  @media(max-width:1000px){.grid{grid-template-columns:repeat(2,1fr)}}
  @media(max-width:640px){.grid{grid-template-columns:1fr}}
  .card{background:var(--card);border-radius:12px;overflow:hidden;box-shadow:0 8px 22px rgba(6,24,50,0.06);display:flex;flex-direction:column}
  .media{height:190px;background:#f2f8ff;display:flex;align-items:center;justify-content:center;overflow:hidden}
  .media img{width:100%;height:100%;object-fit:cover;display:block;cursor:zoom-in}
  .body{padding:14px;display:flex;flex-direction:column;gap:10px}
  .title{font-size:18px;font-weight:800;margin:0}
  .desc{font-size:15px;color:#123046}
  .meta{display:flex;gap:10px;align-items:center;margin-top:6px}
  .tag{background:#e9f6ff;color:var(--accent);padding:6px 10px;border-radius:10px;font-weight:800}
  .contact{margin-left:auto;color:var(--muted);font-size:13px}
  /* right panel */
  .panel{background:var(--card);padding:14px;border-radius:12px;box-shadow:0 8px 22px rgba(6,24,50,0.04)}
  .big{font-size:16px}
  .mutedSmall{font-size:13px;color:var(--muted)}
  button.primary{background:var(--accent);color:#fff;border:none;padding:10px 12px;border-radius:10px;cursor:pointer;font-weight:800}
  .codeBadge{background:#f0f9ff;color:var(--accent);padding:6px 10px;border-radius:10px;font-weight:900}
  .logList{margin-top:12px;background:#fff;padding:8px;border-radius:8px}
  /* lightbox */
  .lightbox{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.85);z-index:999}
  .lightbox.open{display:flex}
  .lightbox img{max-width:96%;max-height:96%}
  /* small helpers */
  .muted{color:var(--muted)}
  .field{margin-top:10px}
  .small{font-size:13px}
  .cameraBtn{background:#111;padding:8px 10px;border-radius:8px;color:#fff;border:none;cursor:pointer}
  .searchBar{display:flex;gap:8px;align-items:center;width:100%}
  .searchBar input{flex:1}
</style>
</head>
<body>
<div class="wrap">
  <div class="topbar">
    <div class="brand">
      <div class="title">الدلالة</div>
      <div class="sub">اعلن، تصفّح وتابع بسهولة — رمز التتبع يظهر لكل إعلان</div>
    </div>
    <div class="top-actions">
      <div class="mutedSmall">WhatsApp: <strong>+249964147954</strong></div>
    </div>
  </div>

  <div class="controls">
    <div class="searchBar">
      <input id="q" type="search" placeholder="ابحث: عنوان، رمز (ref)، موقع، تصنيف..." aria-label="Search">
      <select id="catFilter" style="width:200px"><option value="">كل الفئات</option></select>
      <button id="refresh">⟳</button>
    </div>
  </div>

  <main>
    <section>
      <div id="grid" class="grid" aria-live="polite"></div>
      <div id="noitems" style="display:none;padding:22px;text-align:center;color:var(--muted)">لا توجد إعلانات</div>
    </section>

    <aside>
      <div class="panel">
        <h3 class="big" style="margin:0">أرسل إعلانك</h3>
        <div class="mutedSmall">بعد الإرسال ستتلقّى رمز تتبع يمكنك استخدامه لاحقاً للبحث.</div>

        <div class="field">
          <input id="f_name" placeholder="عنوان الإعلان" aria-label="Title">
        </div>
        <div class="field">
          <textarea id="f_desc" placeholder="وصف الإعلان" rows="4"></textarea>
        </div>
        <div class="field" style="display:flex;gap:8px">
          <input id="f_loc" placeholder="الموقع" style="flex:1">
          <input id="f_contact" placeholder="وسيلة التواصل" style="width:160px">
        </div>
        <div class="field">
          <input id="f_cat" placeholder="التصنيف">
        </div>
        <div class="field" style="display:flex;gap:8px;align-items:center">
          <input id="f_file" type="file" accept="image/*">
          <button id="useCameraBtn" class="cameraBtn" type="button">استخدم الكاميرا</button>
        </div>

        <div class="field" style="display:flex;gap:8px;align-items:center">
          <button id="submitBtn" class="primary">إرسال</button>
          <div id="submitStatus" class="mutedSmall"></div>
        </div>

        <div id="afterSubmit" style="display:none;margin-top:12px">
          <div class="small">رمز الإرسال</div>
          <div style="display:flex;gap:8px;align-items:center;margin-top:6px">
            <div id="refCode" class="codeBadge"></div>
            <button id="copyRef" style="background:#eee;border-radius:8px;padding:6px 8px;border:0">نسخ</button>
            <a id="openWa" target="_blank" class="small" style="color:var(--accent)"></a>
          </div>
        </div>

        <div id="fallbackJson" style="display:none;margin-top:12px">
          <div class="small">إذا فشل الإرسال التلقائي انسخ هذه البيانات وابعثها للمشرف:</div>
          <pre id="fallbackArea"></pre>
        </div>

        <div class="logList" id="logList" style="margin-top:12px">
          <strong>آخر الإرساليات</strong>
          <div id="logRows" class="small muted"></div>
        </div>
      </div>

      <div class="panel" style="margin-top:12px">
        <h4 style="margin:0 0 8px">ابحث بالرمز (ref)</h4>
        <input id="refSearch" placeholder="ادخل رمز الإعلان للعثور عليه سريعاً">
        <div id="refResult" style="margin-top:10px" class="mutedSmall"></div>
      </div>
    </aside>
  </main>
</div>

<div id="lightbox" class="lightbox" onclick="this.classList.remove('open')"><img id="lbImg" alt=""></div>

<script>
/* =========================
   INDEX – enhanced + prettier
   - universal ref_code searchable
   - thumbnails used for listing (static/images/thumbs/...)
   - full optimized image used for lightbox (static/images/...)
   - client-side optimizer creates both thumb + full base64 for upload
   - camera-on-demand (no auto capture)
   ========================= */

const WA_NUMBER = '249964147954';
const CACHE_KEY = 'static_ads_cache_v4';
const CFG_KEY = 'static_ads_cfg_v1';
const LOG_KEY = 'static_ads_sent_refs';
const OPT = { maxWidth: 1600, maxHeight: 1200, quality: 0.78, outputType: 'image/webp' };
const THUMB = { maxWidth: 600, maxHeight: 400, quality: 0.70, outputType: 'image/webp' };

/* Utility */
function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
function debounce(fn,t=300){ let tmr; return (...a)=>{ clearTimeout(tmr); tmr=setTimeout(()=>fn(...a),t); }; }
function genRef(){ return 'R' + Date.now().toString(36).slice(-6).toUpperCase(); }

/* Local log */
function pushLocalLog(e){ try{ const cur = JSON.parse(localStorage.getItem(LOG_KEY)||'[]'); cur.unshift(e); localStorage.setItem(LOG_KEY, JSON.stringify(cur.slice(0,50))); }catch(e){} }
function renderLocalLog(){ const rows = JSON.parse(localStorage.getItem(LOG_KEY)||'[]').slice(0,10); const el = document.getElementById('logRows'); el.innerHTML=''; if(rows.length===0){ el.innerHTML='<div class="mutedSmall">لا توجد إرساليات محلية</div>'; return } rows.forEach(r=>{ const div=document.createElement('div'); div.style.display='flex'; div.style.justifyContent='space-between'; div.style.padding='6px 0'; div.innerHTML=`<div><strong>${escapeHtml(r.ref)}</strong> — ${escapeHtml(r.name||'')}</div><div class="mutedSmall">${new Date(r.ts).toLocaleString()}</div>`; el.appendChild(div); }); }
renderLocalLog();

/* Image optimizer: returns { base64 } without data: prefix */
async function optimizeImageFile(file, conf){
  const { maxWidth, maxHeight, quality, outputType } = conf;
  const dataUrl = await new Promise((res,rej)=>{ const f = new FileReader(); f.onload=()=>res(f.result); f.onerror=rej; f.readAsDataURL(file); });
  const img = await new Promise((res,rej)=>{ const i=new Image(); i.onload=()=>res(i); i.onerror=rej; i.src=dataUrl; });
  let w = img.width, h = img.height;
  const scale = Math.min(1, maxWidth / w, maxHeight / h);
  const tw = Math.round(w * scale), th = Math.round(h * scale);
  const canvas = document.createElement('canvas'); canvas.width = tw; canvas.height = th;
  const ctx = canvas.getContext('2d'); ctx.imageSmoothingEnabled = true; ctx.imageSmoothingQuality='high';
  ctx.drawImage(img,0,0,tw,th);
  const blob = await new Promise(res=>canvas.toBlob(res, outputType, quality));
  const base64 = await new Promise(res=>{ const fr=new FileReader(); fr.onload=()=>res(fr.result.split(',')[1]); fr.readAsDataURL(blob); });
  return { blob, base64, size: blob.size };
}

/* GitHub PUT helper */
async function putFileToRepo(pat, repo, path, base64content, message, branch='main'){
  const [owner, name] = repo.split('/');
  if(!owner || !name) throw new Error('invalid repo');
  const url = `https://api.github.com/repos/${owner}/${name}/contents/${encodeURIComponent(path)}`;
  const headers = { Authorization: 'token ' + pat, Accept: 'application/vnd.github.v3+json' };
  // get sha if exists
  const meta = await fetch(url + `?ref=${encodeURIComponent(branch)}`, { headers });
  let sha = null; if(meta.status===200){ const m = await meta.json(); sha = m.sha; }
  const body = { message, content: base64content, branch }; if(sha) body.sha = sha;
  const res = await fetch(url, { method:'PUT', headers, body: JSON.stringify(body) });
  if(!res.ok){ const t = await res.text(); throw new Error('GitHub upload error: ' + res.status + ' ' + t); }
  return await res.json();
}

/* Load ads.json (cache) */
let ADS = [];
async function loadAds(){
  try{
    const cached = JSON.parse(localStorage.getItem(CACHE_KEY) || 'null');
    if(cached && (Date.now() - cached.t < 30_000) && cached.data){ ADS = cached.data; renderGrid(ADS); buildCategories(ADS); return; }
    const candidates = ['./static/ads.json','./ads.json','/static/ads.json'];
    let j = null;
    for(const p of candidates){
      try{ const r = await fetch(p, { cache:'no-cache' }); if(!r.ok) continue; j = await r.json(); break; }catch(e){ continue; }
    }
    if(!j) { document.getElementById('grid').innerHTML='<div style="padding:18px;color:var(--muted)">تعذّر تحميل الإعلانات</div>'; return; }
    ADS = Array.isArray(j) ? j : [];
    ADS.sort((a,b)=> (new Date(b.created_at||0)) - (new Date(a.created_at||0)));
    localStorage.setItem(CACHE_KEY, JSON.stringify({ t: Date.now(), data: ADS }));
    renderGrid(ADS); buildCategories(ADS);
  }catch(e){
    console.error(e);
    document.getElementById('grid').innerHTML='<div style="padding:18px;color:var(--muted)">خطأ في تحميل الإعلانات</div>';
  }
}

function renderGrid(items){
  const grid = document.getElementById('grid'); grid.innerHTML='';
  if(!items || items.length===0){ document.getElementById('noitems').style.display='block'; return; } else document.getElementById('noitems').style.display='none';
  const frag = document.createDocumentFragment();
  items.forEach(a=>{
    const card = document.createElement('article'); card.className='card';
    const media = document.createElement('div'); media.className='media';
    const thumbPath = (a.thumb || a.image || '').replace(/^\//,'');
    if(thumbPath){
      const img = document.createElement('img'); img.src = thumbPath; img.loading='lazy'; img.alt = a.name || '';
      img.onerror = ()=> { img.style.display='none'; media.innerHTML = `<div class="mutedSmall">${escapeHtml(a.name||'لا صورة')}</div>`; };
      img.addEventListener('click', ()=> { const full = (a.image || a.thumb || '').replace(/^\//,''); if(full) { document.getElementById('lbImg').src = full; document.getElementById('lightbox').classList.add('open'); }});
      media.appendChild(img);
    } else {
      media.innerHTML = `<div class="mutedSmall">${escapeHtml(a.name||'لا صورة')}</div>`;
    }
    const body = document.createElement('div'); body.className='body';
    body.innerHTML = `<h3 class="title">${escapeHtml(a.name||'بدون عنوان')}</h3><div class="desc">${escapeHtml(a.description||'')}</div>`;
    const meta = document.createElement('div'); meta.className='meta';
    const tag = document.createElement('div'); tag.className='tag'; tag.innerText=a.category||'عام';
    const contact = document.createElement('div'); contact.className='contact'; contact.innerText=a.contact||'';
    const refBadge = document.createElement('div'); refBadge.className='codeBadge'; refBadge.style.marginLeft='8px'; refBadge.innerText = a.ref_code || a.code || '';
    meta.appendChild(tag); meta.appendChild(refBadge); meta.appendChild(contact); body.appendChild(meta);
    card.appendChild(media); card.appendChild(body); frag.appendChild(card);
  });
  grid.appendChild(frag);
}

function buildCategories(items){
  const s = new Set(); (items||ADS).forEach(a=> a.category && s.add(a.category));
  const sel = document.getElementById('catFilter'); sel.innerHTML = '<option value="">كل الفئات</option>';
  Array.from(s).sort().forEach(c=> { const o=document.createElement('option'); o.value=c; o.innerText=c; sel.appendChild(o); });
}

/* Filters */
document.getElementById('q').addEventListener('input', debounce(()=>{ const q=document.getElementById('q').value.trim().toLowerCase(); const cat=document.getElementById('catFilter').value; const filtered = ADS.filter(a=>{ if(cat && a.category!==cat) return false; if(!q) return true; return (a.name||'').toLowerCase().includes(q) || (a.ref_code||a.code||'').toLowerCase().includes(q) || (a.location||'').toLowerCase().includes(q) || (a.category||'').toLowerCase().includes(q); }); renderGrid(filtered); }, 250));
document.getElementById('catFilter').addEventListener('change', ()=>{ document.getElementById('q').dispatchEvent(new Event('input')); });
document.getElementById('refresh').addEventListener('click', ()=>{ localStorage.removeItem(CACHE_KEY); loadAds(); });

/* ---------------- Submission flow ---------------- */
const submitBtn = document.getElementById('submitBtn');
const submitStatus = document.getElementById('submitStatus');
const afterSubmit = document.getElementById('afterSubmit');
const refCodeEl = document.getElementById('refCode');
const fallbackArea = document.getElementById('fallbackArea');
const fallbackBox = document.getElementById('fallbackJson');
const openWa = document.getElementById('openWa');
const copyRef = document.getElementById('copyRef');

copyRef.addEventListener('click', ()=>{ const txt = refCodeEl.textContent||''; navigator.clipboard?.writeText(txt).then(()=>alert('تم النسخ')).catch(()=>alert('نسخ فشل')); });

async function putProposal(repoCfg, payload, file){
  // repoCfg: { repo, branch, pat }
  // payload: object (has ref_code)
  // file: optional File
  if(!repoCfg || !repoCfg.pat || !repoCfg.repo) throw new Error('repo cfg missing');
  const branch = repoCfg.branch || 'main';
  // optimize full and thumb (if file)
  if(file){
    const safe = file.name.replace(/[^a-z0-9.\-_]/ig,'_');
    const fullName = `${payload.ref_code}-${safe}`;
    const thumbName = `${payload.ref_code}-thumb-${safe}`;
    // full
    const optFull = await optimizeImageFile(file, OPT);
    await putFileToRepo(repoCfg.pat, repoCfg.repo, `static/images/${fullName}`, optFull.base64, `upload ${fullName}`, branch);
    // thumb
    const optThumb = await optimizeImageFile(file, THUMB);
    await putFileToRepo(repoCfg.pat, repoCfg.repo, `static/images/thumbs/${thumbName}`, optThumb.base64, `upload ${thumbName}`, branch);
    payload.image = `static/images/${fullName}`;
    payload.thumb = `static/images/thumbs/${thumbName}`;
  }
  // write proposal
  const base64 = btoa(unescape(encodeURIComponent(JSON.stringify(payload))));
  await putFileToRepo(repoCfg.pat, repoCfg.repo, `static/proposals/${payload.ref_code}.json`, base64, `proposal ${payload.ref_code}`, branch);
}

submitBtn.addEventListener('click', async ()=>{
  submitBtn.disabled = true; submitStatus.textContent = 'جارٍ الإعداد...';
  const ref = genRef();
  const payload = {
    ref_code: ref,
    name: document.getElementById('f_name').value.trim(),
    description: document.getElementById('f_desc').value.trim(),
    location: document.getElementById('f_loc').value.trim(),
    contact: document.getElementById('f_contact').value.trim(),
    category: document.getElementById('f_cat').value.trim(),
    created_at: new Date().toISOString()
  };
  refCodeEl.textContent = payload.ref_code; afterSubmit.style.display = 'block';
  // repo config read from localStorage (set by admin)
  let cfg = {}; try{ cfg = JSON.parse(localStorage.getItem(CFG_KEY)||'{}'); }catch(e){ cfg={}; }
  const file = document.getElementById('f_file').files[0];
  let uploaded = false;
  if(cfg && cfg.pat && cfg.repo && cfg.allow_public_submissions){
    submitStatus.textContent = 'إرسال إلى الريبو...';
    try{
      await putProposal(cfg, payload, file);
      uploaded = true; submitStatus.textContent = 'تمّ الإرسال';
    }catch(err){
      console.error(err);
      submitStatus.textContent = 'فشل الإرسال التلقائي';
      fallbackBox.style.display = 'block'; fallbackArea.textContent = JSON.stringify(payload, null, 2);
    }
  } else {
    submitStatus.textContent = 'الإرسال التلقائي غير مفعّل';
    fallbackBox.style.display = 'block'; fallbackArea.textContent = JSON.stringify(payload, null, 2);
  }

  // open WhatsApp
  try{
    const txt = `مرحباً، وصلني إعلان جديد برمز: ${payload.ref_code}\nالعنوان: ${payload.name||'-'}\nالموقع: ${payload.location||'-'}`;
    const waUrl = `https://wa.me/${WA_NUMBER}?text=${encodeURIComponent(txt)}`;
    openWa.href = waUrl; openWa.textContent = 'فتح WhatsApp لإرسال رمز المتابعة';
    window.open(waUrl, '_blank');
  }catch(e){ console.warn('wa failed', e); }

  pushLocalLog({ ref: payload.ref_code, ts: new Date().toISOString(), uploadedOk: uploaded, name: payload.name||'' });
  renderLocalLog();
  submitBtn.disabled = false;
});

/* Camera on-demand (explicit) */
document.getElementById('useCameraBtn').addEventListener('click', async ()=>{
  try{
    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
    const v = document.createElement('video'); v.autoplay=true; v.playsInline=true; v.srcObject = stream;
    const modal = document.createElement('div'); modal.style.cssText='position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.8);z-index:999';
    const box = document.createElement('div'); box.style.cssText='background:#fff;padding:8px;border-radius:8px;display:flex;flex-direction:column;gap:8px;align-items:center';
    const btn = document.createElement('button'); btn.textContent='التقاط الصورة'; btn.style.cssText='padding:8px 10px;border-radius:8px;background:#0078d7;color:#fff;border:none;cursor:pointer';
    box.appendChild(v); box.appendChild(btn); modal.appendChild(box); document.body.appendChild(modal);
    v.style.maxWidth='360px'; await v.play();
    btn.onclick = async ()=>{
      const canvas = document.createElement('canvas'); canvas.width = v.videoWidth; canvas.height = v.videoHeight;
      const ctx = canvas.getContext('2d'); ctx.drawImage(v,0,0,canvas.width,canvas.height);
      canvas.toBlob((blob)=>{
        const file = new File([blob], 'capture_' + Date.now() + '.jpg', { type: 'image/jpeg' });
        const dt = new DataTransfer(); dt.items.add(file); document.getElementById('f_file').files = dt.files;
        stream.getTracks().forEach(t=>t.stop()); document.body.removeChild(modal);
      }, 'image/jpeg', 0.9);
    };
  }catch(e){ alert('لا يمكن الوصول إلى الكاميرا: ' + (e.message||e)); }
});

/* ref search */
document.getElementById('refSearch')?.addEventListener('input', debounce(()=>{
  const term = (document.getElementById('refSearch').value||'').trim().toLowerCase();
  if(!term){ document.getElementById('refResult').innerText = ''; return; }
  const found = ADS.find(a => (a.ref_code||a.code||'').toLowerCase() === term);
  if(found){ document.getElementById('refResult').innerHTML = `<strong>${escapeHtml(found.name||'')}</strong><div class="small muted">رمز: ${escapeHtml(found.ref_code||found.code||'')}</div>`; } else { document.getElementById('refResult').innerText = 'لم أعثر على إعلان بهذا الرمز'; }
}, 300));

/* init */
loadAds();
</script>
</body>
</html>
