name: Optimize images (resilient + PR)

on:
  push:
    paths:
      - 'static/images/originals/**'
      - 'scripts/optimize_images.js'
      - 'package.json'
  workflow_dispatch:

env:
  # Base branch to create PR against (usually main or master). Change if needed.
  BASE_BRANCH: main

jobs:
  optimize:
    runs-on: ubuntu-latest
    concurrency:
      group: optimize-images
      cancel-in-progress: false

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Diagnostic â€” repo top files
        run: |
          echo "Running on: $(uname -a)"
          echo "Working dir: $(pwd)"
          echo "Git HEAD:"
          git rev-parse --abbrev-ref HEAD || true
          echo "--- ls repo root ---"
          ls -la || true

      - name: Show Node & NPM info
        uses: actions/setup-node@v4
        with:
          node-version: 18
      - name: Print node & npm
        run: |
          node -v
          npm -v
          npm config get registry || true

      - name: Ensure system build deps (helps node-gyp / native modules)
        run: |
          sudo apt-get update -y
          sudo apt-get install -y build-essential python3 curl || true

      - name: Cache npm & node_modules
        uses: actions/cache@v4
        with:
          path: |
            ~/.npm
            node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Print package.json (diagnostic)
        run: |
          echo "---- package.json (start) ----"
          sed -n '1,240p' package.json || true
          echo "---- package.json (end) ----"

                - name: Install dependencies (verbose + fallback)
        id: install
        run: |
          set -o pipefail
          echo "NODE: $(node -v)  NPM: $(npm -v)"
          echo "--- package.json (top 200 lines) ---"
          sed -n '1,200p' package.json || true
          echo "--- try npm ci ---"
          npm ci --no-audit --no-fund || {
            echo "[WARN] npm ci failed with exit $?. Saving npm-debug.log (if any) and trying fallback."
            # capture npm debug log if present
            if [ -f npm-debug.log ]; then
              echo "=== npm-debug.log (first 200 lines) ==="
              sed -n '1,200p' npm-debug.log || true
            fi
            # try fallback with install + unsafe-perm + no-optional
            echo "--- try npm install --unsafe-perm --no-optional ---"
            npm install --unsafe-perm --no-optional --no-audit --no-fund || {
              echo "[ERROR] fallback npm install also failed. Printing any npm logs..."
              if [ -f npm-debug.log ]; then
                echo "=== npm-debug.log (full) ==="
                sed -n '1,400p' npm-debug.log || true
              fi
              # Print node-gyp / python availability diagnostic
              echo "node-gyp and python diagnostics:"
              node -p "process.versions" || true
              python3 --version || true
              gcc --version || true
              # exit non-zero so the action step shows failure
              exit 2
            }
          }
          echo "[OK] dependencies installed"

          echo "[OK] dependencies installed"


      - name: Show originals dir content (diagnostic)
        run: |
          echo "Listing static/images and originals:"
          ls -la static/images || true
          ls -la static/images/originals || true

      - name: Optimize images (run script)
        id: optimize
        run: |
          set -o pipefail
          echo "[opt] Running optimizer"
          node scripts/optimize_images.js 2>&1 | sed -u 's/^/[opt] /'

      - name: Show generated files
        run: |
          echo "static/images content:"
          ls -la static/images || true
          echo "ads.json info:"
          wc -c static/ads.json || true
          sed -n '1,120p' static/ads.json || true

      - name: Create branch with optimized files
        id: create_branch
        run: |
          TS=$(date -u +%Y%m%d%H%M%S)
          BR="optimize-images/${TS}"
          echo "BRANCH=${BR}" >> $GITHUB_ENV
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git checkout -b "${BR}"
          # add only the generated images and ads.json
          git add -f static/images || true
          git add -f static/ads.json || true
          if git diff --staged --quiet; then
            echo "No changes to commit. Exiting early."
            echo "no_changes=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          git commit -m "chore: optimize images and regenerate ads.json [ci skip]" || true
          # push branch
          git push --set-upstream origin "${BR}"

      - name: Create Pull Request (if commits were made)
        if: steps.create_branch.outputs.no_changes != 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: optimize images and regenerate ads.json"
          branch: ${{ env.BRANCH }}
          base: ${{ env.BASE_BRANCH }}
          title: "chore: optimize images and regenerate ads.json"
          body: |
            This PR was created automatically by the Optimize images workflow.
            It contains optimized webp images and an updated static/ads.json.
            Review and merge when ready.
          labels: automated, optimize-images
          draft: false

      - name: Final status
        run: |
          if [ "${{ steps.create_branch.outputs.no_changes }}" = "true" ]; then
            echo "No generated changes -> nothing to PR."
          else
            echo "PR created (or branch pushed). Check Pull Requests for review."
          fi
